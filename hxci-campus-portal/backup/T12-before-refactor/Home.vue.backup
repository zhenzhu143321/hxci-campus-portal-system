<template>
  <div class="portal-container">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="portal-header">
      <div class="header-content">
        <div class="header-left">
          <div class="school-brand">
            <el-icon class="brand-icon" :size="28"><School /></el-icon>
            <div class="brand-info">
              <h1 class="brand-title">å“ˆå°”æ»¨ä¿¡æ¯å·¥ç¨‹å­¦é™¢</h1>
              <span class="brand-subtitle">æ™ºæ…§æ ¡å›­é—¨æˆ·</span>
            </div>
          </div>
        </div>
        
        <div class="header-right">
          <div class="user-panel" v-if="currentUserInfo">
            <el-avatar 
              class="user-avatar" 
              :size="40"
              :icon="Avatar"
              :alt="currentUserInfo.username"
            />
            <div class="user-details">
              <div class="user-name">{{ currentUserInfo?.username }}</div>
              <div class="user-role">{{ currentUserInfo?.roleName }}</div>
            </div>
            <el-button type="danger" size="small" @click="handleLogout">
              <el-icon><SwitchButton /></el-icon>
              é€€å‡º
            </el-button>
          </div>
        </div>
      </div>
    </div>

    <!-- ä¸ªæ€§åŒ–é—®å€™ -->
    <div class="welcome-banner">
      <div class="welcome-content">
        <h2 class="greeting">{{ getGreeting() }}ï¼Œ{{ currentUserInfo?.username }}ï¼</h2>
        <p class="date-info">{{ getCurrentDate() }}</p>
      </div>
      <div class="weather-info">
        <div class="weather-content">
          <div class="weather-main" v-if="!weatherLoading && weatherData">
            <div class="weather-icon">
              <el-icon :size="24" :style="{ color: getWeatherIconColor(weatherData.weatherText) }">
                <component :is="getWeatherIcon(weatherData.weatherText)" />
              </el-icon>
            </div>
            <div class="weather-details">
              <div class="weather-primary">
                <span class="location">{{ weatherData.cityName }}</span>
                <span class="temperature">{{ weatherData.temperature }}Â°C</span>
                <span class="weather-text">{{ weatherData.weatherText }}</span>
              </div>
              <div class="weather-secondary" v-if="hasSecondaryWeatherInfo(weatherData)">
                <span v-if="weatherData.feelsLike && weatherData.feelsLike !== weatherData.temperature" class="feels-like">
                  ä½“æ„Ÿ{{ weatherData.feelsLike }}Â°C
                </span>
                <span v-if="weatherData.humidity" class="humidity">æ¹¿åº¦{{ weatherData.humidity }}%</span>
                <span v-if="weatherData.windDir && weatherData.windScale" class="wind">
                  {{ weatherData.windDir }}{{ weatherData.windScale }}
                </span>
                <span v-if="weatherData.precipitation && weatherData.precipitation > 0" class="precipitation">
                  é™æ°´{{ weatherData.precipitation }}mm
                </span>
              </div>
            </div>
          </div>
          <div class="weather-loading" v-else-if="weatherLoading">
            <el-icon class="loading-icon"><Loading /></el-icon>
            <span>åŠ è½½å¤©æ°”ä¸­...</span>
          </div>
          <div class="weather-default" v-else>
            <el-icon :size="20"><Sunny /></el-icon>
            <span>{{ weatherDisplay }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ä¸‰åŒºå¸ƒå±€ä¸»ä½“ -->
    <div class="portal-main">
      <!-- å·¦ä¾§ï¼šå¿«æ·æœåŠ¡åŒº -->
      <div class="quick-services">
        <div class="section-header">
          <h3><el-icon><Setting /></el-icon>å¿«æ·æœåŠ¡</h3>
        </div>
        <div class="service-grid">
          <div 
            v-for="service in quickServices" 
            :key="service.id" 
            class="service-item"
            :class="{ disabled: !service.available }"
            @click="handleServiceClick(service)"
          >
            <div class="service-icon" :style="{ color: service.color }">
              <el-icon :size="24">
                <Bell />
              </el-icon>
            </div>
            <div class="service-info">
              <div class="service-name">{{ service.name }}</div>
              <div class="service-desc">{{ service.desc }}</div>
            </div>
            <div class="service-arrow">
              <el-icon><Bell /></el-icon>
            </div>
          </div>
        </div>
      </div>

      <!-- ä¸­é—´ï¼šæ™ºèƒ½é€šçŸ¥å·¥ä½œå°ï¼ˆé©å‘½æ€§é‡æ„ï¼‰ -->
      <div class="intelligent-workspace">
        <div class="section-header">
          <h3><el-icon><Bell /></el-icon>ğŸ“‹ æ™ºèƒ½é€šçŸ¥å·¥ä½œå°</h3>
          <el-button type="text" size="small">æŸ¥çœ‹æ›´å¤š</el-button>
        </div>
        
        <!-- ğŸš¨ Level 1-3 æœªè¯»é€šçŸ¥ï¼ˆæŒ‰Level 1â†’2â†’3ä¸¥æ ¼æ’åºï¼‰ -->
        <div v-if="unreadPriorityNotifications.length > 0" class="priority-workspace-section">
          <div class="workspace-priority-header">
            <h4>ğŸ¯ ä¼˜å…ˆå¤„ç†é€šçŸ¥</h4>
            <el-tag type="info" size="small">{{ unreadPriorityNotifications.length }}æ¡æœªè¯»</el-tag>
          </div>
          
          <div class="priority-notification-list">
            <div 
              v-for="notification in unreadPriorityNotifications.slice(0, 5)" 
              :key="notification.id"
              class="priority-notification-card"
              :class="{
                'level-1-emergency': notification.level === 1,
                'level-2-important': notification.level === 2,
                'level-3-regular': notification.level === 3
              }"
              @click="handleNotificationClick(notification)"
            >
              <div class="notification-priority-content">
                <div class="notification-header-row">
                  <span class="notification-title-priority">{{ notification.title }}</span>
                  <div class="notification-actions">
                    <el-tag 
                      :type="notification.level === 1 ? 'danger' : notification.level === 2 ? 'warning' : 'primary'" 
                      size="small"
                    >
                      {{ getLevelText(notification.level) }}
                    </el-tag>
                    <!-- æ ¹æ®å·²è¯»çŠ¶æ€æ˜¾ç¤ºä¸åŒçš„æŒ‰é’® -->
                    <el-button 
                      v-if="!isRead(notification.id)"
                      type="success" 
                      size="small" 
                      @click.stop="handleMarkAsRead(notification.id)"
                      class="mark-read-btn"
                    >
                      <el-icon><Check /></el-icon>
                      æ ‡è®°å·²è¯»
                    </el-button>
                    <el-tag 
                      v-else
                      type="success" 
                      size="small"
                      effect="plain"
                    >
                      <el-icon><CircleCheck /></el-icon>
                      å·²è¯»
                    </el-tag>
                  </div>
                </div>
                <div class="notification-summary-priority">{{ getContentPreview(notification.content, 80) }}</div>
                <div class="notification-meta-priority">
                  <span class="notification-publisher-priority">{{ notification.publisherName }}</span>
                  <span class="notification-time-priority">{{ formatDate(notification.createTime) }}</span>
                </div>
              </div>
            </div>
          </div>
          
          <div v-if="unreadPriorityNotifications.length > 5" class="show-more-priority">
            <el-button type="text" size="small" @click="showAllNotifications = true">
              æŸ¥çœ‹å…¨éƒ¨{{ unreadPriorityNotifications.length }}æ¡ä¼˜å…ˆé€šçŸ¥ â†’
            </el-button>
          </div>
        </div>
        
        <!-- ğŸ“š ä»Šæ—¥è¯¾ç¨‹å®‰æ’ï¼ˆæ–°å¢åŠŸèƒ½æ¨¡å—ï¼‰ -->
        <div class="workspace-module-card course-module">
          <div class="module-header">
            <h4><el-icon><Clock /></el-icon>ğŸ“š ä»Šæ—¥è¯¾ç¨‹å®‰æ’</h4>
            <el-tag type="info" size="small">{{ todayCourses.length }}èŠ‚è¯¾</el-tag>
          </div>
          <div class="course-schedule-list">
            <div 
              v-for="course in todayCourses" 
              :key="course.id" 
              class="course-schedule-item"
              :class="{
                'course-completed': course.status === 'completed',
                'course-current': course.status === 'current',
                'course-upcoming': course.status === 'upcoming'
              }"
            >
              <div class="course-time-info">{{ course.time }}</div>
              <div class="course-details">
                <div class="course-name-main">{{ course.name }}</div>
                <div class="course-location-teacher">{{ course.location }} Â· {{ course.teacher }}</div>
              </div>
              <el-tag 
                :type="course.status === 'current' ? 'warning' : course.status === 'upcoming' ? 'success' : 'info'" 
                size="small"
              >
                {{ course.status === 'current' ? 'è¿›è¡Œä¸­' : course.status === 'upcoming' ? 'å³å°†å¼€å§‹' : 'å·²ç»“æŸ' }}
              </el-tag>
            </div>
          </div>
        </div>
        
        <!-- ğŸ“ å¾…åŠäº‹åŠ¡ï¼ˆæ–°å¢åŠŸèƒ½æ¨¡å—ï¼‰ -->
        <div class="workspace-module-card todo-module">
          <div class="module-header">
            <h4><el-icon><Document /></el-icon>ğŸ“ å¾…åŠäº‹åŠ¡</h4>
            <el-tag type="warning" size="small">{{ todayTasks.filter(t => !t.completed && t.urgent).length }}é¡¹ç´§æ€¥</el-tag>
          </div>
          <div class="todo-tasks-list">
            <div 
              v-for="task in todayTasks" 
              :key="task.id" 
              class="todo-task-item"
              :class="{
                'task-completed': task.completed,
                'task-urgent': task.urgent && !task.completed,
                'task-high': task.priority === 'high' && !task.completed,
                'task-medium': task.priority === 'medium' && !task.completed,
                'task-low': task.priority === 'low' && !task.completed
              }"
            >
              <div class="task-priority-indicator" v-if="!task.completed">
                <div 
                  class="priority-dot"
                  :class="{
                    'priority-high': task.priority === 'high',
                    'priority-medium': task.priority === 'medium',
                    'priority-low': task.priority === 'low'
                  }"
                ></div>
              </div>
              <div class="task-content">
                <div class="task-title-row">
                  <span class="task-name" :class="{ 'completed-task': task.completed }">{{ task.task }}</span>
                  <el-tag 
                    v-if="task.urgent && !task.completed" 
                    type="danger" 
                    size="small"
                    class="urgent-tag"
                  >
                    ğŸ”´ ç´§æ€¥
                  </el-tag>
                </div>
                <div class="task-deadline">{{ task.deadline }}</div>
              </div>
              <el-checkbox 
                v-model="task.completed"
                class="task-checkbox"
                :disabled="task.completed"
              />
            </div>
          </div>
        </div>
        
        <!-- ğŸ’¬ é€šçŸ¥æ¶ˆæ¯ï¼ˆLevel 4ä¸“ç”¨åŒºåŸŸï¼‰ -->
        <div class="workspace-module-card level4-module" v-if="level4Messages.length > 0">
          <div class="module-header">
            <h4><el-icon><Bell /></el-icon>ğŸ’¬ é€šçŸ¥æ¶ˆæ¯</h4>
            <el-tag type="success" size="small">{{ level4Messages.length }}æ¡æé†’</el-tag>
          </div>
          <div class="level4-messages-list">
            <div 
              v-for="message in level4Messages.slice(0, 4)" 
              :key="message.id"
              class="level4-message-item"
              @click="handleNotificationClick(message, false)"
            >
              <div class="level4-icon">
                <el-icon :style="{ color: '#67C23A' }"><Bell /></el-icon>
              </div>
              <div class="level4-content">
                <div class="level4-title">{{ message.title }}</div>
                <div class="level4-time">{{ formatDate(message.createTime) }}</div>
              </div>
              <el-button type="text" size="small" class="level4-action">æŸ¥çœ‹</el-button>
            </div>
          </div>
        </div>
        
        <!-- ç»Ÿè®¡æ¨¡å—å·²ç§»é™¤ï¼Œç®€åŒ–ç•Œé¢å¸ƒå±€ -->
      </div>

      <!-- å³ä¾§ï¼šæ ¡å›­èµ„è®¯åŒº -->
      <div class="campus-news">
        <div class="section-header">
          <h3><el-icon><User /></el-icon>æ ¡å›­èµ„è®¯</h3>
          <el-button type="text" size="small">æ›´å¤šèµ„è®¯</el-button>
        </div>
        
        <div class="news-content">
          <!-- æ ¡å›­æ–°é—» -->
          <div class="news-card">
            <h4>ğŸ“¢ æ ¡å›­æ–°é—»</h4>
            <div class="news-list">
              <div v-for="news in campusNews" :key="news.id" class="news-item">
                <img :src="news.image" :alt="news.title" class="news-image" @error="handleImageError" />
                <div class="news-info">
                  <div class="news-title">{{ news.title }}</div>
                  <div class="news-time">{{ news.time }}</div>
                </div>
              </div>
            </div>
          </div>

          <!-- é€šçŸ¥å…¬å‘Šï¼ˆå¢å¼ºç‰ˆï¼‰ -->
          <div class="news-card">
            <h4>ğŸ“‹ ç³»ç»Ÿå…¬å‘Š</h4>
            <div class="system-announcements-list" v-loading="notificationLoading">
              <div v-if="systemAnnouncements.length === 0 && !notificationLoading" class="no-announcements">
                <el-empty description="æš‚æ— ç³»ç»Ÿå…¬å‘Š" :image-size="60"></el-empty>
              </div>
              <div v-for="announcement in systemAnnouncements" :key="announcement.id" class="system-announcement-item" @click="handleNotificationClick(announcement)">
                <div class="announcement-header">
                  <el-tag :type="getAnnouncementType(announcement.level)" size="small">
                    {{ getLevelText(announcement.level) }}
                  </el-tag>
                  <div class="announcement-time">{{ formatDate(announcement.createTime) }}</div>
                </div>
                <div class="announcement-title">{{ announcement.title }}</div>
                <div class="announcement-summary" v-if="announcement.summary">
                  {{ announcement.summary }}
                </div>
                <div class="announcement-content-preview" v-else>
                  {{ getFormattedPreview(announcement.content, 60) }}
                </div>
              </div>
            </div>
          </div>
          
          <!-- å·²è¯»å½’æ¡£ï¼ˆæ–°å¢åŠŸèƒ½ï¼‰ -->
          <div class="news-card" v-if="readArchivedNotifications.length > 0">
            <h4>ğŸ“‹ å·²è¯»å½’æ¡£</h4>
            <div class="read-archive-list">
              <div v-for="archived in readArchivedNotifications.slice(0, 5)" :key="archived.id" class="archived-item" @click="handleNotificationClick(archived, false)">
                <div class="archived-header">
                  <el-tag :type="getAnnouncementType(archived.level)" size="small" effect="plain">
                    {{ getLevelText(archived.level) }}
                  </el-tag>
                  <div class="archived-time">{{ formatDate(archived.createTime) }}</div>
                </div>
                <div class="archived-title">{{ archived.title }}</div>
                <div class="archived-actions">
                  <el-button type="text" size="small" @click.stop="handleMarkAsUnread(archived.id)">æ’¤é”€å·²è¯»</el-button>
                </div>
              </div>
              <div v-if="readArchivedNotifications.length > 5" class="archive-more">
                <el-button type="text" size="small" @click="showAllNotifications = true">
                  æŸ¥çœ‹æ›´å¤šå½’æ¡£ ({{ readArchivedNotifications.length }}æ¡)
                </el-button>
              </div>
            </div>
          </div>

          <!-- æ ¡å›­æœåŠ¡ -->
          <div class="news-card">
            <h4>ğŸŒ¤ï¸ æ ¡å›­æœåŠ¡</h4>
            <div class="service-info-list">
              <div class="service-info-item">
                <el-icon><Bell /></el-icon>
                <div class="info-content">
                  <div class="info-title">é£Ÿå ‚èœå•</div>
                  <div class="info-desc">ä»Šæ—¥æ¨èï¼šå®«ä¿é¸¡ä¸</div>
                </div>
              </div>
              <div class="service-info-item">
                <el-icon><User /></el-icon>
                <div class="info-content">
                  <div class="info-title">å›¾ä¹¦é¦†</div>
                  <div class="info-desc">å¼€æ”¾æ—¶é—´ï¼š8:00-22:00</div>
                </div>
              </div>
              <div class="service-info-item">
                <el-icon><Setting /></el-icon>
                <div class="info-content">
                  <div class="info-title">æ ¡å›­å·´å£«</div>
                  <div class="info-desc">ä¸‹ç­ç­æ¬¡ï¼š15åˆ†é’Ÿå</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- APIæµ‹è¯•æŒ‰é’®ï¼ˆå¼€å‘è°ƒè¯•ç”¨ï¼‰ -->
    <div class="debug-panel" v-show="showDebugPanel">
      <el-button @click="testHealthCheck" :loading="testLoading.health" size="small">
        å¥åº·æ£€æŸ¥
      </el-button>
      <el-button @click="testTokenVerify" :loading="testLoading.verify" size="small">
        éªŒè¯Token
      </el-button>
      <el-button @click="testNotificationAPI" :loading="testLoading.notification" size="small">
        é€šçŸ¥API
      </el-button>
      <el-button @click="testWeatherAPI" :loading="testLoading.weather" size="small" type="primary">
        å¤©æ°”API
      </el-button>
    </div>
  </div>

  <!-- å…¨éƒ¨é€šçŸ¥å¯¹è¯æ¡† -->
  <el-dialog 
    v-model="showAllNotifications" 
    title="å…¨éƒ¨é€šçŸ¥" 
    width="80%" 
    :close-on-click-modal="false"
    class="notification-dialog"
  >
    <div class="notification-dialog-content">
      <div class="notification-filters">
        <el-select v-model="notificationFilter.level" placeholder="æŒ‰çº§åˆ«ç­›é€‰" clearable size="small" style="width: 120px">
          <el-option label="ç´§æ€¥" :value="1" />
          <el-option label="é‡è¦" :value="2" />
          <el-option label="å¸¸è§„" :value="3" />
          <el-option label="æé†’" :value="4" />
        </el-select>
        <el-select v-model="notificationFilter.scope" placeholder="æŒ‰èŒƒå›´ç­›é€‰" clearable size="small" style="width: 120px">
          <el-option label="å…¨æ ¡" value="SCHOOL_WIDE" />
          <el-option label="éƒ¨é—¨" value="DEPARTMENT" />
          <el-option label="å¹´çº§" value="GRADE" />
          <el-option label="ç­çº§" value="CLASS" />
        </el-select>
        <el-input v-model="notificationFilter.search" placeholder="æœç´¢é€šçŸ¥æ ‡é¢˜" clearable size="small" style="width: 200px" />
      </div>
      
      <div class="notification-table">
        <el-table :data="filteredNotifications" height="400" style="width: 100%">
          <el-table-column label="çº§åˆ«" width="80" align="center">
            <template #default="{ row }">
              <el-tag :color="row.levelColor" effect="plain" size="small">
                {{ getLevelText(row.level) }}
              </el-tag>
            </template>
          </el-table-column>
          <el-table-column prop="title" label="æ ‡é¢˜" min-width="200" show-overflow-tooltip />
          <el-table-column prop="publisherName" label="å‘å¸ƒè€…" width="120" />
          <el-table-column prop="scope" label="èŒƒå›´" width="100" align="center">
            <template #default="{ row }">
              <el-tag size="small" type="info">{{ getScopeText(row.scope) }}</el-tag>
            </template>
          </el-table-column>
          <el-table-column prop="createTime" label="å‘å¸ƒæ—¶é—´" width="120" />
          <el-table-column label="æ“ä½œ" width="100" align="center">
            <template #default="{ row }">
              <el-button type="primary" link size="small" @click="handleNotificationClick(row)">æŸ¥çœ‹è¯¦æƒ…</el-button>
            </template>
          </el-table-column>
        </el-table>
      </div>
      
      <div class="notification-pagination">
        <el-pagination
          v-model:current-page="notificationPagination.currentPage"
          v-model:page-size="notificationPagination.pageSize"
          :page-sizes="[10, 20, 50, 100]"
          :total="allNotifications.length"
          layout="total, sizes, prev, pager, next, jumper"
          size="small"
        />
      </div>
    </div>
  </el-dialog>

  <!-- é€šçŸ¥è¯¦æƒ…å¯¹è¯æ¡† -->
  <el-dialog 
    v-model="showNotificationDetail" 
    :title="selectedNotification?.title || 'é€šçŸ¥è¯¦æƒ…'" 
    width="60%"
    class="notification-detail-dialog"
  >
    <div v-if="selectedNotification" class="notification-detail">
      <div class="notification-meta">
        <div class="meta-row">
          <span class="meta-label">çº§åˆ«ï¼š</span>
          <el-tag :color="selectedNotification.levelColor" effect="plain" size="small">
            {{ getLevelText(selectedNotification.level) }}
          </el-tag>
        </div>
        <div class="meta-row">
          <span class="meta-label">å‘å¸ƒè€…ï¼š</span>
          <span>{{ selectedNotification.publisherName }}</span>
        </div>
        <div class="meta-row">
          <span class="meta-label">å‘å¸ƒèŒƒå›´ï¼š</span>
          <el-tag size="small" type="info">{{ getScopeText(selectedNotification.scope) }}</el-tag>
        </div>
        <div class="meta-row">
          <span class="meta-label">å‘å¸ƒæ—¶é—´ï¼š</span>
          <span>{{ selectedNotification.createTime }}</span>
        </div>
      </div>
      
      <div class="notification-content-detail">
        <h4>é€šçŸ¥å†…å®¹ï¼š</h4>
        <div class="content-text formatted-content">{{ formatNotificationContent(selectedNotification.content) }}</div>
      </div>
    </div>
    
    <template #footer>
      <el-button @click="showNotificationDetail = false">å…³é—­</el-button>
      <el-button 
        v-if="selectedNotification && !isRead(selectedNotification.id)" 
        type="primary" 
        @click="handleMarkAsRead(selectedNotification.id); showNotificationDetail = false"
      >
        æ ‡è®°ä¸ºå·²è¯»
      </el-button>
      <el-button 
        v-else-if="selectedNotification && isRead(selectedNotification.id)" 
        type="info" 
        @click="handleMarkAsUnread(selectedNotification.id); showNotificationDetail = false"
      >
        æ’¤é”€å·²è¯»
      </el-button>
    </template>
  </el-dialog>
</template>

<script setup lang="ts">
import { computed, onMounted, reactive, ref, nextTick } from 'vue'
import { useRouter } from 'vue-router'
import { ElMessage, ElMessageBox } from 'element-plus'
import { 
  School, Avatar, SwitchButton, Bell, User, Setting,
  Sunny, Cloudy, Loading, Clock, Document, Check, CircleCheck
} from '@element-plus/icons-vue'
import { useUserStore } from '@/stores/user'
import { authAPI } from '@/api/auth'
import { weatherAPI } from '@/api/weather'
import { notificationAPI } from '@/api/notification'
import type { WeatherData } from '@/api/weather'
import type { NotificationItem } from '@/api/notification'
import { useNotificationReadStatus } from '@/composables/useNotificationReadStatus'
import dayjs from 'dayjs'

const router = useRouter()
const userStore = useUserStore()

// ç›´æ¥ä½¿ç”¨localStorageçš„ç”¨æˆ·çŠ¶æ€ï¼ˆç»•è¿‡Piniaå“åº”å¼é—®é¢˜ï¼‰
const currentToken = ref<string>('')
const currentUserInfo = ref<any>(null)
const isUserLoggedIn = ref<boolean>(false)

// ä»localStorageç›´æ¥åŠ è½½ç”¨æˆ·çŠ¶æ€
const loadUserStateFromStorage = () => {
  const savedToken = localStorage.getItem('campus_token')
  const savedUserInfo = localStorage.getItem('campus_user_info')
  
  console.log('ğŸ” ç›´æ¥ä»localStorageåŠ è½½ç”¨æˆ·çŠ¶æ€...')
  
  if (savedToken && savedUserInfo) {
    try {
      const userInfo = JSON.parse(savedUserInfo)
      currentToken.value = savedToken
      currentUserInfo.value = userInfo
      isUserLoggedIn.value = true
      
      console.log('âœ… ç”¨æˆ·çŠ¶æ€åŠ è½½æˆåŠŸ:')
      console.log('ğŸ‘¤ ç”¨æˆ·:', userInfo.username)
      console.log('ğŸ”‘ Tokené•¿åº¦:', savedToken.length)
      
      return true
    } catch (error) {
      console.error('âŒ ç”¨æˆ·ä¿¡æ¯è§£æå¤±è´¥:', error)
    }
  }
  
  console.log('âŒ æœªæ‰¾åˆ°æœ‰æ•ˆçš„ç”¨æˆ·çŠ¶æ€')
  return false
}

// æµ‹è¯•åŠ è½½çŠ¶æ€
const testLoading = reactive({
  health: false,
  verify: false,
  notification: false,
  weather: false
})

// æµ‹è¯•ç»“æœ
const testResults = ref<any>(null)

// ç™»å½•æ—¶é—´
const loginTime = ref('')

// è°ƒè¯•é¢æ¿æ˜¾ç¤ºçŠ¶æ€
const showDebugPanel = ref(true)

// å¤©æ°”ç›¸å…³çŠ¶æ€
const weatherLoading = ref(false)
const weatherData = ref<WeatherData | null>(null)
const weatherDisplay = computed(() => {
  if (weatherData.value) {
    return weatherAPI.formatWeatherDisplay(weatherData.value)
  }
  return 'å“ˆå°”æ»¨ æ™´ -5Â°C' // é»˜è®¤æ˜¾ç¤º
})

// é€šçŸ¥ç›¸å…³çŠ¶æ€
const notificationLoading = ref(false)
const recentNotifications = ref<NotificationItem[]>([])
const allNotifications = ref<NotificationItem[]>([]) // å­˜å‚¨æ‰€æœ‰é€šçŸ¥
const unreadNotificationCount = ref(0)

// åˆå§‹åŒ–æ™ºèƒ½å·¥ä½œå°å·²è¯»çŠ¶æ€ç®¡ç†ï¼ˆå“åº”å¼åˆå§‹åŒ–ï¼Œè§£å†³å¼‚æ­¥ç”¨æˆ·IDé—®é¢˜ï¼‰
let readStatusManager: any = null

// åˆå§‹åŒ–å·²è¯»çŠ¶æ€ç®¡ç†å™¨ï¼ˆå½“ç”¨æˆ·ä¿¡æ¯å¯ç”¨æ—¶ï¼‰
const initializeReadStatusManager = () => {
  const userId = currentUserInfo.value?.userId
  if (userId && !readStatusManager) {
    readStatusManager = useNotificationReadStatus(userId)
    console.log('ğŸ”§ [å·²è¯»çŠ¶æ€] åˆå§‹åŒ–å®Œæˆï¼Œç”¨æˆ·ID:', userId)
  }
  return readStatusManager
}

// å·²è¯»çŠ¶æ€æ“ä½œå‡½æ•°ï¼ˆå»¶è¿Ÿåˆå§‹åŒ–ï¼‰
const markAsRead = (notificationId: number) => {
  const manager = initializeReadStatusManager()
  if (manager) {
    manager.markAsRead(notificationId)
  }
}

const markAsUnread = (notificationId: number) => {
  const manager = initializeReadStatusManager()
  if (manager) {
    manager.markAsUnread(notificationId)
  }
}

const isRead = (notificationId: number): boolean => {
  const manager = initializeReadStatusManager()
  return manager ? manager.isRead(notificationId) : false
}

const categorizeNotifications = computed(() => {
  const manager = initializeReadStatusManager()
  return manager ? manager.categorizeNotifications.value : (() => ({
    unreadPriority: [],
    readArchive: [],
    level4Messages: [],
    systemAnnouncements: [],
    emergencyNotifications: [],
    importantNotifications: []
  }))
})

const unreadCounts = computed(() => {
  const manager = initializeReadStatusManager()
  return manager ? manager.unreadCounts.value : (() => ({
    total: 0,
    emergency: 0,
    important: 0,
    level4: 0
  }))
})

// æ™ºèƒ½å·¥ä½œå°æ ¸å¿ƒè®¡ç®—å±æ€§ - åŸºäºé©å‘½æ€§ä¸€æ¬¡éå†å¤šé‡åˆ†ç±»ç®—æ³•
const categorizedNotifications = computed(() => {
  return categorizeNotifications.value(allNotifications.value)
})

// æœªè¯»ä¼˜å…ˆçº§é€šçŸ¥ (Level 1-3æœªè¯»ï¼Œå·¥ä½œå°ä¸»è¦æ˜¾ç¤ºåŒºåŸŸ)
const unreadPriorityNotifications = computed(() => {
  return categorizedNotifications.value.unreadPriority
})

// ç³»ç»Ÿå…¬å‘Š (å³ä¾§ç³»ç»Ÿå…¬å‘ŠåŒºåŸŸæ˜¾ç¤º)
const systemAnnouncements = computed(() => {
  return categorizedNotifications.value.systemAnnouncements
})

// å·²è¯»å½’æ¡£é€šçŸ¥ (å³ä¾§å½’æ¡£åŒºåŸŸæ˜¾ç¤º)
const readArchivedNotifications = computed(() => {
  return categorizedNotifications.value.readArchive.slice(0, 5) // æœ€å¤šæ˜¾ç¤º5æ¡
})

// Level 4 é€šçŸ¥æ¶ˆæ¯ (å·¥ä½œå°åº•éƒ¨ä¸“åŒºæ˜¾ç¤º)
const level4Messages = computed(() => {
  return categorizedNotifications.value.level4Messages
})

// ç´§æ€¥é€šçŸ¥ (Level 1)
const emergencyNotifications = computed(() => {
  return categorizedNotifications.value.emergencyNotifications
})

// é‡è¦é€šçŸ¥ (Level 2-3)
const importantNotifications = computed(() => {
  return categorizedNotifications.value.importantNotifications
})

// æœªè¯»æ•°é‡ç»Ÿè®¡
const unreadStats = computed(() => {
  return unreadCounts.value(allNotifications.value)
})

// å¤„ç†"å·²è¯»"æŒ‰é’®ç‚¹å‡»
const handleMarkAsRead = (notificationId: number) => {
  markAsRead(notificationId)
  console.log('ğŸ“ [ç”¨æˆ·æ“ä½œ] æ ‡è®°é€šçŸ¥ä¸ºå·²è¯»:', notificationId)
  ElMessage.success('å·²æ ‡è®°ä¸ºå·²è¯»')
}

// å¤„ç†"æ’¤é”€å·²è¯»"æŒ‰é’®ç‚¹å‡»
const handleMarkAsUnread = (notificationId: number) => {
  markAsUnread(notificationId)
  console.log('ğŸ”„ [ç”¨æˆ·æ“ä½œ] æ’¤é”€å·²è¯»çŠ¶æ€:', notificationId)
  ElMessage.info('å·²æ’¤é”€å·²è¯»çŠ¶æ€')
}

// é€šçŸ¥å¯¹è¯æ¡†ç›¸å…³
const showAllNotifications = ref(false)
const showNotificationDetail = ref(false)
const selectedNotification = ref<NotificationItem | null>(null)

// é€šçŸ¥ç­›é€‰å’Œåˆ†é¡µ
const notificationFilter = reactive({
  level: null as number | null,
  scope: '' as string,
  search: '' as string
})

const notificationPagination = reactive({
  currentPage: 1,
  pageSize: 20
})

// å¿«æ·æœåŠ¡åˆ—è¡¨ - ç®€åŒ–ç‰ˆæœ¬
const quickServices = computed(() => [
  {
    id: 'education',
    name: 'æ•™åŠ¡ç³»ç»Ÿ',
    desc: 'è¯¾ç¨‹æŸ¥è¯¢ã€æˆç»©ç®¡ç†',
    color: '#409EFF',
    available: false
  },
  {
    id: 'student-affairs',
    name: 'å­¦å·¥ç³»ç»Ÿ',  
    desc: 'å­¦ç”Ÿç®¡ç†ã€äº‹åŠ¡åŠç†',
    color: '#67C23A',
    available: false
  },
  {
    id: 'library',
    name: 'å›¾ä¹¦é¦†',
    desc: 'å›¾ä¹¦å€Ÿé˜…ã€åº§ä½é¢„çº¦',
    color: '#E6A23C',
    available: false
  },
  {
    id: 'finance',
    name: 'è´¢åŠ¡æŸ¥è¯¢',
    desc: 'å­¦è´¹ã€å¥–å­¦é‡‘æŸ¥è¯¢',
    color: '#F56C6C',
    available: false
  },
  {
    id: 'dormitory',
    name: 'å®¿èˆç®¡ç†',
    desc: 'å®¿èˆåˆ†é…ã€æŠ¥ä¿®',
    color: '#909399',
    available: false
  },
  {
    id: 'course-selection',
    name: 'é€‰è¯¾ç³»ç»Ÿ',
    desc: 'è¯¾ç¨‹é€‰æ‹©ã€æ—¶é—´è¡¨',
    color: '#9C27B0',
    available: false
  }
])

// ä»Šæ—¥è¯¾ç¨‹å®‰æ’ Mockæ•°æ®ï¼ˆé©å‘½æ€§å·¥ä½œå°åŠŸèƒ½ï¼‰
const todayCourses = ref([
  {
    id: 1,
    time: '08:00-09:40',
    name: 'é«˜ç­‰æ•°å­¦',
    location: 'A101',
    teacher: 'ç‹æ•™æˆ',
    status: 'completed'
  },
  {
    id: 2,
    time: '10:00-11:40',
    name: 'æ•°æ®ç»“æ„',
    location: 'B201',
    teacher: 'æè€å¸ˆ',
    status: 'current' // å½“å‰è¿›è¡Œä¸­
  },
  {
    id: 3,
    time: '14:00-15:40',
    name: 'è‹±è¯­å¬è¯´',
    location: 'C301',
    teacher: 'å¼ è€å¸ˆ',
    status: 'upcoming'
  },
  {
    id: 4,
    time: '16:00-17:40',
    name: 'è®¡ç®—æœºç½‘ç»œ',
    location: 'D401',
    teacher: 'åˆ˜æ•™æˆ',
    status: 'upcoming'
  }
])

// ä»Šæ—¥å¾…åŠäº‹åŠ¡ Mockæ•°æ®ï¼ˆé©å‘½æ€§å·¥ä½œå°åŠŸèƒ½ï¼‰
const todayTasks = ref([
  {
    id: 1,
    task: 'æ•°æ®åº“ä½œä¸šæäº¤',
    deadline: 'ä»Šæ™š23:59',
    priority: 'high',
    completed: false,
    urgent: true
  },
  {
    id: 2,
    task: 'å›¾ä¹¦ã€Šç®—æ³•å¯¼è®ºã€‹ç»­å€Ÿ',
    deadline: 'æ˜å¤©åˆ°æœŸ',
    priority: 'medium',
    completed: false,
    urgent: false
  },
  {
    id: 3,
    task: 'ä¸‹å‘¨ä¸€é€‰è¯¾ç³»ç»Ÿå¼€æ”¾',
    deadline: '3å¤©å',
    priority: 'low',
    completed: false,
    urgent: false
  },
  {
    id: 4,
    task: 'å®éªŒæŠ¥å‘Šæäº¤',
    deadline: 'å·²å®Œæˆ',
    priority: 'medium',
    completed: true,
    urgent: false
  }
])

// å¤„ç†é€šçŸ¥ç‚¹å‡» - ä¿®å¤ç‰ˆï¼šé»˜è®¤ä¸è‡ªåŠ¨æ ‡è®°å·²è¯»
const handleNotificationClick = async (notification: NotificationItem, autoMarkRead: boolean = false) => {
  console.log('ğŸ“– ç‚¹å‡»æŸ¥çœ‹é€šçŸ¥è¯¦æƒ…:', notification.title)
  
  try {
    const result = await notificationAPI.getNotificationDetail(notification.id)
    
    if (result.success) {
      selectedNotification.value = result.data
      showNotificationDetail.value = true
      
      // åªæœ‰æ˜ç¡®æŒ‡å®šæ‰è‡ªåŠ¨æ ‡è®°ä¸ºå·²è¯»
      if (autoMarkRead && !isRead(notification.id)) {
        markAsRead(notification.id)
        console.log('ğŸ·ï¸ [è‡ªåŠ¨æ ‡è®°] é€šçŸ¥å·²æ ‡è®°ä¸ºå·²è¯»:', notification.id)
      }
    } else {
      ElMessage.error('è·å–é€šçŸ¥è¯¦æƒ…å¤±è´¥')
    }
  } catch (error) {
    console.error('âŒ æŸ¥çœ‹é€šçŸ¥è¯¦æƒ…å¤±è´¥:', error)
    ElMessage.error('æŸ¥çœ‹é€šçŸ¥è¯¦æƒ…å¤±è´¥')
  }
}

// è·å–çº§åˆ«æ–‡æœ¬
const getLevelText = (level: number): string => {
  switch (level) {
    case 1: return 'ç´§æ€¥'
    case 2: return 'é‡è¦'
    case 3: return 'å¸¸è§„'
    case 4: return 'æé†’'
    default: return 'æœªçŸ¥'
  }
}

// æ ¼å¼åŒ–é€šçŸ¥å†…å®¹ï¼ˆå¤„ç†æ¢è¡Œç¬¦å’Œæ ¼å¼ï¼‰
const formatNotificationContent = (content: string): string => {
  if (!content) return ''
  // å°†\nè½¬æ¢ä¸ºå®é™…æ¢è¡Œç¬¦ï¼Œå¤„ç†å„ç§æ¢è¡Œæ ¼å¼
  return content
    .replace(/\\n/g, '\n')  // è½¬ä¹‰çš„\nè½¬ä¸ºçœŸæ¢è¡Œ
    .replace(/\n\s*\n/g, '\n\n')  // è§„èŒƒåŒ–å¤šé‡æ¢è¡Œ
    .replace(/^\s+|\s+$/g, '')  // å»é™¤é¦–å°¾ç©ºç™½
    .trim()
}

// è·å–å†…å®¹é¢„è§ˆï¼ˆç”¨äºå¡ç‰‡æ˜¾ç¤ºï¼Œå°†æ¢è¡Œè½¬ä¸ºç©ºæ ¼ï¼‰
const getContentPreview = (content: string, maxLength: number = 50): string => {
  if (!content) return ''
  // å…ˆæ ¼å¼åŒ–ï¼Œç„¶åå°†æ¢è¡Œç¬¦æ›¿æ¢ä¸ºç©ºæ ¼ç”¨äºé¢„è§ˆ
  const formatted = formatNotificationContent(content)
  const preview = formatted.replace(/\n{2,}/g, ' | ').replace(/\n/g, ' ')
  return preview.length > maxLength ? preview.substring(0, maxLength) + '...' : preview
}

// è·å–æ ¼å¼åŒ–çš„å†…å®¹é¢„è§ˆï¼ˆç”¨äºå³ä¾§é€šçŸ¥å…¬å‘Šï¼‰
const getFormattedPreview = (content: string, maxLength: number = 80): string => {
  if (!content) return ''
  const formatted = formatNotificationContent(content)
  // å°†æ¢è¡Œç¬¦æ›¿æ¢ä¸ºç©ºæ ¼ç”¨äºé¢„è§ˆï¼Œä½†ä¿æŒæ®µè½ç»“æ„
  const preview = formatted.replace(/\n{2,}/g, ' | ').replace(/\n/g, ' ')
  return preview.length > maxLength ? preview.substring(0, maxLength) + '...' : preview
}

// è·å–èŒƒå›´æ–‡æœ¬
const getScopeText = (scope: string): string => {
  switch (scope) {
    case 'SCHOOL_WIDE': return 'å…¨æ ¡'
    case 'DEPARTMENT': return 'éƒ¨é—¨'
    case 'GRADE': return 'å¹´çº§'
    case 'CLASS': return 'ç­çº§'
    default: return scope
  }
}

// ç­›é€‰åçš„é€šçŸ¥åˆ—è¡¨
const filteredNotifications = computed(() => {
  let filtered = allNotifications.value

  // æŒ‰çº§åˆ«ç­›é€‰
  if (notificationFilter.level !== null) {
    filtered = filtered.filter(item => item.level === notificationFilter.level)
  }

  // æŒ‰èŒƒå›´ç­›é€‰
  if (notificationFilter.scope) {
    filtered = filtered.filter(item => item.scope === notificationFilter.scope)
  }

  // æŒ‰æ ‡é¢˜æœç´¢
  if (notificationFilter.search) {
    filtered = filtered.filter(item => 
      item.title.toLowerCase().includes(notificationFilter.search.toLowerCase())
    )
  }

  return filtered
})

// æ ¡å›­æ–°é—»
const campusNews = ref([
  {
    id: 1,
    title: 'æˆ‘æ ¡åœ¨å…¨å›½ç¨‹åºè®¾è®¡ç«èµ›ä¸­è·å¾—ä½³ç»©',
    time: '2025-08-12',
    image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA2MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0yNSAyMEMyNSAxNy4yMzg2IDI3LjIzODYgMTUgMzAgMTVDMzIuNzYxNCAxNSAzNSAxNy4yMzg2IDM1IDIwQzM1IDIyLjc2MTQgMzIuNzYxNCAyNSAzMCAyNUMyNy4yMzg2IDI1IDI1IDIyLjc2MTQgMjUgMjBaIiBmaWxsPSIjQ0NDQ0NDIi8+CjxwYXRoIGQ9Ik0yMCAyOEwyNS41IDIyLjVMMzIuNSAyOS41TDQwIDIyTDQwIDMySDIwVjI4WiIgZmlsbD0iI0NDQ0NDQyIvPgo8L3N2Zz4K'
  },
  {
    id: 2,
    title: '2025å¹´æ˜¥å­£å­¦æœŸå¼€å­¦å…¸ç¤¼æˆåŠŸä¸¾è¡Œ',
    time: '2025-08-11', 
    image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA2MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjRjBGOEZGIi8+CjxjaXJjbGUgY3g9IjMwIiBjeT0iMTYiIHI9IjQiIGZpbGw9IiM0MDlFRkYiLz4KPHBhdGggZD0iTTIyIDI2QzIyIDIzLjc5MDkgMjMuNzkwOSAyMiAyNiAyMkgzNEMzNi4yMDkxIDIyIDM4IDIzLjc5MDkgMzggMjZWMzJIMjJWMjZaIiBmaWxsPSIjNDA5RUZGIi8+Cjwvc3ZnPgo='
  }
])

// å½“å‰æ˜¾ç¤ºçš„ç´§æ€¥é€šçŸ¥ï¼ˆæ”¯æŒè½®æ’­ï¼ŒåŸºäºæ™ºèƒ½åˆ†ç±»ç»“æœï¼‰
const currentEmergencyNotification = computed(() => {
  return emergencyNotifications.value[0] || null
})

// å…¬å‘Šé€šçŸ¥æ•°æ®ï¼ˆå³ä¾§é€šçŸ¥å…¬å‘Šæ ä¸“ç”¨ï¼Œæ”¹ä¸ºä½¿ç”¨æ™ºèƒ½åˆ†ç±»çš„ç³»ç»Ÿå…¬å‘Šï¼‰
const announcementNotifications = computed(() => systemAnnouncements.value)

// è·å–é—®å€™è¯­
const getGreeting = () => {
  const hour = new Date().getHours()
  if (hour < 6) return 'å¤œæ·±äº†'
  if (hour < 9) return 'æ—©ä¸Šå¥½'
  if (hour < 12) return 'ä¸Šåˆå¥½'
  if (hour < 14) return 'ä¸­åˆå¥½'
  if (hour < 18) return 'ä¸‹åˆå¥½'
  if (hour < 22) return 'æ™šä¸Šå¥½'
  return 'å¤œæ·±äº†'
}

// è·å–å½“å‰æ—¥æœŸ
const getCurrentDate = () => {
  return dayjs().format('YYYYå¹´MMæœˆDDæ—¥ dddd')
}

// å¤©æ°”å›¾æ ‡æ˜ å°„å‡½æ•°
const getWeatherIcon = (weatherText: string) => {
  // æ ¹æ®å¤©æ°”æ–‡æœ¬è¿”å›å¯¹åº”å›¾æ ‡ï¼Œç®€åŒ–ç‰ˆæœ¬
  if (weatherText.includes('æ™´')) return Sunny
  if (weatherText.includes('é›¨') || weatherText.includes('é˜µé›¨') || weatherText.includes('æš´é›¨') || 
      weatherText.includes('å°é›¨') || weatherText.includes('æ¯›æ¯›é›¨') || weatherText.includes('é›·')) return Bell
  if (weatherText.includes('é›ª') || weatherText.includes('æš´é›ª')) return Bell
  if (weatherText.includes('äº‘') || weatherText.includes('å¤šäº‘') || weatherText.includes('é˜´')) return Cloudy
  if (weatherText.includes('é£')) return Bell
  return Sunny // é»˜è®¤å›¾æ ‡
}

// å¤©æ°”å›¾æ ‡é¢œè‰²æ˜ å°„
const getWeatherIconColor = (weatherText: string) => {
  if (weatherText.includes('æ™´')) return '#FFD700' // é‡‘é»„è‰²
  if (weatherText.includes('é›¨') || weatherText.includes('é˜µé›¨')) return '#4A90E2' // è“è‰²
  if (weatherText.includes('é›·')) return '#9B59B6' // ç´«è‰²
  if (weatherText.includes('é›ª')) return '#87CEEB' // å¤©è“è‰²
  if (weatherText.includes('äº‘') || weatherText.includes('å¤šäº‘')) return '#95A5A6' // ç°è‰²
  if (weatherText.includes('é˜´')) return '#7F8C8D' // æ·±ç°è‰²
  if (weatherText.includes('é£')) return '#16A085' // é’è‰²
  return '#FFD700' // é»˜è®¤é‡‘é»„è‰²
}

// æ£€æŸ¥æ˜¯å¦æœ‰æ¬¡è¦å¤©æ°”ä¿¡æ¯
const hasSecondaryWeatherInfo = (weather: WeatherData) => {
  return !!(
    (weather.feelsLike && weather.feelsLike !== weather.temperature) ||
    weather.humidity ||
    (weather.windDir && weather.windScale) ||
    (weather.precipitation && weather.precipitation > 0)
  )
}

// è·å–é€šçŸ¥ç±»å‹
const getAnnouncementType = (level: number): string => {
  switch (level) {
    case 1: return 'danger'  // ç´§æ€¥
    case 2: return 'warning' // é‡è¦
    case 3: return 'info'    // å¸¸è§„
    case 4: return 'success' // æé†’
    default: return 'info'
  }
}

// æ ¼å¼åŒ–æ—¥æœŸ
const formatDate = (dateStr: string): string => {
  if (!dateStr) return ''
  try {
    const date = new Date(dateStr)
    if (isNaN(date.getTime())) return dateStr
    return dayjs(date).format('YYYY-MM-DD')
  } catch (error) {
    console.error('æ—¥æœŸæ ¼å¼åŒ–é”™è¯¯:', error)
    return dateStr
  }
}

// å¤„ç†ç´§æ€¥é€šçŸ¥ç‚¹å‡»ï¼ˆå…¼å®¹æ€§ä¿ç•™ï¼‰
const handleEmergencyClick = (notification: NotificationItem) => {
  console.log('ğŸš¨ ç‚¹å‡»ç´§æ€¥é€šçŸ¥:', notification.title)
  handleNotificationClick(notification)
}

// æ›´æ–°é€šçŸ¥åŠ è½½é€»è¾‘ï¼Œæ·»åŠ æ™ºèƒ½ç»Ÿè®¡
const loadNotificationData = async () => {
  console.log('ğŸ“¢ å¼€å§‹åŠ è½½é€šçŸ¥æ•°æ®...')
  notificationLoading.value = true
  
  try {
    const result = await notificationAPI.getNotificationList({ pageSize: 100 })
    
    if (result.success && result.data.list) {
      allNotifications.value = result.data.list
      recentNotifications.value = result.data.list.slice(0, 3) // å…¼å®¹åŸæœ‰é€»è¾‘
      console.log('âœ… é€šçŸ¥æ•°æ®åŠ è½½æˆåŠŸ:', allNotifications.value.length, 'æ¡')
      
      // æ›´æ–°æœªè¯»æ•°é‡
      updateUnreadCount()
    } else {
      console.log('âš ï¸ é€šçŸ¥APIè¿”å›å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®')
      allNotifications.value = notificationAPI.getDefaultNotifications()
      recentNotifications.value = allNotifications.value.slice(0, 3)
      ElMessage.warning('ä½¿ç”¨é»˜è®¤é€šçŸ¥æ•°æ®')
    }
  } catch (error) {
    console.error('âŒ åŠ è½½é€šçŸ¥æ•°æ®å¤±è´¥:', error)
    allNotifications.value = notificationAPI.getDefaultNotifications()
    recentNotifications.value = allNotifications.value.slice(0, 3)
    ElMessage.error('é€šçŸ¥æ•°æ®åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®')
  } finally {
    notificationLoading.value = false
    console.log('ğŸ é€šçŸ¥æ•°æ®åŠ è½½å®Œæˆ')
  }
}

// æ›´æ–°æœªè¯»é€šçŸ¥æ•°é‡ - ä½¿ç”¨æ™ºèƒ½ç»Ÿè®¡
const updateUnreadCount = () => {
  try {
    const counts = unreadStats.value
    unreadNotificationCount.value = counts.total
    console.log('ğŸ”” [æ™ºèƒ½ç»Ÿè®¡] æ›´æ–°æœªè¯»é€šçŸ¥æ•°é‡:', counts)
  } catch (error) {
    console.error('âŒ æ›´æ–°æœªè¯»æ•°é‡å¤±è´¥:', error)
  }
}

// åŠ è½½å¤©æ°”æ•°æ®
const loadWeatherData = async () => {
  console.log('ğŸŒ¤ï¸ å¼€å§‹åŠ è½½å¤©æ°”æ•°æ®...')
  weatherLoading.value = true
  
  try {
    const result = await weatherAPI.getCurrentWeather()
    
    if (result.success && result.data) {
      weatherData.value = result.data
      console.log('âœ… å¤©æ°”æ•°æ®åŠ è½½æˆåŠŸ:', result.data)
      ElMessage.success('å¤©æ°”æ•°æ®å·²æ›´æ–°')
    } else {
      console.log('âš ï¸ å¤©æ°”APIè¿”å›å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®')
      weatherData.value = weatherAPI.getDefaultWeatherData()
      ElMessage.warning('ä½¿ç”¨é»˜è®¤å¤©æ°”æ•°æ®')
    }
  } catch (error) {
    console.error('âŒ åŠ è½½å¤©æ°”æ•°æ®å¤±è´¥:', error)
    weatherData.value = weatherAPI.getDefaultWeatherData()
    ElMessage.error('å¤©æ°”æ•°æ®åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®')
  } finally {
    weatherLoading.value = false
    console.log('ğŸ å¤©æ°”æ•°æ®åŠ è½½å®Œæˆ')
  }
}

// APIæµ‹è¯•æ–¹æ³•
const testHealthCheck = async () => {
  console.log('=== å¥åº·æ£€æŸ¥æµ‹è¯•å¼€å§‹ ===')
  console.log('ğŸ¥ å¼€å§‹æµ‹è¯•Mock School APIå¥åº·æ£€æŸ¥...')
  
  testLoading.health = true
  testResults.value = null
  
  try {
    console.log('ğŸ“¤ å‘é€å¥åº·æ£€æŸ¥è¯·æ±‚...')
    const result = await authAPI.healthCheck()
    console.log('ğŸ“¥ å¥åº·æ£€æŸ¥å“åº”:', result)
    
    if (result.success) {
      console.log('âœ… å¥åº·æ£€æŸ¥æˆåŠŸ')
      ElMessage.success('Mock School API æœåŠ¡æ­£å¸¸è¿è¡Œ')
    } else {
      console.log('âŒ å¥åº·æ£€æŸ¥å¤±è´¥')
    }
  } catch (error) {
    console.log('âŒ å¥åº·æ£€æŸ¥å¼‚å¸¸:', error)
  } finally {
    testLoading.health = false
    console.log('=== å¥åº·æ£€æŸ¥æµ‹è¯•ç»“æŸ ===')
  }
}

const testTokenVerify = async () => {
  console.log('=== TokenéªŒè¯æµ‹è¯•å¼€å§‹ ===')
  console.log('ğŸ”‘ å½“å‰Token:', currentToken.value?.substring(0, 50) + '...')
  
  testLoading.verify = true
  testResults.value = null
  
  if (!currentToken.value) {
    console.log('âŒ æ²¡æœ‰å¯éªŒè¯çš„Token')
    testLoading.verify = false
    return
  }
  
  try {
    console.log('ğŸ“¤ å‘é€TokenéªŒè¯è¯·æ±‚...')
    const result = await authAPI.verifyToken(currentToken.value)
    console.log('ğŸ“¥ TokenéªŒè¯å“åº”:', result)
    
    if (result.success) {
      console.log('âœ… TokenéªŒè¯æˆåŠŸ')
      ElMessage.success('TokenéªŒè¯é€šè¿‡')
    } else {
      console.log('âŒ TokenéªŒè¯å¤±è´¥')
    }
  } catch (error: any) {
    console.log('âŒ TokenéªŒè¯å¼‚å¸¸:', error)
  } finally {
    testLoading.verify = false
    console.log('=== TokenéªŒè¯æµ‹è¯•ç»“æŸ ===')
  }
}

const testNotificationAPI = async () => {
  console.log('=== é€šçŸ¥APIæµ‹è¯•å¼€å§‹ ===')
  console.log('ğŸ“¢ å¼€å§‹æµ‹è¯•ä¸»é€šçŸ¥æœåŠ¡è¿æ¥...')
  console.log('ğŸ”‘ ä½¿ç”¨Token:', currentToken.value?.substring(0, 50) + '...')
  
  testLoading.notification = true
  testResults.value = null
  
  try {
    console.log('ğŸ“¤ å‘é€é€šçŸ¥API Pingè¯·æ±‚...')
    
    // ç›´æ¥ä½¿ç”¨fetchæµ‹è¯•ä¸»é€šçŸ¥æœåŠ¡
    const response = await fetch('http://localhost:48081/admin-api/test/notification/api/ping', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${currentToken.value}`,
        'Content-Type': 'application/json',
        'tenant-id': '1'
      }
    })
    
    console.log('ğŸ“¥ é€šçŸ¥APIå“åº”çŠ¶æ€:', response.status, response.statusText)
    
    const result = await response.text()
    console.log('ğŸ“¥ é€šçŸ¥APIå“åº”å†…å®¹:', result)
    
    if (response.ok) {
      console.log('âœ… ä¸»é€šçŸ¥æœåŠ¡è¿æ¥æˆåŠŸ')
      ElMessage.success('ä¸»é€šçŸ¥æœåŠ¡è¿æ¥æ­£å¸¸')
    } else {
      console.log('âŒ é€šçŸ¥APIå“åº”é”™è¯¯')
    }
  } catch (error) {
    console.log('âŒ é€šçŸ¥APIæµ‹è¯•å¼‚å¸¸:', error)
  } finally {
    testLoading.notification = false
    console.log('=== é€šçŸ¥APIæµ‹è¯•ç»“æŸ ===')
  }
}

const testWeatherAPI = async () => {
  console.log('=== å¤©æ°”APIæµ‹è¯•å¼€å§‹ ===')
  console.log('ğŸŒ¤ï¸ å¼€å§‹æµ‹è¯•å¤©æ°”ç¼“å­˜æœåŠ¡è¿æ¥...')
  console.log('ğŸ”‘ ä½¿ç”¨Token:', currentToken.value?.substring(0, 50) + '...')
  
  testLoading.weather = true
  testResults.value = null
  
  try {
    console.log('ğŸ“¤ å‘é€å¤©æ°”APIè¯·æ±‚...')
    
    const result = await weatherAPI.getCurrentWeather()
    console.log('ğŸ“¥ å¤©æ°”APIå“åº”:', result)
    
    if (result.success) {
      console.log('âœ… å¤©æ°”APIè¿æ¥æˆåŠŸ')
      console.log('ğŸŒ¤ï¸ å¤©æ°”æ•°æ®:', result.data)
      ElMessage.success(`å¤©æ°”APIæ­£å¸¸ - ${result.data.cityName} ${result.data.weatherText} ${result.data.temperature}Â°C`)
    } else {
      console.log('âš ï¸ å¤©æ°”APIè¿”å›å¤±è´¥')
      ElMessage.warning(`å¤©æ°”APIå¼‚å¸¸: ${result.message}`)
    }
  } catch (error: any) {
    console.log('âŒ å¤©æ°”APIæµ‹è¯•å¼‚å¸¸:', error)
    ElMessage.error(`å¤©æ°”APIæµ‹è¯•å¤±è´¥: ${error.message}`)
  } finally {
    testLoading.weather = false
    console.log('=== å¤©æ°”APIæµ‹è¯•ç»“æŸ ===')
  }
}

// è®¡ç®—å±æ€§
const isAdmin = computed(() => {
  return currentUserInfo.value?.roleCode === 'PRINCIPAL' || currentUserInfo.value?.roleCode === 'ACADEMIC_ADMIN'
})

// å¤„ç†ç”¨æˆ·é€€å‡ºç™»å½•
const handleLogout = async () => {
  try {
    console.log('ğŸ”“ [é€€å‡ºç™»å½•] å¼€å§‹å¤„ç†ç”¨æˆ·é€€å‡º...')
    
    // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
    await ElMessageBox.confirm(
      'ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ',
      'é€€å‡ºç¡®è®¤',
      {
        confirmButtonText: 'ç¡®å®š',
        cancelButtonText: 'å–æ¶ˆ',
        type: 'warning'
      }
    )
    
    console.log('âœ… [é€€å‡ºç™»å½•] ç”¨æˆ·ç¡®è®¤é€€å‡º')
    
    // æ¸…ç†æœ¬åœ°å­˜å‚¨æ•°æ®ï¼ˆä¿ç•™å·²è¯»çŠ¶æ€ï¼‰
    localStorage.removeItem('campus_token')
    localStorage.removeItem('campus_user_info')
    // âŒ å·²åˆ é™¤ï¼šlocalStorage.removeItem('campus_portal_read_notifications')
    // âœ… å·²è¯»çŠ¶æ€åº”è¯¥æŒä¹…åŒ–ä¿å­˜ï¼Œç”¨æˆ·é‡æ–°ç™»å½•åä»èƒ½çœ‹åˆ°å·²è¯»å½’æ¡£
    
    // æ¸…ç†å½“å‰çŠ¶æ€
    currentToken.value = ''
    currentUserInfo.value = null
    isUserLoggedIn.value = false
    
    // ğŸ”§ é‡ç½®å·²è¯»çŠ¶æ€ç®¡ç†å™¨ï¼ˆä¸ºä¸‹æ¬¡ç™»å½•å‡†å¤‡ï¼‰
    readStatusManager = null
    
    console.log('ğŸ§¹ [é€€å‡ºç™»å½•] æ¸…ç†æœ¬åœ°æ•°æ®å®Œæˆ')
    
    // æ˜¾ç¤ºé€€å‡ºæˆåŠŸæç¤º
    ElMessage.success('é€€å‡ºç™»å½•æˆåŠŸ')
    
    // è·³è½¬åˆ°ç™»å½•é¡µ
    console.log('ğŸ”„ [é€€å‡ºç™»å½•] è·³è½¬åˆ°ç™»å½•é¡µé¢')
    router.push('/login')
    
  } catch (error) {
    // ç”¨æˆ·å–æ¶ˆé€€å‡ºï¼Œä¸æ˜¾ç¤ºé”™è¯¯
    if (error !== 'cancel') {
      console.error('âŒ [é€€å‡ºç™»å½•] é€€å‡ºè¿‡ç¨‹å‡ºé”™:', error)
      ElMessage.error('é€€å‡ºç™»å½•å¤±è´¥')
    }
  }
}

// å¤„ç†å¿«æ·æœåŠ¡ç‚¹å‡»
const handleServiceClick = (service: any) => {
  if (!service.available) {
    ElMessage.info(`${service.name} åŠŸèƒ½å³å°†ä¸Šçº¿ï¼Œæ•¬è¯·æœŸå¾…`)
    return
  }
  
  console.log('ğŸ¯ [å¿«æ·æœåŠ¡] ç‚¹å‡»æœåŠ¡:', service.name)
  ElMessage.info(`æ­£åœ¨æ‰“å¼€ ${service.name}...`)
}

// å¤„ç†å›¾ç‰‡åŠ è½½é”™è¯¯
const handleImageError = (event: Event) => {
  const target = event.target as HTMLImageElement
  if (target) {
    target.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA2MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0yNSAyMEMyNSAxNy4yMzg2IDI3LjIzODYgMTUgMzAgMTVDMzIuNzYxNCAxNSAzNSAxNy4yMzg2IDM1IDIwQzM1IDIyLjc2MTQgMzIuNzYxNCAyNSAzMCAyNUMyNy4yMzg2IDI1IDI1IDIyLjc2MTQgMjUgMjBaIiBmaWxsPSIjQ0NDQ0NDIi8+CjxwYXRoIGQ9Ik0yMCAyOEwyNS41IDIyLjVMMzIuNSAyOS41TDQwIDIyTDQwIDMySDIwVjI4WiIgZmlsbD0iI0NDQ0NDQyIvPgo8L3N2Zz4K'
  }
}

// ç»„ä»¶åˆå§‹åŒ–
onMounted(() => {
  console.log('=== é¦–é¡µåˆå§‹åŒ–å¼€å§‹ ===')
  console.log('å½“å‰æ—¶é—´:', dayjs().format('YYYY/MM/DD HH:mm:ss'))
  console.log('å½“å‰è·¯ç”±:', router.currentRoute.value.path)
  
  console.log('ğŸ” å¼€å§‹åŠ è½½ç”¨æˆ·è®¤è¯çŠ¶æ€...')
  
  // ç›´æ¥ä»localStorageåŠ è½½ç”¨æˆ·çŠ¶æ€ï¼Œä¸å†ä¾èµ–Pinia
  const isLoggedIn = loadUserStateFromStorage()
  
  if (isLoggedIn && currentUserInfo.value) {
    loginTime.value = dayjs().format('YYYY-MM-DD HH:mm:ss')
    console.log('âœ… ç”¨æˆ·å·²ç™»å½•ï¼Œé¦–é¡µåˆå§‹åŒ–å®Œæˆ')
    console.log('ğŸ‘¤ å½“å‰ç”¨æˆ·:', currentUserInfo.value.username)
    console.log('ğŸ”‘ å½“å‰Tokené•¿åº¦:', currentToken.value.length)
    
    // ğŸ”§ ç”¨æˆ·ä¿¡æ¯åŠ è½½å®Œæˆåï¼Œå¼ºåˆ¶åˆå§‹åŒ–å·²è¯»çŠ¶æ€ç®¡ç†å™¨
    readStatusManager = null // é‡ç½®ç®¡ç†å™¨
    initializeReadStatusManager() // é‡æ–°åˆå§‹åŒ–
    
    // ç”¨æˆ·ç™»å½•æˆåŠŸååŠ è½½æ•°æ®
    loadWeatherData()
    loadNotificationData()
  } else {
    console.log('âŒ ç”¨æˆ·æœªç™»å½•ï¼Œå‡†å¤‡è·³è½¬åˆ°ç™»å½•é¡µ')
    router.push('/login')
  }
  
  console.log('=== é¦–é¡µåˆå§‹åŒ–ç»“æŸ ===')
})
</script>

<style scoped>
/* å…¨å±€å®¹å™¨ - æ¸…æ–°å­¦é™¢é£æ¸å˜èƒŒæ™¯ */
.portal-container {
  min-height: 100vh;
  background: linear-gradient(135deg, #F0F9FF 0%, #DBEAFE 20%, #BFDBFE 100%);
  position: relative;
}

/* æ·»åŠ å¾®å¦™çš„èƒŒæ™¯å›¾æ¡ˆ */
.portal-container::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-image: 
    radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.03) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(16, 185, 129, 0.03) 0%, transparent 50%);
  pointer-events: none;
  z-index: 1;
}

/* ç¡®ä¿å†…å®¹åœ¨èƒŒæ™¯ä¹‹ä¸Š */
.portal-container > * {
  position: relative;
  z-index: 2;
}

/* é¡¶éƒ¨å¯¼èˆªæ  - ç°ä»£åŒ–è®¾è®¡ */
.portal-header {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  box-shadow: 0 4px 20px rgba(30, 58, 138, 0.08);
  border-bottom: 1px solid rgba(59, 130, 246, 0.1);
  position: sticky;
  top: 0;
  z-index: 100;
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 24px;
  height: 70px;
  max-width: 1200px;
  margin: 0 auto;
}

.school-brand {
  display: flex;
  align-items: center;
  gap: 16px;
}

.brand-icon {
  color: #1E3A8A; /* æ·±è“è‰² */
}

.brand-info {
  display: flex;
  flex-direction: column;
}

.brand-title {
  font-size: 18px;
  font-weight: 600;
  color: #1E3A8A; /* æ·±è“è‰² */
  margin: 0;
  line-height: 1.2;
}

.brand-subtitle {
  font-size: 12px;
  color: #3B82F6; /* å¤©è“è‰² */
  line-height: 1.2;
}

.user-panel {
  display: flex;
  align-items: center;
  gap: 12px;
}

.user-details {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
}

.user-name {
  font-size: 14px;
  font-weight: 500;
  color: #262626;
  line-height: 1.2;
}

.user-role {
  font-size: 12px;
  color: #8c8c8c;
  line-height: 1.2;
}

/* é—®å€™æ¨ªå¹… - æ¸…æ–°å­¦é™¢é£è®¾è®¡ */
.welcome-banner {
  background: linear-gradient(135deg, #1E3A8A 0%, #3B82F6 100%);
  color: white;
  padding: 32px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  border-radius: 16px;
  margin: 0 24px 24px 24px;
  box-shadow: 0 8px 32px rgba(30, 58, 138, 0.2);
  position: relative;
  overflow: hidden;
}

/* æ¨ªå¹…è£…é¥°å…ƒç´  */
.welcome-banner::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -20%;
  width: 200px;
  height: 200px;
  background: radial-gradient(circle, rgba(16, 185, 129, 0.15) 0%, transparent 70%);
  border-radius: 50%;
}

.welcome-banner::after {
  content: '';
  position: absolute;
  bottom: -30%;
  left: -10%;
  width: 150px;
  height: 150px;
  background: radial-gradient(circle, rgba(245, 158, 11, 0.15) 0%, transparent 70%);
  border-radius: 50%;
}

.greeting {
  font-size: 24px;
  font-weight: 600;
  margin: 0 0 8px 0;
}

.date-info {
  font-size: 14px;
  opacity: 0.9;
  margin: 0;
}

.weather-info {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
}

.weather-content {
  display: flex;
  align-items: center;
  gap: 8px;
}

.weather-main {
  display: flex;
  align-items: center;
  gap: 12px;
  background: rgba(255, 255, 255, 0.1);
  padding: 8px 12px;
  border-radius: 12px;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.weather-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  background: rgba(255, 255, 255, 0.15);
  border-radius: 50%;
}

.weather-details {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.weather-primary {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 500;
}

.weather-primary .location {
  font-size: 14px;
  color: rgba(255, 255, 255, 0.9);
}

.weather-primary .temperature {
  font-size: 16px;
  font-weight: 600;
  color: #FFD700;
}

.weather-primary .weather-text {
  font-size: 14px;
  color: rgba(255, 255, 255, 0.8);
}

.weather-secondary {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: rgba(255, 255, 255, 0.7);
}

.weather-secondary .humidity,
.weather-secondary .wind,
.weather-secondary .feels-like,
.weather-secondary .precipitation {
  padding: 2px 6px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  font-size: 11px;
}

.weather-loading {
  display: flex;
  align-items: center;
  gap: 6px;
  color: rgba(255, 255, 255, 0.7);
}

.weather-loading .loading-icon {
  animation: rotate 1s linear infinite;
}

.weather-default {
  display: flex;
  align-items: center;
  gap: 6px;
  color: rgba(255, 255, 255, 0.7);
}

@keyframes rotate {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* ä¸‰åŒºå¸ƒå±€ä¸»ä½“ */
.portal-main {
  display: grid;
  grid-template-columns: 300px 1fr 320px;
  gap: 24px;
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 24px;
}

/* å·¦ä¾§å¿«æ·æœåŠ¡åŒº - ç°ä»£åŒ–å¡ç‰‡ */
.quick-services {
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(10px);
  border-radius: 16px;
  box-shadow: 0 8px 32px rgba(30, 58, 138, 0.08);
  border: 1px solid rgba(59, 130, 246, 0.1);
  padding: 24px;
  height: fit-content;
  transition: all 0.3s ease;
}

.quick-services:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 40px rgba(30, 58, 138, 0.12);
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid #f0f0f0;
}

.section-header h3 {
  display: flex;
  align-items: center;
  gap: 8px;
  margin: 0;
  font-size: 16px;
  color: #262626;
}

.service-grid {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.service-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  border: 1px solid transparent;
  background: rgba(240, 249, 255, 0.3);
}

.service-item:hover {
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(16, 185, 129, 0.05) 100%);
  border-color: rgba(59, 130, 246, 0.2);
  transform: translateX(4px);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
}

.service-item.disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.service-item.disabled:hover {
  background: rgba(240, 249, 255, 0.3);
  border-color: transparent;
  transform: none;
  box-shadow: none;
}

.service-icon {
  flex-shrink: 0;
}

.service-info {
  flex: 1;
  min-width: 0;
}

.service-name {
  font-size: 14px;
  font-weight: 500;
  color: #262626;
  line-height: 1.2;
  margin-bottom: 4px;
}

.service-desc {
  font-size: 12px;
  color: #8c8c8c;
  line-height: 1.2;
}

.service-arrow {
  color: #bfbfbf;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.service-item:hover .service-arrow {
  opacity: 1;
}

/* ä¸­é—´æ™ºèƒ½å·¥ä½œå° - é©å‘½æ€§é‡æ„æ ·å¼ */
.intelligent-workspace {
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(10px);
  border-radius: 16px;
  box-shadow: 0 8px 32px rgba(30, 58, 138, 0.08);
  border: 1px solid rgba(59, 130, 246, 0.1);
  padding: 24px;
  height: fit-content;
  transition: all 0.3s ease;
}

.intelligent-workspace:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 40px rgba(30, 58, 138, 0.12);
}

/* ğŸ¯ ä¼˜å…ˆé€šçŸ¥å·¥ä½œå°åŒºåŸŸ - é©å‘½æ€§åˆ†çº§é¢œè‰²ç³»ç»Ÿ */
.priority-workspace-section {
  margin-bottom: 24px;
  border-radius: 12px;
  padding: 20px;
  background: linear-gradient(135deg, rgba(240, 249, 255, 0.6) 0%, rgba(255, 255, 255, 0.9) 100%);
  border: 1px solid rgba(59, 130, 246, 0.15);
}

.workspace-priority-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid rgba(59, 130, 246, 0.1);
}

.workspace-priority-header h4 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
  color: #1E3A8A;
}

.priority-notification-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* åˆ†çº§é€šçŸ¥å¡ç‰‡ - çº¢æ©™è“åˆ†çº§è®¾è®¡ */
.priority-notification-card {
  background: white;
  border-radius: 10px;
  padding: 18px;
  cursor: pointer;
  transition: all 0.3s ease;
  border: 2px solid transparent;
  position: relative;
  overflow: hidden;
}

/* Level 1 ç´§æ€¥é€šçŸ¥ - çº¢è‰²ç³» */
.priority-notification-card.level-1-emergency {
  background: linear-gradient(135deg, #ffebee 0%, #fef2f2 100%);
  border-color: #f87171;
  box-shadow: 0 4px 15px rgba(248, 113, 113, 0.15);
}

.priority-notification-card.level-1-emergency:hover {
  border-color: #dc2626;
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(220, 38, 38, 0.2);
}

.priority-notification-card.level-1-emergency::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: linear-gradient(180deg, #dc2626 0%, #f87171 100%);
}

/* Level 2 é‡è¦é€šçŸ¥ - æ©™è‰²ç³» */
.priority-notification-card.level-2-important {
  background: linear-gradient(135deg, #fff8e1 0%, #fffbeb 100%);
  border-color: #fbbf24;
  box-shadow: 0 4px 15px rgba(251, 191, 36, 0.15);
}

.priority-notification-card.level-2-important:hover {
  border-color: #d97706;
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(217, 119, 6, 0.2);
}

.priority-notification-card.level-2-important::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: linear-gradient(180deg, #d97706 0%, #fbbf24 100%);
}

/* Level 3 å¸¸è§„é€šçŸ¥ - è“è‰²ç³» */
.priority-notification-card.level-3-regular {
  background: linear-gradient(135deg, #e3f2fd 0%, #f0f9ff 100%);
  border-color: #60a5fa;
  box-shadow: 0 4px 15px rgba(96, 165, 250, 0.15);
}

.priority-notification-card.level-3-regular:hover {
  border-color: #2563eb;
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(37, 99, 235, 0.2);
}

.priority-notification-card.level-3-regular::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: linear-gradient(180deg, #2563eb 0%, #60a5fa 100%);
}

/* é€šçŸ¥å†…å®¹æ ·å¼ */
.notification-priority-content {
  position: relative;
  z-index: 2;
}

.notification-header-row {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 10px;
  gap: 12px;
}

.notification-title-priority {
  font-size: 15px;
  font-weight: 600;
  color: #1f2937;
  line-height: 1.4;
  flex: 1;
  min-width: 0;
}

.notification-actions {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-shrink: 0;
}

.mark-read-btn {
  min-width: 60px;
  height: 28px;
}

.notification-summary-priority {
  color: #6b7280;
  font-size: 13px;
  line-height: 1.6;
  margin-bottom: 10px;
  padding: 8px 12px;
  background: rgba(255, 255, 255, 0.7);
  border-radius: 6px;
  border-left: 3px solid #e5e7eb;
}

.notification-meta-priority {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 12px;
  color: #9ca3af;
}

.notification-publisher-priority {
  font-weight: 500;
  color: #374151;
}

.show-more-priority {
  text-align: center;
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid rgba(59, 130, 246, 0.1);
}

/* ğŸ“š ä»Šæ—¥è¯¾ç¨‹å®‰æ’æ¨¡å— */
.course-module {
  border-left: 4px solid #3b82f6;
}

.course-schedule-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.course-schedule-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  border-radius: 8px;
  transition: all 0.3s ease;
  background: rgba(255, 255, 255, 0.6);
}

.course-schedule-item:hover {
  background: rgba(59, 130, 246, 0.05);
  transform: translateX(4px);
}

.course-schedule-item.course-completed {
  opacity: 0.7;
  background: rgba(156, 163, 175, 0.1);
}

.course-schedule-item.course-current {
  background: rgba(251, 191, 36, 0.1);
  border-left: 3px solid #fbbf24;
  animation: pulse 2s infinite;
}

.course-schedule-item.course-upcoming {
  background: rgba(34, 197, 94, 0.1);
  border-left: 3px solid #22c55e;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.8; }
}

.course-time-info {
  font-size: 12px;
  font-weight: 500;
  color: #374151;
  min-width: 80px;
  text-align: center;
  background: rgba(59, 130, 246, 0.1);
  padding: 4px 8px;
  border-radius: 4px;
}

.course-details {
  flex: 1;
}

.course-name-main {
  font-size: 14px;
  font-weight: 600;
  color: #1f2937;
  margin-bottom: 2px;
}

.course-location-teacher {
  font-size: 12px;
  color: #6b7280;
}

/* ğŸ“ å¾…åŠäº‹åŠ¡æ¨¡å— */
.todo-module {
  border-left: 4px solid #f59e0b;
}

.todo-tasks-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.todo-task-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  border-radius: 8px;
  transition: all 0.3s ease;
  background: rgba(255, 255, 255, 0.6);
  position: relative;
}

.todo-task-item:hover {
  background: rgba(245, 158, 11, 0.05);
  transform: translateX(4px);
}

.todo-task-item.task-completed {
  opacity: 0.6;
  background: rgba(34, 197, 94, 0.1);
}

.todo-task-item.task-urgent {
  background: rgba(239, 68, 68, 0.1);
  border-left: 3px solid #ef4444;
  animation: urgentPulse 3s infinite;
}

@keyframes urgentPulse {
  0%, 100% { border-left-color: #ef4444; }
  50% { border-left-color: #dc2626; }
}

.task-priority-indicator {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 12px;
  height: 12px;
}

.priority-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  transition: all 0.3s ease;
}

.priority-dot.priority-high {
  background: #ef4444;
  box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
}

.priority-dot.priority-medium {
  background: #f59e0b;
  box-shadow: 0 0 8px rgba(245, 158, 11, 0.4);
}

.priority-dot.priority-low {
  background: #10b981;
  box-shadow: 0 0 6px rgba(16, 185, 129, 0.3);
}

.task-content {
  flex: 1;
}

.task-title-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 4px;
}

.task-name {
  font-size: 14px;
  font-weight: 500;
  color: #1f2937;
}

.task-name.completed-task {
  text-decoration: line-through;
  color: #9ca3af;
}

.urgent-tag {
  font-size: 10px;
  padding: 2px 6px;
  height: auto;
  line-height: 1;
}

.task-deadline {
  font-size: 12px;
  color: #6b7280;
}

.task-checkbox {
  margin-left: auto;
}

/* ğŸ’¬ Level 4 é€šçŸ¥æ¶ˆæ¯æ¨¡å— */
.level4-module {
  border-left: 4px solid #10b981;
}

.level4-messages-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.level4-message-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  background: rgba(16, 185, 129, 0.05);
  border: 1px solid rgba(16, 185, 129, 0.1);
}

.level4-message-item:hover {
  background: rgba(16, 185, 129, 0.1);
  border-color: rgba(16, 185, 129, 0.2);
  transform: translateX(4px);
}

.level4-icon {
  flex-shrink: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(16, 185, 129, 0.1);
  border-radius: 50%;
}

.level4-content {
  flex: 1;
}

.level4-title {
  font-size: 13px;
  font-weight: 500;
  color: #1f2937;
  margin-bottom: 2px;
  line-height: 1.3;
}

.level4-time {
  font-size: 11px;
  color: #6b7280;
}

.level4-action {
  flex-shrink: 0;
}

/* å³ä¾§æ ¡å›­èµ„è®¯åŒº - ç°ä»£åŒ–å¡ç‰‡ */
.campus-news {
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(10px);
  border-radius: 16px;
  box-shadow: 0 8px 32px rgba(30, 58, 138, 0.08);
  border: 1px solid rgba(59, 130, 246, 0.1);
  padding: 24px;
  height: fit-content;
  transition: all 0.3s ease;
}

.campus-news:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 40px rgba(30, 58, 138, 0.12);
}

.news-content {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.news-card {
  border: 1px solid rgba(59, 130, 246, 0.1);
  border-radius: 12px;
  padding: 20px;
  background: linear-gradient(135deg, rgba(240, 249, 255, 0.5) 0%, rgba(255, 255, 255, 0.8) 100%);
  transition: all 0.3s ease;
}

.news-card:hover {
  border-color: rgba(59, 130, 246, 0.2);
  box-shadow: 0 4px 15px rgba(59, 130, 246, 0.1);
  transform: translateY(-1px);
}

.news-card h4 {
  margin: 0 0 12px 0;
  font-size: 14px;
  color: #262626;
}

.news-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.news-item {
  display: flex;
  gap: 12px;
  align-items: flex-start;
}

.news-image {
  width: 60px;
  height: 40px;
  border-radius: 4px;
  object-fit: cover;
  flex-shrink: 0;
}

.news-info {
  flex: 1;
  min-width: 0;
}

.news-title {
  font-size: 13px;
  color: #262626;
  line-height: 1.3;
  margin-bottom: 4px;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.news-time {
  font-size: 11px;
  color: #8c8c8c;
}

.announcement-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* åˆ é™¤é‡å¤çš„announcement-titleå’Œannouncement-timeå®šä¹‰ï¼Œä½¿ç”¨åé¢åˆå¹¶çš„ç‰ˆæœ¬ */

.service-info-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.service-info-item {
  display: flex;
  align-items: center;
  gap: 12px;
}

.info-content {
  flex: 1;
}

.info-title {
  font-size: 13px;
  color: #262626;
  line-height: 1.2;
  margin-bottom: 2px;
}

.info-desc {
  font-size: 11px;
  color: #8c8c8c;
  line-height: 1.2;
}

/* è°ƒè¯•é¢æ¿ */
.debug-panel {
  position: fixed;
  bottom: 20px;
  right: 20px;
  display: flex;
  gap: 8px;
  background: white;
  padding: 12px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  z-index: 1000;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 1024px) {
  .portal-main {
    grid-template-columns: 1fr;
    gap: 16px;
  }
  
  .stats-row {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 768px) {
  .header-content {
    padding: 0 16px;
  }
  
  .portal-main {
    padding: 0 16px;
  }
  
  .welcome-banner {
    padding: 16px;
  }
  
  .greeting {
    font-size: 18px;
  }
  
  .brand-title {
    font-size: 16px;
  }
  
  .user-details {
    display: none;
  }
}

/* é€šçŸ¥å¯¹è¯æ¡†æ ·å¼ */
.notification-more {
  text-align: center;
  padding: 8px 0;
  border-top: 1px solid #eee;
  margin-top: 8px;
}

.notification-dialog .notification-filters {
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
  align-items: center;
}

.notification-dialog .notification-table {
  margin-bottom: 16px;
}

.notification-dialog .notification-pagination {
  display: flex;
  justify-content: center;
}

.notification-detail .notification-meta {
  background: #f5f7fa;
  padding: 16px;
  border-radius: 8px;
  margin-bottom: 16px;
}

.notification-detail .meta-row {
  display: flex;
  align-items: center;
  margin-bottom: 8px;
}

.notification-detail .meta-row:last-child {
  margin-bottom: 0;
}

.notification-detail .meta-label {
  font-weight: 500;
  width: 80px;
  color: #606266;
}

.notification-detail .notification-content-detail {
  line-height: 1.6;
}

/* æ ¼å¼åŒ–å†…å®¹æ ·å¼ - æ”¯æŒæ¢è¡Œå’Œç¾è§‚æ ¼å¼ */
.formatted-content {
  white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œå’Œç©ºæ ¼ */
  word-wrap: break-word; /* é•¿å•è¯æ¢è¡Œ */
  line-height: 1.8; /* å¢åŠ è¡Œé«˜æå‡å¯è¯»æ€§ */
  font-size: 14px;
  color: #333;
}

.notification-detail .content-text {
  background: #fff;
  padding: 20px;
  border: 1px solid #eee;
  border-radius: 8px;
  white-space: pre-wrap; /* å…³é”®ï¼šä¿ç•™æ¢è¡Œç¬¦æ ¼å¼ */
  word-wrap: break-word;
  color: #333;
  line-height: 1.8; /* æå‡è¡Œé«˜ */
  font-size: 14px;
  max-height: 400px; /* é™åˆ¶æœ€å¤§é«˜åº¦ */
  overflow-y: auto; /* è¶…å‡ºæ»šåŠ¨ */
}

/* ä¼˜å…ˆé€šçŸ¥å·¥ä½œå°æ ·å¼(ç»Ÿä¸€è®¾è®¡) */
.priority-notification-section {
  margin-bottom: 20px;
}

/* ç´§æ€¥é€šçŸ¥å·¥ä½œå°æ ·å¼ */
.emergency-workspace-card {
  background: linear-gradient(135deg, #fee2e2, #fef2f2);
  border: 2px solid #fca5a5;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 4px 12px rgba(248, 113, 113, 0.15);
}

/* é‡è¦é€šçŸ¥å·¥ä½œå°æ ·å¼ */
.important-workspace-card {
  background: linear-gradient(135deg, #fef3c7, #fffbeb);
  border: 2px solid #fcd34d;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 4px 12px rgba(251, 191, 36, 0.15);
}

/* é€šçŸ¥å·¥ä½œå°å¤´éƒ¨(é€šç”¨) */
.notification-workspace-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.notification-workspace-header h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
}

.emergency-workspace-card .notification-workspace-header h3 {
  color: #dc2626;
}

.important-workspace-card .notification-workspace-header h3 {
  color: #d97706;
}

/* é€šçŸ¥åˆ—è¡¨(é€šç”¨) */
.notification-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* é€šçŸ¥é¡¹(é€šç”¨) */
.notification-workspace-item {
  background: white;
  border-radius: 8px;
  padding: 16px;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* ç´§æ€¥é€šçŸ¥é¡¹æ ·å¼ */
.emergency-item {
  border: 1px solid #fca5a5;
}

.emergency-item:hover {
  border-color: #dc2626;
  box-shadow: 0 2px 8px rgba(220, 38, 38, 0.15);
  transform: translateY(-1px);
}

/* é‡è¦é€šçŸ¥é¡¹æ ·å¼ */
.important-item {
  border: 1px solid #fcd34d;
}

.important-item:hover {
  border-color: #d97706;
  box-shadow: 0 2px 8px rgba(217, 119, 6, 0.15);
  transform: translateY(-1px);
}

/* é€šçŸ¥å†…å®¹(é€šç”¨) */
.notification-content-main {
  flex: 1;
  min-width: 0;
}

.notification-title-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.notification-title {
  font-weight: 600;
  font-size: 15px;
  margin-right: 12px;
}

.emergency-title {
  color: #dc2626;
}

.important-title {
  color: #d97706;
}

.notification-summary {
  color: #666;
  font-size: 13px;
  line-height: 1.5;
  margin-bottom: 8px;
  padding: 6px 10px;
  background: rgba(255, 255, 255, 0.7);
  border-radius: 4px;
  white-space: pre-line; /* æ”¯æŒæ¢è¡Œ */
  word-wrap: break-word;
  display: -webkit-box;
  -webkit-line-clamp: 2; /* å·¥ä½œå°æ˜¾ç¤ºæœ€å¤š2è¡Œ */
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.notification-meta {
  display: flex;
  gap: 16px;
  font-size: 12px;
  color: #999;
}

.notification-publisher {
  font-weight: 500;
}

.notification-action-btn {
  margin-left: 16px;
  flex-shrink: 0;
}

/* æŸ¥çœ‹æ›´å¤šæŒ‰é’® */
.show-more-notifications {
  text-align: center;
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid #fcd34d;
}

/* å¸¸è§„ç»Ÿè®¡åŒºåŸŸæ ·å¼è°ƒæ•´ */
.stats-section {
  margin-bottom: 20px;
}

/* åŸæœ‰ç´§æ€¥é€šçŸ¥æ¨ªå¹…æ ·å¼åˆ é™¤ */

/* é€šçŸ¥å…¬å‘Šé¡¹æ ·å¼ - åˆå¹¶ç‰ˆæœ¬ï¼Œé¿å…å†²çª */
.announcement-item {
  display: flex;
  flex-direction: column;
  gap: 4px;
  cursor: pointer;
  transition: all 0.3s ease;
  padding: 16px;
  border-radius: 12px;
  border: 1px solid rgba(59, 130, 246, 0.1);
  margin-bottom: 12px;
  background: linear-gradient(135deg, rgba(240, 249, 255, 0.4) 0%, rgba(255, 255, 255, 0.8) 100%);
}

.announcement-item:hover {
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(16, 185, 129, 0.05) 100%);
  transform: translateX(4px);
  border-color: rgba(59, 130, 246, 0.2);
  box-shadow: 0 4px 15px rgba(59, 130, 246, 0.1);
}

.announcement-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}

.announcement-title {
  font-weight: 600;
  color: #262626;
  font-size: 14px;
  line-height: 1.4;
  margin-bottom: 4px;
}

.announcement-summary,
.announcement-content-preview {
  font-size: 13px;
  color: #666;
  line-height: 1.5;
  margin-top: 8px;
  padding: 8px 12px;
  background: #f8f9fa;
  border-radius: 6px;
  border-left: 3px solid #e9ecef;
  white-space: pre-line; /* æ”¯æŒæ¢è¡Œä½†ä¸ä¿ç•™å¤šä½™ç©ºæ ¼ */
  word-wrap: break-word;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 3; /* æœ€å¤šæ˜¾ç¤º3è¡Œ */
  -webkit-box-orient: vertical;
}

.announcement-time {
  font-size: 11px;
  color: #999;
}

.no-announcements {
  text-align: center;
  padding: 20px;
  color: #999;
}
</style>