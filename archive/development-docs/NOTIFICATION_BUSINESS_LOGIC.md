# 通知系统业务逻辑详细规范

## 🏢 完整角色权限体系

### 校级管理层
| 角色 | 权限范围 | 通知类型 | 发布时效 | 审批要求 |
|-----|----------|----------|----------|----------|
| **校长** | 全校所有用户 | 全部四级通知 | 即时发布 | 无需审批 |
| **副校长** | 分管领域用户 | 全部四级通知 | 即时发布 | 校长备案 |
| **教务处长** | 教学相关人员 | 全部四级通知 | 即时发布 | 无需审批 |
| **学生处长** | 全体学生 | 重要+常规+提醒 | 即时发布 | 无需审批 |

### 学院管理层
| 角色 | 权限范围 | 通知类型 | 发布时效 | 审批要求 |
|-----|----------|----------|----------|----------|
| **院长** | 全院师生 | 全部四级通知 | 即时发布 | 无需审批 |
| **副院长** | 分管领域 | 重要+常规+提醒 | 即时发布 | 院长备案 |
| **党委书记** | 全院师生 | 重要+常规+提醒 | 即时发布 | 无需审批 |
| **党委副书记** | 学生工作 | 重要+常规+提醒 | 即时发布 | 书记备案 |

### 行政执行层
| 角色 | 权限范围 | 通知类型 | 发布时效 | 审批要求 |
|-----|----------|----------|----------|----------|
| **教学秘书** | 教学相关 | 常规+提醒 | 即时发布 | 系主任审批 |
| **科研秘书** | 科研相关 | 常规+提醒 | 即时发布 | 院长审批 |
| **行政秘书** | 行政事务 | 常规+提醒 | 即时发布 | 院长审批 |
| **团委书记** | 团员学生 | 重要+常规+提醒 | 2小时内 | 党委副书记审批 |

### 教学执行层
| 角色 | 权限范围 | 通知类型 | 发布时效 | 审批要求 |
|-----|----------|----------|----------|----------|
| **系主任** | 全系师生 | 重要+常规+提醒 | 即时发布 | 院长备案 |
| **教研室主任** | 教研室内 | 常规+提醒 | 即时发布 | 系主任备案 |
| **任课教师** | 所授课程学生 | 常规+提醒 | 即时发布 | 无需审批 |
| **实验教师** | 实验课程学生 | 常规+提醒 | 即时发布 | 无需审批 |

### 学生管理层
| 角色 | 权限范围 | 通知类型 | 发布时效 | 审批要求 |
|-----|----------|----------|----------|----------|
| **年级主任** | 全年级学生 | 重要+常规+提醒 | 即时发布 | 学生处长备案 |
| **年级组长** | 年级组内 | 重要+常规+提醒 | 即时发布 | 年级主任备案 |
| **辅导员** | 所带班级 | 常规+提醒 | 即时发布 | 年级主任备案 |
| **班主任** | 所带班级 | 常规+提醒 | 即时发布 | 辅导员备案 |

### 学生组织层
| 角色 | 权限范围 | 通知类型 | 发布时效 | 审批要求 |
|-----|----------|----------|----------|----------|
| **学生会主席** | 全体学生 | 常规+提醒 | 4小时内 | 团委书记审批 |
| **学生会部长** | 相关部门 | 常规+提醒 | 即时发布 | 主席团审批 |
| **班长** | 本班学生 | 常规+提醒 | 即时发布 | 班主任备案 |
| **团支书** | 本班团员 | 常规+提醒 | 即时发布 | 班主任备案 |

---

## 📊 通知类型细分规则

### 🔴 紧急通知详细分类

#### 一级紧急（全校停课）
- **发布者**: 校长、副校长、教务处长
- **推送范围**: 全校师生+家长+合作单位
- **推送渠道**: APP+短信+邮件+官网+广播
- **确认要求**: 100%确认率，未确认每30分钟提醒一次
- **模板示例**: 
  ```
  【紧急停课通知】
  因极端天气影响，学校决定今日全面停课。
  请所有学生立即返回宿舍，教职工做好安全防护。
  恢复上课时间另行通知。
  发布时间：2024-07-25 08:00
  校长办公室
  ```

#### 二级紧急（学院停课）
- **发布者**: 院长、副院长
- **推送范围**: 全院师生
- **推送渠道**: APP+站内信
- **确认要求**: 95%确认率
- **模板示例**:
  ```
  【学院紧急通知】
  因设备检修，今日下午软件学院所有实验课程暂停。
  理论课程正常进行，请相互转告。
  软件学院办公室
  ```

### 🟠 重要通知详细分类

#### 缴费通知
- **发布者**: 财务处、辅导员
- **推送时机**: 缴费开始前7天、前3天、前1天
- **推送范围**: 应缴费学生
- **模板示例**:
  ```
  【学费缴纳提醒】
  2024-2025学年学费缴纳即将开始
  金额：5800元
  截止日期：2024年8月31日
  缴费方式：校园网->财务系统->在线缴费
  咨询电话：0451-12345678
  ```

#### 奖助申请通知
- **发布者**: 学生处、辅导员
- **推送时机**: 申请开始前5天、前1天
- **推送范围**: 符合条件学生
- **模板示例**:
  ```
  【国家奖学金申请】
  申请条件：成绩排名前10%，无违纪记录
  奖励金额：8000元
  申请时间：9月1日-9月15日
  申请材料：成绩单+申请表+获奖证书
  提交地点：辅导员办公室
  ```

### 🔵 常规通知详细分类

#### 作业布置通知
- **发布者**: 任课教师
- **推送范围**: 选课学生
- **模板示例**:
  ```
  【数据结构作业】
  作业内容：实现二叉树遍历算法
  提交要求：源代码+实验报告
  截止时间：7月30日 23:59
  提交方式：学习平台->课程作业
  ```

#### 课程调整通知
- **发布者**: 任课教师、教学秘书
- **推送范围**: 相关学生
- **模板示例**:
  ```
  【课程调整通知】
  原安排：7月26日 10:00-12:00 《数据库原理》
  调整为：7月27日 14:00-16:00 地点：A301
  原因：教师出差
  请同学们相互转告
  ```

### ⚪ 提醒通知详细分类

#### 上课提醒
- **触发条件**: 课程开始前30分钟
- **推送范围**: 选课学生
- **模板示例**:
  ```
  【上课提醒】
  课程：高等数学
  时间：10:00-11:40
n  地点：教学楼B205
  携带：教材、练习册、计算器
  ```

#### 作业截止提醒
- **触发条件**: 截止前2小时
- **推送范围**: 未提交学生
- **模板示例**:
  ```
  【作业即将截止】
  作业：Web开发实验报告
  截止时间：今天 23:59
  状态：未完成
  请尽快提交！
  ```

---

## 🔄 业务流程时序图

### 紧急通知发布流程
```
触发者 → 系统验证 → 权限检查 → 内容审核 → 多渠道推送 → 用户确认 → 统计报告
校长    → 登录验证 → 角色权限 → 免审批  → 全渠道推送 → 强制确认 → 确认率统计
```

### 重要通知发布流程
```
辅导员 → 内容编辑 → 权限验证 → 上级审批 → 定向推送 → 用户查看 → 效果跟踪
      → 填写通知 → 角色检查 → 年级主任 → 目标学生 → 阅读统计 → 未读提醒
```

### 通知阅读流程
```
学生 → 打开首页 → 身份识别 → 获取通知 → 展示排序 → 点击查看 → 状态更新
    → 登录系统 → 角色判定 → 权限过滤 → 优先级排序 → 详情页面 → 已读标记
```

---

## 📈 数据统计与分析

### 实时统计指标
- **通知送达率**: (成功推送数/目标用户数) × 100%
- **阅读完成率**: (已读用户数/推送用户数) × 100%
- **确认完成率**: (确认用户数/需确认用户数) × 100%
- **平均响应时间**: 从发布到确认的平均时间

### 用户行为分析
- **活跃时间段**: 用户查看通知的高峰时段
- **偏好通知类型**: 不同类型通知的阅读率对比
- **设备使用偏好**: 移动端vs桌面端使用比例
- **地域分布**: 不同校区/宿舍的通知响应差异

### 预警机制
- **送达率低于90%**: 触发二次推送
- **确认率低于80%**: 启动人工电话确认
- **响应时间超过2小时**: 升级为紧急处理
- **异常访问模式**: 记录可疑行为并上报

---

## 🛡️ 异常处理机制

### 网络异常处理
```
用户离线 → 本地缓存 → 网络恢复 → 自动同步 → 状态更新
         → 保存通知 → 检测网络 → 推送数据 → 更新状态
```

### 权限异常处理
```
越权访问 → 权限验证 → 拒绝访问 → 记录日志 → 管理员通知
         → 角色检查 → 返回403 → 异常记录 → 安全警告
```

### 数据异常处理
```
数据错误 → 格式验证 → 错误提示 → 数据修正 → 重新推送
         → 内容检查 → 用户提示 → 人工处理 → 状态恢复
```

---

## 📝 业务规则验证清单

### 发布前验证
- [ ] 发布者身份验证通过
- [ ] 权限范围符合角色要求
- [ ] 通知内容格式正确
- [ ] 目标用户群体明确
- [ ] 紧急程度分类准确

### 推送时验证
- [ ] 推送渠道选择正确
- [ ] 目标用户范围准确
- [ ] 推送时间符合规范
- [ ] 确认机制设置合理
- [ ] 过期时间计算正确

### 展示时验证
- [ ] 用户权限过滤正确
- [ ] 排序算法执行准确
- [ ] 状态标记更新及时
- [ ] 阅读统计记录完整
- [ ] 异常处理机制生效

这套完整的业务逻辑覆盖了教育场景下通知系统的所有关键业务环节，确保系统运行的可靠性和用户体验的优化。

**学校现有项目概述（School API）**

这是一个功能非常全面的校园综合管理系统后端API，基于Java的Spring Boot框架开发，并整合了Dubbo RPC框架，表明它可能是一个微服务架构中的核心服务。系统涵盖了学生、教师、课程、成绩、考务、教评、作业、宿舍、后勤报修、人事管理等多个方面，并与钉钉（DingTalk）进行了深度集成，用于审批流程和消息通知。

**核心功能分析**

1. **用户与权限管理 (`UserController`, `SaTokenUtil`, `StpInterfaceImpl`)**
   - 支持多种登录方式，包括账号密码、手机验证码以及钉钉等第三方登录。
   - 实现了账户绑定、换绑手机、密码修改等功能。
   - 使用Sa-Token框架进行权限认证和会话管理，实现了角色和权限控制。
   - 提供了用户信息获取、教师及全校人员的模糊搜索功能。
2. **课程与教学管理 (`CourseController`, `CourseProjectController`, `CourseArrangeController`)**
   - **课程计划与开课**：支持课程计划的创建、查询、更新和删除，区分必修与选修课程。
   - **排课管理**：实现了对课程的排课、调课、代课、停课和补课功能，并集成了钉钉审批流。
   - **课程作业**：支持创建不同类型的作业（文档、题库、编程），并能对学生提交的作业进行批改和统计。
   - **选课系统**：提供了学生选课、退课、查询已选课程以及导入选课名单等功能。
3. **考试与成绩管理 (`ExamController`, `StudentCourseController`)**
   - **考务管理**：支持创建和管理考试安排。
   - **成绩录入与管理**：支持手动、批量、通过Excel导入等多种方式录入学生成绩，并能对成绩进行更新和删除。
   - **成绩查询与导出**：学生和教师可以查询成绩，并支持导出多种格式的成绩单和分析报告。
   - **成绩分析**：能够对课程、班级、学院等多个维度进行成绩分析，并生成图表。
4. **评教与评学系统 (`PingJiaoController`)**
   - 实现了学生对教师的评教和教师对班级的评学功能，包括问卷的提交、查询和成绩分析。
   - 支持导出评教评学数据，便于进一步分析。
5. **题库与编程题系统 (`QuestionBankController`, `ProgramController`)**
   - **题库管理**：支持创建和管理题库，以及对题库中的试题（单选、多选、判断等）进行增删改查。
   - **编程题判题**：集成了消息队列（RabbitMQ），可以对学生提交的编程题代码进行在线判题（Judge）。
6. **人事与后勤管理 (`HRMController`, `DormController`, `GoodsController`, `RepairController`)**
   - **人事管理(HRM)**：包含了教师信息的录入、审核、查询、离职管理等功能，并支持身份证OCR识别。
   - **宿舍管理**：实现了对宿舍楼、寝室、床位的管理，以及查寝计划的制定和审批。
   - **物品/耗材管理**：提供了物品库存、出库记录的管理，并支持数据的导入导出。
   - **后勤报修**：实现了报修工单的统计与数据分析功能。

**技术架构与特点**

- **微服务架构**：使用Dubbo作为RPC框架，表明系统被拆分为多个独立的服务，`School_API`是其中的一个核心业务服务。
- **前后端分离**：从Controller层的代码来看，API都返回统一的`BaseResponse`格式，这是典型的前后端分离架构。
- **缓存策略**：深度整合了Redis，使用Redisson客户端，并自定义了`SpringCacheManager`，对常用数据（如评教信息、字典数据等）进行了缓存，以提升系统性能。
- **异步处理**：通过RabbitMQ实现了编程题判题和试卷提交等耗时操作的异步处理，提高了系统的响应速度和并发能力。
- **钉钉集成**：广泛使用钉钉的API，将调课、查寝、成绩重置等业务流程与钉钉审批打通，实现了办公自动化。
- **代码生成与模板化**：项目中包含了代码生成器（`CodeGenerator`）和大量的FreeMarker模板（`.ftl`文件），用于快速生成Controller, Service, DTO, VO等模板代码，提高了开发效率。
- **策略模式**：在多个业务场景（如开课、作业类型、工作流处理等）中使用了策略模式，使得系统更容易扩展和维护。
- **安全性**：集成了Sa-Token进行权限控制，并实现了XSS过滤器，增强了系统的安全性。



### **当前需求**

依托现有的 “School API” 项目，创建一个**完全独立且平行**的高校通知系统。这个新系统将拥有自己的后端服务和前端界面，但在用户认证方面，它需要**复用 “School API” 的统一认证登录入口**，即用户使用同一套账号密码登录两个系统。

### **解决方案与实施步骤**

这是一种常见的微服务架构模式，即**中央认证服务**模式。在这种模式下，“School API” 将扮演认证中心的角色，而新建的通知系统将作为业务服务，信任由认证中心颁发的凭证。

以下是如何实现这一目标的详细步骤和需要调用的关键API：

#### **核心思路**

1. **保持独立**：新的通知系统拥有自己独立的数据库、后端服务和前端应用，不与 “School API” 共享业务代码或数据库表。
2. **认证委托**：通知系统的前端登录页面，在用户提交登录请求时，将用户名和密码等凭据发送给**现有的 “School API” 的登录接口**进行验证。
3. **令牌（Token）驱动**：
   - “School API” 验证成功后，会生成一个令牌（Token），并返回给通知系统的前端。
   - 通知系统的前端在后续所有对**自身后端**的请求中，都需要携带这个令牌。
   - 通知系统的后端需要建立一个机制来**验证**这个令牌的有效性，从而确认用户的登录状态和身份。

#### **需要调用的关键API**

您的新通知系统**只需要调用 “School API” 中的用户登录相关接口**来完成认证。

1. **主登录接口 (`/user/login`)**
   - **API路径**: `POST /api/user/login`
   - **功能**: 这是核心的账号密码登录接口。
   - **调用方式**: 通知系统的前端登录页面，将用户输入的**学号/工号**、**密码**和**图形验证码** 发送到这个API。
   - **成功响应**: 如果验证成功，API会返回一个包含 `token` 的 `UserVO` 对象。您的前端需要保存这个 `token`。
2. **图形验证码接口 (`/user/captcha`)**
   - **API路径**: `POST /api/user/captcha`
   - **功能**: 获取登录所需的图形验证码。
   - **调用方式**: 在显示登录页面时，前端需要先调用此接口获取验证码图片（Base64编码）并展示。
3. **（可选）手机验证码登录接口 (`/user/login/byPhone`)**
   - **API路径**: `POST /api/user/login/byPhone`
   - **功能**: 如果您的新系统也希望支持手机号+验证码登录，可以调用此接口。
   - **依赖接口**: 需要先调用 `POST /api/user/code` 来发送手机验证码。

#### **实施架构与步骤**

**第1步：新通知系统的后端建设**

- **创建独立服务**：使用您熟悉的技术栈（例如Java Spring Boot）创建一个全新的、独立部署的后端服务。
- **创建数据库**：为通知系统设计并创建独立的数据库，包含通知表、已读记录表等。
- **开发业务API**：开发新系统自身的业务API，例如：
  - `POST /api/notifications` (发布新通知)
  - `GET /api/notifications` (获取通知列表)
  - `POST /api/notifications/{id}/read` (标记通知为已读)
- **建立Token验证拦截器**：这是关键。您需要在通知系统的后端创建一个拦截器（Interceptor）或过滤器（Filter），对所有需要登录才能访问的API进行保护。
  - 该拦截器会从请求头（`Authorization` Header）中获取前端传来的 `token`。
  - **验证Token有效性**: 拦截器需要调用 "School API" 提供的一个**用户信息接口**（`POST /api/user/info`），并附上这个 `token`。
    - 如果该接口成功返回用户信息，说明 `token` 有效，用户已登录。此时，您可以将用户信息（如用户ID、姓名、角色）保存在当前请求的上下文中，以便后续业务使用。
    - 如果该接口返回未登录或错误信息（例如 401 Unauthorized），说明 `token` 无效或已过期，应拒绝访问。

**第2步：新通知系统的前端建设**

- **创建独立前端项目**：使用Vue、React等框架创建一个新的前端应用。
- **构建登录页面**：
  1. 页面加载时，调用 "School API" 的 `POST /api/user/captcha` 获取验证码并显示。
  2. 用户填写学号、密码和验证码后，点击登录按钮。
  3. 前端将这些信息**直接发送给 "School API" 的 `POST /api/user/login` 接口**。
  4. 如果登录成功，前端会收到一个包含 `token` 的响应。将这个 `token` 存储在本地（如 LocalStorage 或 Vuex/Redux）。
  5. 登录失败则显示错误提示。
- **API请求封装**：
  - 封装一个API请求工具（如 Axios）。
  - 设置一个请求拦截器，在每次**向通知系统后端发送请求时**，自动从本地存储中读取 `token`，并将其放入请求的 `Authorization` Header 中（通常格式为 `Bearer <token>`）。

**第3步：“School API” 的配合**

根据现有代码分析，“School API” **几乎不需要做任何改动**。它的 `login` 和 `info` 接口已经能够支持这种外部调用模式。您唯一需要确保的是：

- **跨域配置（CORS）**：在 `School_API/src/main/java/com/hiit/config/CorsConfig.java` 文件中，确保新通知系统前端应用的域名被加入了允许跨域访问的白名单（`allowedOrigins` 或 `allowedOriginPatterns`）。

