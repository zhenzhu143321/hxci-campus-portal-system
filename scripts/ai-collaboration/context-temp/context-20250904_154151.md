# AIåä½œä»£ç ä¸Šä¸‹æ–‡æŠ¥å‘Š

ç”Ÿæˆæ—¶é—´: 2025-09-04 15:41:51
é¡¹ç›®: å“ˆå°”æ»¨ä¿¡æ¯å·¥ç¨‹å­¦é™¢æ ¡å›­é—¨æˆ·ç³»ç»Ÿ
æŠ€æœ¯æ ˆ: Spring Boot 3.4.5 + Vue 3

## ğŸ“¦ æ”¶é›†çš„æ–‡ä»¶ (1ä¸ª)

### æ–‡ä»¶: ../../yudao-boot-mini/yudao-mock-school-api/src/main/java/cn/iocoder/yudao/mock/school/controller/MockAuthController.java

```java
package cn.iocoder.yudao.mock.school.controller;

import cn.iocoder.yudao.mock.school.dto.*;
import cn.iocoder.yudao.mock.school.service.MockSchoolUserService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import jakarta.validation.Valid;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * Mock School è®¤è¯æ§åˆ¶å™¨
 * æä¾›ç”¨æˆ·tokenéªŒè¯å’Œæƒé™æŸ¥è¯¢æ¥å£
 * 
 * @author Claude
 */
@RestController
@RequestMapping("/mock-school-api/auth")
@Validated
public class MockAuthController {

    private static final Logger log = LoggerFactory.getLogger(MockAuthController.class);

    @Autowired
    private MockSchoolUserService userService;

    /**
     * ç”¨æˆ·è®¤è¯æ¥å£ï¼ˆæ”¯æŒç”¨æˆ·åå¯†ç ç™»å½•å’Œå·¥å·+å§“å+å¯†ç ç™»å½•ï¼‰
     * POST /mock-school-api/auth/authenticate
     */
    @PostMapping("/authenticate")
    public MockApiResponse<UserInfo> authenticate(@RequestBody AuthenticateRequest request) {
        log.info("æ”¶åˆ°ç”¨æˆ·è®¤è¯è¯·æ±‚: employeeId={}, name={}, username={}", 
                request.getEmployeeId(), request.getName(), request.getUsername());
        
        try {
            // æ‰‹åŠ¨éªŒè¯å¯†ç 
            if (request.getPassword() == null || request.getPassword().trim().isEmpty()) {
                return MockApiResponse.badRequest("å¯†ç ä¸èƒ½ä¸ºç©º");
            }
            
            UserInfo userInfo = null;
            
            // ä¼˜å…ˆä½¿ç”¨å·¥å·+å§“å+å¯†ç ç™»å½•æ–¹å¼ï¼ˆæ–°æ–¹å¼ï¼‰
            if (request.getEmployeeId() != null && !request.getEmployeeId().trim().isEmpty() &&
                request.getName() != null && !request.getName().trim().isEmpty()) {
                
                log.info("ä½¿ç”¨å·¥å·+å§“å+å¯†ç è®¤è¯æ–¹å¼: employeeId={}, name={}", 
                        request.getEmployeeId(), request.getName());
                userInfo = userService.authenticateUserByEmployeeId(
                        request.getEmployeeId(), request.getName(), request.getPassword());
            } 
            // å‘åå…¼å®¹ï¼šä½¿ç”¨ç”¨æˆ·åå¯†ç ç™»å½•æ–¹å¼ï¼ˆæ—§æ–¹å¼ï¼‰
            else if (request.getUsername() != null && !request.getUsername().trim().isEmpty()) {
                
                log.info("ä½¿ç”¨ç”¨æˆ·å+å¯†ç è®¤è¯æ–¹å¼: username={}", request.getUsername());
                userInfo = userService.authenticateUser(request.getUsername(), request.getPassword());
            }
            else {
                log.warn("è®¤è¯å‚æ•°ä¸å®Œæ•´ï¼šç¼ºå°‘å¿…è¦çš„ç™»å½•ä¿¡æ¯");
                return MockApiResponse.badRequest("è¯·æä¾›å·¥å·+å§“å+å¯†ç æˆ–ç”¨æˆ·å+å¯†ç è¿›è¡Œç™»å½•");
            }
            
            if (userInfo == null) {
                return MockApiResponse.unauthorized("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
            }
            
            log.info("ç”¨æˆ·è®¤è¯æˆåŠŸ: ç”¨æˆ·={}, è§’è‰²={}", userInfo.getUsername(), userInfo.getRoleName());
            return MockApiResponse.success(userInfo, "ç”¨æˆ·è®¤è¯æˆåŠŸ");
            
        } catch (Exception e) {
            log.error("ç”¨æˆ·è®¤è¯å¼‚å¸¸", e);
            return MockApiResponse.serverError("ç”¨æˆ·è®¤è¯æœåŠ¡å¼‚å¸¸: " + e.getMessage());
        }
    }

    /**
     * ğŸ›¡ï¸ P1.2å®‰å…¨ä¿®å¤ï¼šTokenè„±æ•å·¥å…·æ–¹æ³•
     * é˜²æ­¢å®Œæ•´Tokenåœ¨æ—¥å¿—ä¸­æ³„éœ²
     */
    private String maskToken(String token) {
        if (token == null || token.length() < 20) {
            return "***INVALID_TOKEN***";
        }
        return token.substring(0, 10) + "..." + token.substring(token.length() - 6);
    }

    /**
     * TokenéªŒè¯æ¥å£
     * POST /mock-school-api/auth/verify
     */
    @PostMapping("/verify")
    public MockApiResponse<UserInfo> verifyToken(@Valid @RequestBody TokenVerifyRequest request) {
        log.info("ğŸ” [TOKEN_VERIFY_V2] P1.2å¼ºåŒ–ç‰ˆæœ¬ï¼šæ”¶åˆ°tokenéªŒè¯è¯·æ±‚");
        log.info("ğŸ›¡ï¸ [TOKEN_VERIFY_V2] Tokenè„±æ•: {}", maskToken(request.getToken()));
        
        try {
            UserInfo userInfo = userService.verifyToken(request.getToken());
            
            if (userInfo == null) {
                return MockApiResponse.unauthorized("Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ");
            }
            
            log.info("âœ… [TOKEN_VERIFY_V2] P1.2å¼ºåŒ–TokenéªŒè¯æˆåŠŸ: ç”¨æˆ·={}, è§’è‰²={}", 
                    userInfo.getUsername(), userInfo.getRoleName());
            return MockApiResponse.success(userInfo, "TokenéªŒè¯æˆåŠŸ");
            
        } catch (Exception e) {
            log.error("âŒ [TOKEN_VERIFY_V2] TokenéªŒè¯å¼‚å¸¸", e);
            return MockApiResponse.serverError("TokenéªŒè¯æœåŠ¡å¼‚å¸¸: " + e.getMessage());
        }
    }

    // ğŸš« [REFACTORED] æƒé™ç›¸å…³æ¥å£å·²ç§»é™¤ - èŒè´£è½¬ç§»åˆ°ä¸»é€šçŸ¥æœåŠ¡
    // åŸæƒé™æŸ¥è¯¢å’ŒéªŒè¯æ¥å£å·²åˆ é™¤ï¼Œç°åœ¨ç”±ä¸»æœåŠ¡ç»Ÿä¸€å¤„ç†æƒé™é€»è¾‘

    /**
     * åˆ·æ–°ç”¨æˆ·Token
     * POST /mock-school-api/auth/refresh/{userId}
     */
    @PostMapping("/refresh/{userId}")
    public MockApiResponse<String> refreshToken(@PathVariable String userId) {
        log.info("åˆ·æ–°ç”¨æˆ·Token: {}", userId);
        
        try {
            String newToken = userService.refreshUserToken(userId);
            
            if (newToken == null) {
                return MockApiResponse.badRequest("ç”¨æˆ·ä¸å­˜åœ¨");
            }
            
            return MockApiResponse.success(newToken, "Tokenåˆ·æ–°æˆåŠŸ");
            
        } catch (Exception e) {
            log.error("Tokenåˆ·æ–°å¼‚å¸¸", e);
            return MockApiResponse.serverError("Tokenåˆ·æ–°å¼‚å¸¸: " + e.getMessage());
        }
    }

    // ğŸš« [REFACTORED] ç§»é™¤æƒé™éªŒè¯æ¥å£ - èŒè´£è½¬ç§»åˆ°ä¸»é€šçŸ¥æœåŠ¡
    // åŸ verify-permission æ¥å£å·²åˆ é™¤ï¼Œæƒé™éªŒè¯ç°åœ¨ç”±ä¸»æœåŠ¡è´Ÿè´£
    
    /**
     * ğŸ†• è·å–ç”¨æˆ·åŸºç¡€ä¿¡æ¯ï¼ˆç”¨äºä¸»æœåŠ¡æƒé™æŸ¥è¯¢ï¼‰
     * POST /mock-school-api/auth/user-info
     */
    @PostMapping("/user-info")
    public MockApiResponse<Map<String, Object>> getUserInfo(
            @RequestHeader("Authorization") String authHeader) {
        
        log.info("ğŸ‘¤ [USER_INFO] æ”¶åˆ°ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢è¯·æ±‚");
        
        try {
            // æå–Bearer Token
            String token = authHeader;
            if (authHeader != null && authHeader.startsWith("Bearer ")) {
                token = authHeader.substring(7);
            }
            
            // é€šè¿‡tokenéªŒè¯ç”¨æˆ·èº«ä»½
            UserInfo userInfo = userService.verifyToken(token);
            if (userInfo == null) {
                return MockApiResponse.unauthorized("Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ");
            }
            
            // è¿”å›ç”¨æˆ·åŸºç¡€ä¿¡æ¯ï¼ˆä¸å«æƒé™éªŒè¯é€»è¾‘ï¼‰
            Map<String, Object> responseData = new HashMap<>();
            responseData.put("employeeId", userInfo.getEmployeeId());
            responseData.put("username", userInfo.getUsername());
            responseData.put("realName", userInfo.getRealName());
            responseData.put("roleCode", userInfo.getRoleCode());
            responseData.put("roleName", userInfo.getRoleName());
            responseData.put("userType", userInfo.getUserType());
            responseData.put("departmentId", userInfo.getDepartmentId());
            responseData.put("departmentName", userInfo.getDepartmentName());
            responseData.put("gradeId", userInfo.getGradeId());
            responseData.put("classId", userInfo.getClassId());
            
            log.info("âœ… [USER_INFO] ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢æˆåŠŸ: user={}, role={}", 
                    userInfo.getEmployeeId(), userInfo.getRoleCode());
            
            return MockApiResponse.success(responseData, "ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢æˆåŠŸ");
            
        } catch (Exception e) {
            log.error("âŒ [USER_INFO] ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢å¼‚å¸¸", e);
            return MockApiResponse.serverError("ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢å¼‚å¸¸: " + e.getMessage());
        }
    }

    /**
     * ğŸ†• å­¦æ ¡ç™»å½•æ¥å£ï¼ˆåŒTokenè®¤è¯ï¼‰
     * POST /mock-school-api/auth/school-login
     * 
     * å®ç°å®Œæ•´çš„åŒTokenè®¤è¯æµç¨‹ï¼š
     * 1. è°ƒç”¨å­¦æ ¡APIéªŒè¯ç”¨æˆ·èº«ä»½
     * 2. ä¿å­˜Basic Tokenåˆ°Redis+æ•°æ®åº“
     * 3. ç”ŸæˆJWT Tokenç”¨äºç³»ç»Ÿè®¿é—®
     * 4. è¿”å›åŒTokenç»“æœ
     */
    @PostMapping("/school-login")
    public MockApiResponse<SchoolLoginResult> loginViaSchool(@Valid @RequestBody SchoolLoginRequest request) {
        log.info("ğŸ« [SCHOOL_LOGIN] æ”¶åˆ°å­¦æ ¡ç™»å½•è¯·æ±‚: employeeId={}, name={}, useRealApi={}", 
                request.getEmployeeId(), request.getName(), request.getUseRealSchoolApi());
        
        try {
            // è°ƒç”¨Serviceå±‚çš„æµç¨‹ç¼–æ’å™¨æ–¹æ³•
            SchoolLoginResult result = userService.processSchoolAuthentication(request);
            
            if (result == null || result.getJwtToken() == null) {
                return MockApiResponse.badRequest("å­¦æ ¡ç™»å½•å¤±è´¥ï¼šè®¤è¯ç»“æœä¸ºç©º");
            }
            
            log.info("ğŸ‰ [SCHOOL_LOGIN] å­¦æ ¡ç™»å½•æˆåŠŸ: employeeId={}, role={}, mode={}", 
                    result.getUserInfo().getEmployeeId(), 
                    result.getUserInfo().getRoleCode(), 
                    result.getAuthMode());
            
            return MockApiResponse.success(result, "å­¦æ ¡è®¤è¯æˆåŠŸï¼ŒåŒTokenç”Ÿæˆå®Œæˆ");
            
        } catch (SecurityException e) {
            log.error("ğŸš¨ [SCHOOL_LOGIN] å®‰å…¨éªŒè¯å¤±è´¥: {}", e.getMessage());
            return MockApiResponse.unauthorized("å­¦æ ¡ç™»å½•å¤±è´¥: " + e.getMessage());
            
        } catch (Exception e) {
            log.error("ğŸ’¥ [SCHOOL_LOGIN] å­¦æ ¡ç™»å½•å¼‚å¸¸", e);
            return MockApiResponse.serverError("å­¦æ ¡ç™»å½•æœåŠ¡å¼‚å¸¸: " + e.getMessage());
        }
    }

    /**
     * ğŸ†• è·å–Basic Tokenï¼ˆåç«¯æœåŠ¡é—´è°ƒç”¨ï¼‰
     * GET /mock-school-api/auth/basic-token/{userId}
     * 
     * ç”¨äºå…¶ä»–åç«¯æœåŠ¡è·å–ç”¨æˆ·çš„Basic Tokenæ¥è°ƒç”¨å­¦æ ¡API
     */
    @GetMapping("/basic-token/{userId}")
    public MockApiResponse<String> getBasicToken(@PathVariable String userId,
            @RequestHeader("Authorization") String authHeader) {
        log.info("ğŸ” [BASIC_TOKEN] è·å–Basic Tokenè¯·æ±‚: userId={}", userId);
        
        try {
            // éªŒè¯è¯·æ±‚è€…èº«ä»½ï¼ˆç®€åŒ–å®ç°ï¼Œå®é™…åº”è¯¥éªŒè¯æœåŠ¡é—´è°ƒç”¨æƒé™ï¼‰
            String token = authHeader;
            if (authHeader != null && authHeader.startsWith("Bearer ")) {
                token = authHeader.substring(7);
            }
            
            UserInfo requestUser = userService.verifyToken(token);
            if (requestUser == null) {
                return MockApiResponse.unauthorized("è¯·æ±‚è€…Tokenæ— æ•ˆ");
            }
            
            // è¿™é‡Œåº”è¯¥è°ƒç”¨SchoolTokenServiceè·å–Basic Token
            // ç®€åŒ–å®ç°ï¼šè¿”å›æˆåŠŸä½†æç¤ºåŠŸèƒ½å¼€å‘ä¸­
            log.info("âœ… [BASIC_TOKEN] Basic Tokenè·å–è¯·æ±‚å¤„ç†å®Œæˆï¼ˆåŠŸèƒ½å¼€å‘ä¸­ï¼‰");
            return MockApiResponse.success(null, "Basic Tokenè·å–åŠŸèƒ½å¼€å‘ä¸­");
            
        } catch (Exception e) {
            log.error("âŒ [BASIC_TOKEN] Basic Tokenè·å–å¼‚å¸¸", e);
            return MockApiResponse.serverError("Basic Tokenè·å–å¼‚å¸¸: " + e.getMessage());
        }
    }

    /**
     * ğŸ†• åˆ·æ–°Basic Token
     * POST /mock-school-api/auth/refresh-basic-token/{userId}
     * 
     * å½“Basic Tokenè¿‡æœŸæ—¶è°ƒç”¨å­¦æ ¡APIåˆ·æ–°
     */
    @PostMapping("/refresh-basic-token/{userId}")
    public MockApiResponse<String> refreshBasicToken(@PathVariable String userId,
            @RequestHeader("Authorization") String authHeader) {
        log.info("ğŸ”„ [REFRESH_BASIC_TOKEN] åˆ·æ–°Basic Tokenè¯·æ±‚: userId={}", userId);
        
        try {
            // éªŒè¯è¯·æ±‚è€…èº«ä»½
            String token = authHeader;
            if (authHeader != null && authHeader.startsWith("Bearer ")) {
                token = authHeader.substring(7);
            }
            
            UserInfo requestUser = userService.verifyToken(token);
            if (requestUser == null) {
                return MockApiResponse.unauthorized("è¯·æ±‚è€…Tokenæ— æ•ˆ");
            }
            
            // è¿™é‡Œåº”è¯¥è°ƒç”¨SchoolTokenServiceåˆ·æ–°Token
            // ç®€åŒ–å®ç°ï¼šè¿”å›æˆåŠŸä½†æç¤ºåŠŸèƒ½å¼€å‘ä¸­
            log.info("âœ… [REFRESH_BASIC_TOKEN] Basic Tokenåˆ·æ–°è¯·æ±‚å¤„ç†å®Œæˆï¼ˆåŠŸèƒ½å¼€å‘ä¸­ï¼‰");
            return MockApiResponse.success(null, "Basic Tokenåˆ·æ–°åŠŸèƒ½å¼€å‘ä¸­");
            
        } catch (Exception e) {
            log.error("âŒ [REFRESH_BASIC_TOKEN] Basic Tokenåˆ·æ–°å¼‚å¸¸", e);
            return MockApiResponse.serverError("Basic Tokenåˆ·æ–°å¼‚å¸¸: " + e.getMessage());
        }
    }

    /**
     * ğŸ†• å­¦æ ¡APIé›†æˆçŠ¶æ€æ£€æŸ¥
     * GET /mock-school-api/auth/school-integration-status
     */
    @GetMapping("/school-integration-status")
    public MockApiResponse<Map<String, Object>> getSchoolIntegrationStatus() {
        log.info("ğŸ“Š [INTEGRATION_STATUS] æ£€æŸ¥å­¦æ ¡APIé›†æˆçŠ¶æ€");
        
        try {
            Map<String, Object> status = new HashMap<>();
            status.put("timestamp", System.currentTimeMillis());
            
            // è¿™é‡Œåº”è¯¥æ£€æŸ¥SchoolApiClientçš„æœåŠ¡çŠ¶æ€
            // ç®€åŒ–å®ç°
            status.put("schoolApiAvailable", true);
            status.put("mockMode", true);
            status.put("realApiEndpoint", "https://work.greathiit.com/api/user/loginWai");
            status.put("supportedFeatures", List.of("authentication", "token_refresh", "user_mapping"));
            
            return MockApiResponse.success(status, "å­¦æ ¡APIé›†æˆçŠ¶æ€æ£€æŸ¥å®Œæˆ");
            
        } catch (Exception e) {
            log.error("âŒ [INTEGRATION_STATUS] é›†æˆçŠ¶æ€æ£€æŸ¥å¼‚å¸¸", e);
            return MockApiResponse.serverError("é›†æˆçŠ¶æ€æ£€æŸ¥å¼‚å¸¸: " + e.getMessage());
        }
    }

    /**
     * å¥åº·æ£€æŸ¥æ¥å£
     * GET /mock-school-api/auth/health
     */
    @GetMapping("/health")
    public MockApiResponse<String> health() {
        return MockApiResponse.success("OK", "Mock School APIè®¤è¯æœåŠ¡æ­£å¸¸è¿è¡Œ");
    }
}
```

---

