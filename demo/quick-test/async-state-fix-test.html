<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”„ å¼‚æ­¥çŠ¶æ€åˆå§‹åŒ–ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        .fix-section {
            background: linear-gradient(135deg, #d1ecf1, #bee5eb);
            border: 1px solid #b6d4da;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .fix-section h3 {
            margin: 0 0 15px 0;
            color: #0c5460;
        }
        
        .fix-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 12px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 6px;
        }
        
        .fix-item .icon {
            font-weight: bold;
            color: #28a745;
        }
        
        .fix-item .content {
            flex: 1;
        }
        
        .code-block {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            overflow-x: auto;
            margin: 10px 0;
        }
        
        .test-section {
            margin-bottom: 25px;
            padding: 20px;
            border: 2px solid #e3e3e3;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #1e7e34;
            transform: translateY(-1px);
        }
        
        .log-area {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .status-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f1b2b7;
        }
        
        .iframe-container {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            height: 500px;
            margin-top: 20px;
        }
        
        .iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”„ å¼‚æ­¥çŠ¶æ€åˆå§‹åŒ–ä¿®å¤æµ‹è¯•</h1>
            <p>è§£å†³ç”¨æˆ·çŠ¶æ€åŠ è½½æ—¶åºé—®é¢˜ + ç¡®ä¿çŠ¶æ€æ­£ç¡®è¯»å–</p>
        </div>

        <!-- ä¿®å¤è¯¦æƒ… -->
        <div class="fix-section">
            <h3>ğŸ¯ å…³é”®é—®é¢˜å’Œä¿®å¤æ–¹æ¡ˆ</h3>
            
            <div class="fix-item">
                <span class="icon">âŒ</span>
                <div class="content">
                    <strong>é—®é¢˜è¯†åˆ«:</strong> Home.vueåœ¨onMountedä¸­ç«‹å³è¯»å–user storeçŠ¶æ€æ—¶ï¼ŒçŠ¶æ€è¿˜æœªå®Œå…¨æ›´æ–°
                    <div class="code-block">// é—®é¢˜æ—¥å¿—æ˜¾ç¤º
user.ts:85 æœ€ç»ˆç™»å½•çŠ¶æ€: true  â† storeå·²æ›´æ–°
Home.vue:625 ğŸ” æ£€æŸ¥ç™»å½•çŠ¶æ€: undefined  â† ä½†Home.vueè¯»å–ä¸åˆ°</div>
                </div>
            </div>
            
            <div class="fix-item">
                <span class="icon">ğŸ”§</span>
                <div class="content">
                    <strong>è§£å†³æ–¹æ¡ˆ 1:</strong> å°†initAuth()æ–¹æ³•æ”¹ä¸ºå¼‚æ­¥ï¼Œä½¿ç”¨awaitç­‰å¾…åˆå§‹åŒ–å®Œæˆ
                    <div class="code-block">// user.ts - ä¿®å¤å‰
const initAuth = () => {
  return initializeAuth()
}

// user.ts - ä¿®å¤å
const initAuth = async () => {
  return new Promise&lt;void&gt;((resolve) => {
    setTimeout(() => {
      initializeAuth()
      resolve()
    }, 0)
  })
}</div>
                </div>
            </div>
            
            <div class="fix-item">
                <span class="icon">âš¡</span>
                <div class="content">
                    <strong>è§£å†³æ–¹æ¡ˆ 2:</strong> åœ¨Home.vueä¸­ä½¿ç”¨å¼‚æ­¥onMounted + nextTickç¡®ä¿çŠ¶æ€åŒæ­¥
                    <div class="code-block">// Home.vue - ä¿®å¤å‰
onMounted(() => {
  userStore.initAuth()
  console.log('çŠ¶æ€:', userStore.isLoggedIn) // å¯èƒ½undefined
})

// Home.vue - ä¿®å¤å
onMounted(async () => {
  await userStore.initAuth()  // ç­‰å¾…åˆå§‹åŒ–å®Œæˆ
  await nextTick()           // ç­‰å¾…Vueå“åº”å¼æ›´æ–°å®Œæˆ
  console.log('çŠ¶æ€:', userStore.isLoggedIn.value) // æ­£ç¡®è¯»å–
})</div>
                </div>
            </div>
            
            <div class="fix-item">
                <span class="icon">âœ…</span>
                <div class="content">
                    <strong>é¢„æœŸæ•ˆæœ:</strong> ç°åœ¨ç”¨æˆ·ä¿¡æ¯åº”è¯¥æ­£ç¡®æ˜¾ç¤ºï¼Œä¸å†å‡ºç°undefinedçŠ¶æ€
                </div>
            </div>
        </div>

        <!-- æµ‹è¯•æ“ä½œ -->
        <div class="test-section">
            <h3>ğŸ§ª ä¿®å¤æ•ˆæœæµ‹è¯•</h3>
            <div style="margin-bottom: 15px;">
                <button class="btn btn-primary" onclick="simulateLogin()">
                    ğŸ” æ¨¡æ‹Ÿç™»å½•æµç¨‹
                </button>
                <button class="btn btn-success" onclick="checkPortalPage()">
                    ğŸ  æ£€æŸ¥é—¨æˆ·é¦–é¡µ
                </button>
                <button class="btn btn-primary" onclick="clearAndTest()">
                    ğŸ”„ æ¸…é™¤çŠ¶æ€é‡æ–°æµ‹è¯•
                </button>
                <span id="statusIndicator" class="status-indicator status-error">å¾…æµ‹è¯•</span>
            </div>
            <p style="color: #6c757d; font-size: 14px; margin: 0;">
                ğŸ’¡ æç¤ºï¼šå¦‚æœä¿®å¤æˆåŠŸï¼Œé—¨æˆ·é¦–é¡µåº”è¯¥èƒ½æ­£ç¡®æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯ï¼Œä¸å†å‡ºç°"è·³è½¬åˆ°ç™»å½•é¡µ"çš„æ—¥å¿—
            </p>
        </div>

        <!-- æµ‹è¯•æ—¥å¿— -->
        <div class="test-section">
            <h3>ğŸ“‹ æµ‹è¯•æ—¥å¿—</h3>
            <div class="log-area" id="logArea">[INFO] å¼‚æ­¥çŠ¶æ€åˆå§‹åŒ–ä¿®å¤æµ‹è¯•é¡µé¢å·²åŠ è½½
[INFO] å¼€å§‹éªŒè¯ä¿®å¤æ•ˆæœ...</div>
        </div>

        <!-- é—¨æˆ·é¦–é¡µé¢„è§ˆ -->
        <div class="test-section">
            <h3>ğŸ–¼ï¸ ä¿®å¤åçš„é—¨æˆ·é¦–é¡µé¢„è§ˆ</h3>
            <p>å¦‚æœä¿®å¤æˆåŠŸï¼Œä¸‹é¢åº”è¯¥æ˜¾ç¤ºå®Œæ•´çš„é—¨æˆ·é¦–é¡µï¼ŒåŒ…æ‹¬ç”¨æˆ·ä¿¡æ¯é¢æ¿</p>
            <div class="iframe-container">
                <iframe src="http://localhost:5173/home" id="portalPreview"></iframe>
            </div>
        </div>
    </div>

    <script>
        // æ—¥å¿—è®°å½•
        function addLog(message, type = 'INFO') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] [${type}] ${message}`;
            
            const logArea = document.getElementById('logArea');
            logArea.textContent += '\n' + logEntry;
            logArea.scrollTop = logArea.scrollHeight;
            
            console.log(logEntry);
        }

        // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
        function updateStatus(text, isSuccess = true) {
            const indicator = document.getElementById('statusIndicator');
            indicator.textContent = text;
            indicator.className = `status-indicator ${isSuccess ? 'status-success' : 'status-error'}`;
        }

        // æ¨¡æ‹Ÿç™»å½•æµç¨‹
        async function simulateLogin() {
            addLog('=== å¼€å§‹æ¨¡æ‹Ÿç™»å½•æµç¨‹ ===');
            updateStatus('æµ‹è¯•ä¸­...', false);
            
            try {
                const loginData = {
                    employeeId: 'PRINCIPAL_001',
                    name: 'Principal-Zhang',
                    password: 'admin123'
                };
                
                addLog('å‘é€ç™»å½•è¯·æ±‚...');
                const response = await fetch('http://localhost:48082/mock-school-api/auth/authenticate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=UTF-8'
                    },
                    body: JSON.stringify(loginData)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success) {
                        // ä¿å­˜è®¤è¯æ•°æ®
                        localStorage.setItem('campus_token', data.data.accessToken);
                        localStorage.setItem('campus_user_info', JSON.stringify(data.data));
                        
                        addLog(`âœ… ç™»å½•æˆåŠŸ: ${data.data.username}`, 'SUCCESS');
                        addLog(`Tokené•¿åº¦: ${data.data.accessToken.length} å­—ç¬¦`);
                        
                        updateStatus('ç™»å½•æˆåŠŸ', true);
                        
                        // å»¶è¿Ÿåˆ·æ–°iframeï¼Œæ¨¡æ‹ŸçœŸå®è·³è½¬
                        addLog('ç­‰å¾…2ç§’ååˆ·æ–°é—¨æˆ·é¦–é¡µé¢„è§ˆ...');
                        setTimeout(() => {
                            document.getElementById('portalPreview').src = 'http://localhost:5173/home?t=' + Date.now();
                            addLog('âœ… é—¨æˆ·é¦–é¡µé¢„è§ˆå·²åˆ·æ–°');
                        }, 2000);
                        
                    } else {
                        throw new Error(data.message || 'ç™»å½•å¤±è´¥');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                addLog(`âŒ ç™»å½•å¤±è´¥: ${error.message}`, 'ERROR');
                updateStatus('ç™»å½•å¤±è´¥', false);
            } finally {
                addLog('=== ç™»å½•æµç¨‹æµ‹è¯•å®Œæˆ ===');
            }
        }

        // æ£€æŸ¥é—¨æˆ·é¡µé¢çŠ¶æ€
        function checkPortalPage() {
            addLog('=== æ£€æŸ¥é—¨æˆ·é¡µé¢çŠ¶æ€ ===');
            
            const token = localStorage.getItem('campus_token');
            const userInfo = localStorage.getItem('campus_user_info');
            
            if (token && userInfo) {
                try {
                    const user = JSON.parse(userInfo);
                    addLog(`âœ… è®¤è¯çŠ¶æ€æ­£å¸¸: ${user.username} (${user.roleCode})`);
                    addLog(`TokençŠ¶æ€: å­˜åœ¨ï¼Œé•¿åº¦ ${token.length} å­—ç¬¦`);
                    
                    updateStatus('çŠ¶æ€æ­£å¸¸', true);
                    
                    // åˆ·æ–°iframe
                    document.getElementById('portalPreview').src = 'http://localhost:5173/home?check=' + Date.now();
                    addLog('ğŸ”„ é—¨æˆ·é¡µé¢å·²åˆ·æ–°');
                    
                } catch (error) {
                    addLog('âŒ ç”¨æˆ·ä¿¡æ¯è§£æå¤±è´¥', 'ERROR');
                    updateStatus('æ•°æ®å¼‚å¸¸', false);
                }
            } else {
                addLog('âŒ æœªæ‰¾åˆ°è®¤è¯æ•°æ®ï¼Œç”¨æˆ·æœªç™»å½•', 'WARNING');
                updateStatus('æœªç™»å½•', false);
            }
            
            addLog('=== é—¨æˆ·é¡µé¢çŠ¶æ€æ£€æŸ¥å®Œæˆ ===');
        }

        // æ¸…é™¤çŠ¶æ€é‡æ–°æµ‹è¯•
        function clearAndTest() {
            addLog('=== æ¸…é™¤çŠ¶æ€é‡æ–°æµ‹è¯• ===');
            
            // æ¸…é™¤æ‰€æœ‰è®¤è¯æ•°æ®
            localStorage.removeItem('campus_token');
            localStorage.removeItem('campus_user_info');
            addLog('âœ… è®¤è¯æ•°æ®å·²æ¸…é™¤');
            
            updateStatus('å·²æ¸…é™¤', false);
            
            // åˆ·æ–°iframeè§‚å¯Ÿæœªç™»å½•çŠ¶æ€
            document.getElementById('portalPreview').src = 'http://localhost:5173/home?clear=' + Date.now();
            addLog('ğŸ”„ é—¨æˆ·é¡µé¢å·²åˆ·æ–° - åº”è¯¥é‡å®šå‘åˆ°ç™»å½•é¡µ');
            
            addLog('=== çŠ¶æ€æ¸…é™¤å®Œæˆï¼Œå¯ä»¥é‡æ–°æµ‹è¯•ç™»å½• ===');
        }

        // é¡µé¢åˆå§‹åŒ–
        function initPage() {
            addLog('é¡µé¢åˆå§‹åŒ–å¼€å§‹...');
            
            // æ£€æŸ¥å½“å‰è®¤è¯çŠ¶æ€
            const token = localStorage.getItem('campus_token');
            const userInfo = localStorage.getItem('campus_user_info');
            
            if (token && userInfo) {
                try {
                    const user = JSON.parse(userInfo);
                    addLog(`å‘ç°å·²ä¿å­˜çš„è®¤è¯çŠ¶æ€: ${user.username}`);
                    updateStatus('å·²ç™»å½•', true);
                } catch (error) {
                    addLog('è®¤è¯æ•°æ®æ ¼å¼å¼‚å¸¸', 'ERROR');
                    updateStatus('æ•°æ®å¼‚å¸¸', false);
                }
            } else {
                addLog('æœªå‘ç°è®¤è¯æ•°æ®');
                updateStatus('æœªç™»å½•', false);
            }
            
            addLog('âœ… é¡µé¢åˆå§‹åŒ–å®Œæˆ');
            addLog('');
            addLog('ğŸ“ æµ‹è¯•è¯´æ˜:');
            addLog('1. ç‚¹å‡»"æ¨¡æ‹Ÿç™»å½•æµç¨‹"æµ‹è¯•å®Œæ•´ç™»å½•è¿‡ç¨‹');
            addLog('2. è§‚å¯Ÿiframeä¸­çš„é—¨æˆ·é¦–é¡µæ˜¯å¦æ­£ç¡®æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯');
            addLog('3. å¦‚æœä¿®å¤æˆåŠŸï¼Œåº”è¯¥ä¸å†çœ‹åˆ°"å‡†å¤‡è·³è½¬åˆ°ç™»å½•é¡µ"çš„æ—¥å¿—');
            addLog('4. å³ä¸Šè§’åº”è¯¥æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯å’Œé€€å‡ºæŒ‰é’®');
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>