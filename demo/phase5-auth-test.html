<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase5è®¤è¯åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .btn { padding: 10px 20px; margin: 10px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        #testLog { background: #f8f9fa; padding: 15px; border-radius: 5px; max-height: 400px; overflow-y: auto; font-family: monospace; }
        #authStatus { padding: 10px; border-radius: 5px; margin: 10px 0; }
        .form-control { width: 200px; padding: 8px; margin: 5px; }
    </style>
</head>
<body>
    <h1>ğŸ”§ Phase5ä¸€é”®è®¤è¯åŠŸèƒ½æµ‹è¯•</h1>
    
    <div>
        <h3>è®¤è¯æµ‹è¯•</h3>
        <label>è§’è‰²é€‰æ‹©:</label>
        <select id="roleSelect" class="form-control">
            <option value="PRINCIPAL">ğŸ© æ ¡é•¿ (å¯å®¡æ‰¹æ‰€æœ‰é€šçŸ¥)</option>
            <option value="ACADEMIC_ADMIN" selected>ğŸ‘” æ•™åŠ¡ä¸»ä»» (å¯æŸ¥çœ‹å®¡æ‰¹çŠ¶æ€)</option>
        </select>
        
        <div>
            <label>è®¤è¯çŠ¶æ€:</label>
            <div id="authStatus" style="background: #f8f9fa; color: #6c757d;">
                æœªè®¤è¯
            </div>
        </div>
        
        <button class="btn btn-primary" id="authenticateBtn" onclick="authenticateInPage()">
            ğŸš€ ä¸€é”®è®¤è¯
        </button>
        
        <button class="btn btn-primary" onclick="testMockAPI()">
            ğŸ” æµ‹è¯•Mock APIè¿æ¥
        </button>
    </div>
    
    <div>
        <h3>ğŸ“‹ æµ‹è¯•æ—¥å¿—</h3>
        <div id="testLog">
            <div style="color: #666;">ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        const API_BASE = 'http://localhost:48081';
        const MOCK_API_BASE = 'http://localhost:48082';
        let currentUser = null;
        let currentToken = null;

        // è§’è‰²å¯¹åº”çš„æµ‹è¯•è´¦å·
        const roleAccounts = {
            'PRINCIPAL': {
                employeeId: 'PRINCIPAL_001',
                name: 'Principal-Zhang',
                password: 'admin123',
                displayName: 'æ ¡é•¿å¼ æ˜'
            },
            'ACADEMIC_ADMIN': {
                employeeId: 'ACADEMIC_ADMIN_001', 
                name: 'Director-Li',
                password: 'admin123',
                displayName: 'æ•™åŠ¡ä¸»ä»»æå'
            }
        };

        // æ·»åŠ æ—¥å¿—è®°å½•å‡½æ•° - ä¿®å¤åçš„ç‰ˆæœ¬
        function addLog(message, type = 'info') {
            try {
                const logElement = document.getElementById('testLog');
                
                // æ£€æŸ¥æ—¥å¿—å®¹å™¨æ˜¯å¦å­˜åœ¨
                if (!logElement) {
                    console.warn('æ—¥å¿—å®¹å™¨ä¸å­˜åœ¨ï¼Œä½¿ç”¨ console è¾“å‡º:', message);
                    console.log(`[${type.toUpperCase()}] ${message}`);
                    return;
                }
                
                const timestamp = new Date().toLocaleTimeString();
                const icons = {
                    'info': 'â„¹ï¸',
                    'success': 'âœ…', 
                    'error': 'âŒ',
                    'warning': 'âš ï¸'
                };
                
                const colors = {
                    'info': '#17a2b8',
                    'success': '#28a745',
                    'error': '#dc3545', 
                    'warning': '#ffc107'
                };
                
                const logEntry = document.createElement('div');
                logEntry.style.marginBottom = '8px';
                logEntry.style.color = colors[type] || colors.info;
                logEntry.innerHTML = `[${timestamp}] ${icons[type] || icons.info} ${message}`;
                
                logElement.appendChild(logEntry);
                logElement.scrollTop = logElement.scrollHeight;
                
                // åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œæ–¹ä¾¿è°ƒè¯•
                console.log(`[${type.toUpperCase()}] ${message}`);
                
                // å¦‚æœæ˜¯é”™è¯¯ç±»å‹ï¼ŒåŒæ—¶è¾“å‡ºåˆ° console.error
                if (type === 'error') {
                    console.error(`Phase5 Error: ${message}`);
                }
                
            } catch (logError) {
                // æ—¥å¿—å‡½æ•°æœ¬èº«å‡ºé”™æ—¶ï¼Œåªèƒ½è¾“å‡ºåˆ°æ§åˆ¶å°
                console.error('æ—¥å¿—å‡½æ•°é”™è¯¯:', logError);
                console.log(`[${type.toUpperCase()}] ${message}`);
            }
        }

        // æµ‹è¯•Mock APIè¿æ¥
        async function testMockAPI() {
            addLog('ğŸ” å¼€å§‹æµ‹è¯•Mock APIè¿æ¥...', 'info');
            
            try {
                const response = await fetch(`${MOCK_API_BASE}/mock-school-api/auth/health`);
                if (response.ok) {
                    const result = await response.json();
                    addLog(`âœ… Mock APIè¿æ¥æˆåŠŸ: ${result.message}`, 'success');
                } else {
                    addLog(`âŒ Mock APIè¿æ¥å¤±è´¥: ${response.status}`, 'error');
                }
            } catch (error) {
                addLog(`âŒ Mock APIè¿æ¥å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // é¡µé¢å†…è®¤è¯å‡½æ•° - å®Œå…¨åŸºäºPhase5çš„å®ç°
        async function authenticateInPage() {
            const selectedRole = document.getElementById('roleSelect').value;
            const authBtn = document.getElementById('authenticateBtn');
            const authStatus = document.getElementById('authStatus');
            
            try {
                authBtn.disabled = true;
                authBtn.innerHTML = 'ğŸ”„ è®¤è¯ä¸­...';
                authStatus.innerHTML = 'æ­£åœ¨è®¤è¯...';
                authStatus.style.background = '#fff3cd';
                authStatus.style.color = '#856404';
                
                addLog('ğŸš€ å¼€å§‹å®¡æ‰¹æµç¨‹è®¤è¯', 'info');
                addLog(`ğŸ‘¤ é€‰æ‹©è§’è‰²: ${selectedRole}`, 'info');
                
                const account = roleAccounts[selectedRole];
                if (!account) {
                    throw new Error('æœªæ‰¾åˆ°å¯¹åº”è§’è‰²çš„æµ‹è¯•è´¦å·');
                }
                
                addLog(`ğŸ”‘ ä½¿ç”¨è´¦å·: ${account.displayName} (${account.employeeId})`, 'info');
                
                // è°ƒç”¨è®¤è¯API
                const authResponse = await fetch(`${MOCK_API_BASE}/mock-school-api/auth/authenticate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(account)
                });
                
                if (!authResponse.ok) {
                    throw new Error(`è®¤è¯è¯·æ±‚å¤±è´¥: ${authResponse.status}`);
                }
                
                const authResult = await authResponse.json();
                addLog(`âœ… è®¤è¯APIå“åº”æˆåŠŸ`, 'success');
                addLog(`ğŸ“¥ APIå“åº”è¯¦æƒ…: ${JSON.stringify(authResult, null, 2)}`, 'info');
                
                if (authResult.success && authResult.data) {
                    currentUser = authResult.data;
                    currentToken = authResult.data.accessToken;
                    
                    addLog(`ğŸ‰ è®¤è¯æˆåŠŸï¼ç”¨æˆ·: ${currentUser.realName || currentUser.username}`, 'success');
                    addLog(`ğŸ”‘ Token: ${currentToken.substring(0, 30)}...`, 'info');
                    
                    // æ›´æ–°è®¤è¯çŠ¶æ€
                    const displayName = currentUser.realName || currentUser.username || 'æœªçŸ¥ç”¨æˆ·';
                    const roleTitle = currentUser.roleCode === 'PRINCIPAL' ? 'æ ¡é•¿' : 'æ•™åŠ¡ä¸»ä»»';
                    
                    authStatus.innerHTML = `âœ… å·²è®¤è¯ï¼š${displayName} (${roleTitle})`;
                    authStatus.style.background = '#d4edda';
                    authStatus.style.color = '#155724';
                    
                    addLog('âœ… Phase5ä¸€é”®è®¤è¯åŠŸèƒ½ä¿®å¤æˆåŠŸï¼', 'success');
                    
                } else {
                    throw new Error(authResult.message || 'è®¤è¯å¤±è´¥');
                }
                
            } catch (error) {
                addLog(`âŒ è®¤è¯å¤±è´¥: ${error.message}`, 'error');
                authStatus.innerHTML = `âŒ è®¤è¯å¤±è´¥: ${error.message}`;
                authStatus.style.background = '#f8d7da';
                authStatus.style.color = '#721c24';
            } finally {
                authBtn.disabled = false;
                authBtn.innerHTML = 'ğŸš€ ä¸€é”®è®¤è¯';
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            addLog('ğŸ”§ Phase5è®¤è¯åŠŸèƒ½æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ', 'info');
            addLog('ğŸ’¡ è¯·å…ˆæµ‹è¯•Mock APIè¿æ¥ï¼Œç„¶åå°è¯•ä¸€é”®è®¤è¯', 'info');
        });
    </script>
</body>
</html>