<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 8: èŒƒå›´æŸ¥çœ‹é€šçŸ¥éªŒè¯é¡µé¢ - æ™ºèƒ½é€šçŸ¥ç³»ç»Ÿ</title>
    
    <!-- å®‰å…¨å¤´é…ç½® -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; 
        style-src 'self' 'unsafe-inline'; 
        img-src 'self' data: https:; 
        font-src 'self' https:; 
        connect-src 'self' http://localhost:48081 http://localhost:48082; 
        frame-src 'none'; 
        object-src 'none';
        base-uri 'self';
        form-action 'self';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        /* ğŸ¯ æƒé™çŸ©é˜µå±•ç¤ºåŒºåŸŸ - æ”¾åœ¨é¡µé¢ä¸Šæ–¹ */
        .permission-matrix {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .matrix-title {
            font-size: 1.4rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .matrix-subtitle {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }

        .matrix-subtitle h4 {
            color: #2980b9;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .matrix-subtitle p {
            color: #34495e;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        /* æŸ¥çœ‹æƒé™çŸ©é˜µè¡¨æ ¼ */
        .view-matrix-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 25px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .view-matrix-table th,
        .view-matrix-table td {
            padding: 12px 15px;
            text-align: center;
            border-bottom: 1px solid #ecf0f1;
        }

        .view-matrix-table th {
            background: #3498db;
            color: white;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .view-matrix-table td {
            font-size: 0.9rem;
        }

        .view-matrix-table tr:hover {
            background: #f8f9fa;
        }

        /* çº§åˆ«é¢œè‰²æ ‡è¯† */
        .level-1 { background: #ffebee; color: #c62828; }
        .level-2 { background: #fff3e0; color: #ef6c00; }
        .level-3 { background: #fff9c4; color: #f57f17; }
        .level-4 { background: #e8f5e8; color: #2e7d32; }

        /* æƒé™çŠ¶æ€æ ‡è¯† */
        .perm-all { background: #4caf50; color: white; padding: 4px 8px; border-radius: 4px; }
        .perm-scope { background: #ff9800; color: white; padding: 4px 8px; border-radius: 4px; }
        .perm-reason { color: #666; font-size: 0.85rem; }

        /* èŒƒå›´å¯è§æ€§çŸ©é˜µè¡¨æ ¼ */
        .scope-matrix-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .scope-matrix-table th,
        .scope-matrix-table td {
            padding: 12px 15px;
            text-align: center;
            border-bottom: 1px solid #ecf0f1;
        }

        .scope-matrix-table th {
            background: #9b59b6;
            color: white;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .scope-matrix-table tr:hover {
            background: #f8f9fa;
        }

        /* é˜¶æ®µå¯¼èˆª */
        .phase-navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .phase-nav-item {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            padding: 8px 15px;
            border-radius: 25px;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .phase-nav-item:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .phase-nav-item.current {
            background: #ffc107;
            color: #333;
            font-weight: bold;
        }

        /* è®¤è¯åŒºåŸŸ */
        .auth-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .auth-controls {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }

        .role-selector {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            transition: border-color 0.3s ease;
        }

        .role-selector:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: none;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #38a169;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .auth-status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.95rem;
        }

        .status-pending {
            background: #fff7cd;
            border: 1px solid #fbbf24;
            color: #92400e;
        }

        .status-success {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }

        .status-error {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }

        /* é€šçŸ¥æŸ¥çœ‹æµ‹è¯•åŒºåŸŸ */
        .view-test-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .test-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .notification-list {
            background: white;
            border-radius: 10px;
            padding: 20px;
            min-height: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .notification-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #ddd;
            transition: all 0.3s ease;
        }

        .notification-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .notification-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
            gap: 15px;
        }

        .notification-title {
            font-weight: bold;
            font-size: 1.1rem;
            color: #2c3e50;
            flex: 1;
        }

        .notification-level {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .notification-scope {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            background: #e9ecef;
            color: #495057;
        }

        .notification-meta {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            font-size: 0.9rem;
            color: #666;
            margin-top: 10px;
        }

        .notification-content {
            margin: 10px 0;
            color: #555;
            line-height: 1.4;
        }

        /* æ—¥å¿—åŒºåŸŸ */
        .log-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .log-container {
            background: #1e1e1e;
            color: #fff;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-info { color: #61dafb; }
        .log-success { color: #98d982; }
        .log-warning { color: #fbbf24; }
        .log-error { color: #f87171; }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .header h1 { font-size: 2rem; }
            .auth-controls { grid-template-columns: 1fr; }
            .test-controls { flex-direction: column; }
            .notification-header { flex-direction: column; align-items: flex-start; }
            .notification-meta { grid-template-columns: 1fr; }
        }

        @media (max-width: 480px) {
            .header h1 { font-size: 1.8rem; }
            .phase-navigation { gap: 10px; }
            .phase-nav-item { padding: 6px 12px; font-size: 0.8rem; }
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="header">
            <h1>ğŸ“‹ Phase 8: èŒƒå›´æŸ¥çœ‹é€šçŸ¥éªŒè¯é¡µé¢</h1>
            <div class="subtitle">éªŒè¯é€šçŸ¥èŒƒå›´å¯è§æ€§å’ŒæŸ¥çœ‹æƒé™è¿‡æ»¤åŠŸèƒ½</div>
        </div>

        <!-- é˜¶æ®µå¯¼èˆª -->
        <div class="phase-navigation">
            <a href="phase5-notification-approval.html" class="phase-nav-item">Phase 5: å®¡æ‰¹å·¥ä½œæµ</a>
            <a href="phase6-notification-scope.html" class="phase-nav-item">Phase 6: æƒé™çŸ©é˜µ</a>
            <a href="phase7-scope-notification-publish.html" class="phase-nav-item">Phase 7: èŒƒå›´å‘å¸ƒ</a>
            <a href="phase8-scope-notification-view.html" class="phase-nav-item current">Phase 8: èŒƒå›´æŸ¥çœ‹</a>
        </div>

        <!-- ğŸ¯ æƒé™çŸ©é˜µå±•ç¤ºåŒºåŸŸ - æ”¾åœ¨é¡µé¢ä¸Šæ–¹ -->
        <div class="permission-matrix">
            <div class="matrix-title">
                ğŸ‘ï¸ æŸ¥çœ‹æƒé™çŸ©é˜µ (View Permissions Matrix)
            </div>
            
            <div class="matrix-subtitle">
                <h4>ğŸš¨ æ ¸å¿ƒä¿®å¤åŸåˆ™</h4>
                <p>ç´§æ€¥é€šçŸ¥å’Œé‡è¦æ•™åŠ¡é€šçŸ¥ï¼Œæ‰€æœ‰ç›¸å…³äººå‘˜(åŒ…æ‹¬å­¦ç”Ÿ)éƒ½å¿…é¡»çœ‹åˆ°ï¼ä¹‹å‰è®¾è®¡é”™è¯¯åœ°è®©"å­¦ç”Ÿåªèƒ½çœ‹Level 4é€šçŸ¥"å®Œå…¨ä¸åˆç†ã€‚</p>
            </div>

            <!-- æŸ¥çœ‹æƒé™çŸ©é˜µè¡¨æ ¼ -->
            <table class="view-matrix-table">
                <thead>
                    <tr>
                        <th>é€šçŸ¥çº§åˆ«</th>
                        <th>æ ¡é•¿</th>
                        <th>æ•™åŠ¡ä¸»ä»»</th>
                        <th>æ•™å¸ˆ</th>
                        <th>ç­ä¸»ä»»</th>
                        <th>å­¦ç”Ÿ</th>
                        <th>è®¾è®¡ç†ç”±</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="level-1">
                        <td><strong>Level 1 (ç´§æ€¥)</strong></td>
                        <td><span class="perm-all">âœ…å…¨éƒ¨</span></td>
                        <td><span class="perm-all">âœ…å…¨éƒ¨</span></td>
                        <td><span class="perm-all">âœ…å…¨éƒ¨</span></td>
                        <td><span class="perm-all">âœ…å…¨éƒ¨</span></td>
                        <td><span class="perm-all">âœ…å…¨éƒ¨</span></td>
                        <td class="perm-reason">ğŸš¨æ ¡å›­å®‰å…¨è­¦æŠ¥å­¦ç”Ÿå¿…é¡»çŸ¥é“</td>
                    </tr>
                    <tr class="level-2">
                        <td><strong>Level 2 (é‡è¦)</strong></td>
                        <td><span class="perm-all">âœ…å…¨éƒ¨</span></td>
                        <td><span class="perm-all">âœ…å…¨éƒ¨</span></td>
                        <td><span class="perm-scope">âœ…ç›¸å…³èŒƒå›´</span></td>
                        <td><span class="perm-scope">âœ…ç›¸å…³èŒƒå›´</span></td>
                        <td><span class="perm-scope">âœ…ç›¸å…³èŒƒå›´</span></td>
                        <td class="perm-reason">ğŸ“šè€ƒè¯•å®‰æ’å­¦ç”Ÿå¿…é¡»çŸ¥é“</td>
                    </tr>
                    <tr class="level-3">
                        <td><strong>Level 3 (å¸¸è§„)</strong></td>
                        <td><span class="perm-all">âœ…å…¨éƒ¨</span></td>
                        <td><span class="perm-all">âœ…å…¨éƒ¨</span></td>
                        <td><span class="perm-scope">âœ…ç›¸å…³èŒƒå›´</span></td>
                        <td><span class="perm-scope">âœ…ç›¸å…³èŒƒå›´</span></td>
                        <td><span class="perm-scope">âœ…ç›¸å…³èŒƒå›´</span></td>
                        <td class="perm-reason">ğŸ“‹è¯¾ç¨‹è°ƒæ•´å­¦ç”Ÿå¿…é¡»çŸ¥é“</td>
                    </tr>
                    <tr class="level-4">
                        <td><strong>Level 4 (æé†’)</strong></td>
                        <td><span class="perm-all">âœ…å…¨éƒ¨</span></td>
                        <td><span class="perm-all">âœ…å…¨éƒ¨</span></td>
                        <td><span class="perm-all">âœ…å…¨éƒ¨</span></td>
                        <td><span class="perm-all">âœ…å…¨éƒ¨</span></td>
                        <td><span class="perm-all">âœ…å…¨éƒ¨</span></td>
                        <td class="perm-reason">ğŸ’¡æ¸©é¦¨æç¤ºå¤§å®¶éƒ½èƒ½çœ‹</td>
                    </tr>
                </tbody>
            </table>

            <!-- èŒƒå›´å¯è§æ€§çŸ©é˜µè¡¨æ ¼ -->
            <div class="matrix-subtitle">
                <h4>ğŸŒ èŒƒå›´å¯è§æ€§çŸ©é˜µ (Scope Visibility Matrix)</h4>
                <p>ä»€ä¹ˆèŒƒå›´çš„é€šçŸ¥è°å¯ä»¥çœ‹åˆ° - å­¦ç”Ÿå¿…é¡»èƒ½çœ‹åˆ°æ‰€æœ‰ä¸è‡ªå·±ç›¸å…³èŒƒå›´çš„é€šçŸ¥ï¼</p>
            </div>

            <table class="scope-matrix-table">
                <thead>
                    <tr>
                        <th>é€šçŸ¥èŒƒå›´</th>
                        <th>æ ¡é•¿</th>
                        <th>æ•™åŠ¡ä¸»ä»»</th>
                        <th>æ•™å¸ˆ</th>
                        <th>ç­ä¸»ä»»</th>
                        <th>å­¦ç”Ÿ</th>
                        <th>å¯è§æ€§é€»è¾‘</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>ğŸ« SCHOOL_WIDE</strong></td>
                        <td><span class="perm-all">âœ…å…¨éƒ¨</span></td>
                        <td><span class="perm-all">âœ…å…¨éƒ¨</span></td>
                        <td><span class="perm-all">âœ…å…¨éƒ¨</span></td>
                        <td><span class="perm-all">âœ…å…¨éƒ¨</span></td>
                        <td><span class="perm-all">âœ…å…¨éƒ¨</span></td>
                        <td class="perm-reason">å…¨æ ¡é€šçŸ¥æ‰€æœ‰äººéƒ½èƒ½çœ‹</td>
                    </tr>
                    <tr>
                        <td><strong>ğŸ¢ DEPARTMENT</strong></td>
                        <td><span class="perm-all">âœ…å…¨éƒ¨</span></td>
                        <td><span class="perm-all">âœ…å…¨éƒ¨</span></td>
                        <td><span class="perm-scope">âœ…æ‰€åœ¨éƒ¨é—¨</span></td>
                        <td><span class="perm-scope">âœ…ç›¸å…³éƒ¨é—¨</span></td>
                        <td><span class="perm-scope">âœ…æ‰€åœ¨éƒ¨é—¨</span></td>
                        <td class="perm-reason">éƒ¨é—¨å­¦ç”Ÿèƒ½çœ‹éƒ¨é—¨é€šçŸ¥</td>
                    </tr>
                    <tr>
                        <td><strong>ğŸ“š GRADE</strong></td>
                        <td><span class="perm-all">âœ…å…¨éƒ¨</span></td>
                        <td><span class="perm-all">âœ…å…¨éƒ¨</span></td>
                        <td><span class="perm-scope">âœ…æ•™æˆå¹´çº§</span></td>
                        <td><span class="perm-scope">âœ…è´Ÿè´£å¹´çº§</span></td>
                        <td><span class="perm-scope">âœ…æ‰€åœ¨å¹´çº§</span></td>
                        <td class="perm-reason">å¹´çº§å­¦ç”Ÿèƒ½çœ‹å¹´çº§é€šçŸ¥</td>
                    </tr>
                    <tr>
                        <td><strong>ğŸ‘¥ CLASS</strong></td>
                        <td><span class="perm-all">âœ…å…¨éƒ¨</span></td>
                        <td><span class="perm-all">âœ…å…¨éƒ¨</span></td>
                        <td><span class="perm-scope">âœ…ä»»è¯¾ç­çº§</span></td>
                        <td><span class="perm-scope">âœ…è´Ÿè´£ç­çº§</span></td>
                        <td><span class="perm-scope">âœ…æ‰€åœ¨ç­çº§</span></td>
                        <td class="perm-reason">ç­çº§å­¦ç”Ÿèƒ½çœ‹ç­çº§é€šçŸ¥</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- è®¤è¯åŒºåŸŸ -->
        <div class="auth-section">
            <div class="section-title">
                ğŸ” ç”¨æˆ·è®¤è¯æµ‹è¯•
            </div>
            <div class="auth-controls">
                <select id="roleSelector" class="role-selector">
                    <option value="PRINCIPAL_001">ğŸ« æ ¡é•¿ (Principal-Zhang)</option>
                    <option value="ACADEMIC_ADMIN_001">ğŸ“‹ æ•™åŠ¡ä¸»ä»» (Director-Li)</option>
                    <option value="TEACHER_001">ğŸ‘¨â€ğŸ« æ•™å¸ˆ (Teacher-Wang)</option>
                    <option value="CLASS_TEACHER_001">ğŸ‘©â€ğŸ« ç­ä¸»ä»» (ClassTeacher-Liu)</option>
                    <option value="STUDENT_001">ğŸ“ å­¦ç”Ÿ (Student-Zhang)</option>
                </select>
                <button id="authBtn" class="btn btn-primary">ç™»å½•è®¤è¯</button>
                <button id="viewNotificationsBtn" class="btn btn-success" disabled>æŸ¥çœ‹é€šçŸ¥åˆ—è¡¨</button>
            </div>
            <div id="authStatus" class="auth-status status-pending">
                è¯·é€‰æ‹©è§’è‰²å¹¶ç‚¹å‡»"ç™»å½•è®¤è¯"å¼€å§‹æµ‹è¯•
            </div>
        </div>

        <!-- é€šçŸ¥æŸ¥çœ‹æµ‹è¯•åŒºåŸŸ -->
        <div class="view-test-section">
            <div class="section-title">
                ğŸ“‹ é€šçŸ¥æŸ¥çœ‹æƒé™éªŒè¯
            </div>
            <div class="test-controls">
                <button id="refreshNotificationsBtn" class="btn btn-primary" disabled>
                    åˆ·æ–°é€šçŸ¥åˆ—è¡¨
                </button>
                <button id="clearNotificationsBtn" class="btn btn-secondary">
                    æ¸…ç©ºåˆ—è¡¨
                </button>
            </div>
            <div id="notificationList" class="notification-list">
                <div style="text-align: center; color: #666; padding: 50px;">
                    è¯·å…ˆå®Œæˆç”¨æˆ·è®¤è¯ï¼Œç„¶åç‚¹å‡»"æŸ¥çœ‹é€šçŸ¥åˆ—è¡¨"å¼€å§‹éªŒè¯
                </div>
            </div>
        </div>

        <!-- æ—¥å¿—åŒºåŸŸ -->
        <div class="log-section">
            <div class="section-title">
                ğŸ“Š ç³»ç»Ÿæ—¥å¿—
            </div>
            <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                <button onclick="saveLogsToFile()" class="btn btn-primary" style="font-size: 0.9rem; padding: 8px 16px;">
                    ğŸ“¥ ä¿å­˜æ—¥å¿—æ–‡ä»¶
                </button>
                <button onclick="clearLog()" class="btn btn-secondary" style="font-size: 0.9rem; padding: 8px 16px; background: #6c757d;">
                    ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—
                </button>
                <div style="flex: 1; text-align: right; color: #666; font-size: 0.9rem; align-self: center;">
                    å½“å‰æ—¥å¿—æ¡æ•°: <span id="logCount">0</span> | è‡ªåŠ¨ä¿å­˜: ä»…é”™è¯¯æ—¶
                </div>
            </div>
            <div id="logContainer" class="log-container">
Phase 8: èŒƒå›´æŸ¥çœ‹é€šçŸ¥éªŒè¯é¡µé¢å·²åŠ è½½ âœ…
ç­‰å¾…ç”¨æˆ·æ“ä½œ...

ğŸ¯ éªŒè¯é‡ç‚¹ï¼š
1. å„è§’è‰²èƒ½çœ‹åˆ°çš„é€šçŸ¥çº§åˆ«æ˜¯å¦ç¬¦åˆæ–°çš„æŸ¥çœ‹æƒé™çŸ©é˜µ
2. å­¦ç”Ÿæ˜¯å¦èƒ½çœ‹åˆ°Level 1ç´§æ€¥é€šçŸ¥å’ŒLevel 2é‡è¦æ•™åŠ¡é€šçŸ¥
3. èŒƒå›´è¿‡æ»¤æ˜¯å¦æŒ‰ç…§æ–°çš„å¯è§æ€§é€»è¾‘å·¥ä½œ
4. æƒé™è¿‡æ»¤çš„å‡†ç¡®æ€§éªŒè¯
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // ğŸŒ å…¨å±€çŠ¶æ€ç®¡ç†
        // ========================================
        
        let currentToken = null;
        let currentUser = null;
        let isOperationInProgress = false;
        
        // ğŸ“ æ—¥å¿—ç³»ç»Ÿ - æ–°å¢ä¿å­˜åŠŸèƒ½
        let systemLogs = [];
        let logFileHandle = null;
        let isSavingLog = false; // é˜²æ­¢ä¿å­˜æ—¥å¿—æ—¶çš„æ— é™å¾ªç¯

        // æµ‹è¯•è´¦å·æ˜ å°„
        const testAccounts = {
            'PRINCIPAL_001': { 
                employeeId: 'PRINCIPAL_001', 
                name: 'Principal-Zhang', 
                password: 'admin123',
                displayName: 'æ ¡é•¿å¼ æ˜',
                expectedRole: 'PRINCIPAL'
            },
            'ACADEMIC_ADMIN_001': { 
                employeeId: 'ACADEMIC_ADMIN_001', 
                name: 'Director-Li', 
                password: 'admin123',
                displayName: 'æ•™åŠ¡ä¸»ä»»æå',
                expectedRole: 'ACADEMIC_ADMIN'
            },
            'TEACHER_001': { 
                employeeId: 'TEACHER_001', 
                name: 'Teacher-Wang', 
                password: 'admin123',
                displayName: 'æ•™å¸ˆç‹è€å¸ˆ',
                expectedRole: 'TEACHER'
            },
            'CLASS_TEACHER_001': { 
                employeeId: 'CLASS_TEACHER_001', 
                name: 'ClassTeacher-Liu', 
                password: 'admin123',
                displayName: 'ç­ä¸»ä»»åˆ˜è€å¸ˆ',
                expectedRole: 'CLASS_TEACHER'
            },
            'STUDENT_001': { 
                employeeId: 'STUDENT_001', 
                name: 'Student-Zhang', 
                password: 'admin123',
                displayName: 'å­¦ç”Ÿå¼ ä¸‰',
                expectedRole: 'STUDENT'
            }
        };

        // ========================================
        // ğŸ”§ å·¥å…·å‡½æ•°
        // ========================================

        // å¢å¼ºçš„å¸¦è¶…æ—¶å’Œé‡è¯•çš„fetchå°è£…
        async function fetchWithRetry(url, options = {}, maxRetries = 2, timeout = 10000) {
            const controller = new AbortController();
            let timeoutId;
            
            for (let attempt = 0; attempt <= maxRetries; attempt++) {
                try {
                    timeoutId = setTimeout(() => controller.abort(), timeout);
                    
                    const response = await fetch(url, {
                        ...options,
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    return response;
                    
                } catch (error) {
                    clearTimeout(timeoutId);
                    
                    if (attempt === maxRetries) {
                        throw error;
                    }
                    
                    addLog(`âš ï¸ è¯·æ±‚å¤±è´¥ (å°è¯• ${attempt + 1}/${maxRetries + 1}): ${error.message}`, 'warning');
                    await new Promise(resolve => setTimeout(resolve, 1000 * (attempt + 1)));
                }
            }
        }
        
        // å®‰å…¨çš„JSONè§£æ
        async function safeJsonParse(response) {
            try {
                const text = await response.text();
                if (!text.trim()) {
                    throw new Error('æœåŠ¡å™¨è¿”å›ç©ºå“åº”');
                }
                return JSON.parse(text);
            } catch (error) {
                addLog(`ğŸš¨ JSONè§£æå¤±è´¥: ${error.message}`, 'error');
                throw error;
            }
        }

        // æ—¥å¿—è¾“å‡ºå‡½æ•° - å¢å¼ºç‰ˆæœ¬ï¼Œæ”¯æŒä¿å­˜åˆ°æ–‡ä»¶
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const fullMessage = `[${timestamp}] ${message}`;
            
            // æ·»åŠ åˆ°æ—¥å¿—æ•°ç»„
            systemLogs.push({
                timestamp: new Date().toISOString(),
                time: timestamp,
                type: type,
                message: message,
                fullMessage: fullMessage
            });
            
            // æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = fullMessage;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // æ›´æ–°æ—¥å¿—è®¡æ•°å™¨
            const logCount = document.getElementById('logCount');
            if (logCount) {
                logCount.textContent = systemLogs.length;
            }
            
            // ğŸ”§ ä¿®å¤ï¼šåªåœ¨é”™è¯¯æ—¶è‡ªåŠ¨ä¿å­˜ï¼Œé¿å…æ— é™å¾ªç¯
            // ç§»é™¤åŸæ¥çš„æ¯10æ¡æ—¥å¿—è‡ªåŠ¨ä¿å­˜ï¼Œæ”¹ä¸ºä»…é”™è¯¯æ—¶ä¿å­˜
            if (type === 'error' && !isSavingLog) {
                isSavingLog = true;
                saveLogsToFile();
                console.log('ğŸš¨ æ£€æµ‹åˆ°é”™è¯¯ï¼Œå·²è‡ªåŠ¨ä¿å­˜è°ƒè¯•æ—¥å¿—');
                isSavingLog = false;
            }
        }

        // ğŸ“ ä¿å­˜æ—¥å¿—åˆ°æ–‡ä»¶
        async function saveLogsToFile() {
            try {
                const logContent = generateLogContent();
                const blob = new Blob([logContent], { type: 'text/plain;charset=utf-8' });
                
                // ä½¿ç”¨ç°ä»£æµè§ˆå™¨çš„ä¸‹è½½API
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `phase8-debug-log-${new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-')}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log('ğŸ—‚ï¸ æ—¥å¿—æ–‡ä»¶å·²ä¿å­˜åˆ°ä¸‹è½½ç›®å½•');
            } catch (error) {
                console.error('âŒ ä¿å­˜æ—¥å¿—æ–‡ä»¶å¤±è´¥:', error);
            }
        }

        // ğŸ“‹ ç”Ÿæˆæ—¥å¿—æ–‡ä»¶å†…å®¹
        function generateLogContent() {
            const header = `# Phase 8: èŒƒå›´æŸ¥çœ‹é€šçŸ¥éªŒè¯é¡µé¢ - è°ƒè¯•æ—¥å¿—
## ç”Ÿæˆæ—¶é—´: ${new Date().toISOString()}
## ç”¨æˆ·ä»£ç†: ${navigator.userAgent}
## é¡µé¢URL: ${window.location.href}
## æ€»æ—¥å¿—æ¡æ•°: ${systemLogs.length}

===========================================

`;
            
            const logLines = systemLogs.map(log => {
                return `[${log.timestamp}] [${log.type.toUpperCase()}] ${log.message}`;
            }).join('\n');
            
            const footer = `

===========================================
## ç³»ç»Ÿä¿¡æ¯
- æµè§ˆå™¨: ${navigator.userAgent}
- å±å¹•åˆ†è¾¨ç‡: ${screen.width}x${screen.height}
- å½“å‰æ—¶é—´: ${new Date().toISOString()}
- æ—¥å¿—çº§åˆ«ç»Ÿè®¡: ${getLogTypeStats()}

## å½“å‰çŠ¶æ€
- è®¤è¯çŠ¶æ€: ${currentToken ? 'å·²è®¤è¯' : 'æœªè®¤è¯'}
- å½“å‰ç”¨æˆ·: ${currentUser ? JSON.stringify(currentUser, null, 2) : 'æœªè®¾ç½®'}
- æ“ä½œè¿›è¡Œä¸­: ${isOperationInProgress}
`;
            
            return header + logLines + footer;
        }

        // ğŸ“Š è·å–æ—¥å¿—ç±»å‹ç»Ÿè®¡
        function getLogTypeStats() {
            const stats = {};
            systemLogs.forEach(log => {
                stats[log.type] = (stats[log.type] || 0) + 1;
            });
            return JSON.stringify(stats);
        }

        // æ¸…ç©ºæ—¥å¿— - å¢å¼ºç‰ˆæœ¬
        function clearLog() {
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = '';
            systemLogs = []; // æ¸…ç©ºæ—¥å¿—æ•°ç»„
            addLog('Phase 8: èŒƒå›´æŸ¥çœ‹é€šçŸ¥éªŒè¯é¡µé¢ - æ—¥å¿—å·²æ¸…ç©º', 'info');
        }

        // ========================================
        // ğŸ” è®¤è¯ç›¸å…³å‡½æ•°
        // ========================================
        
        async function authenticateUser() {
            const roleSelector = document.getElementById('roleSelector');
            const authBtn = document.getElementById('authBtn');
            const authStatus = document.getElementById('authStatus');
            
            const selectedRole = roleSelector.value;
            const account = testAccounts[selectedRole];
            
            if (!account) {
                addLog('âŒ æœªæ‰¾åˆ°å¯¹åº”çš„æµ‹è¯•è´¦å·', 'error');
                return;
            }

            if (isOperationInProgress) {
                addLog('âš ï¸ æ“ä½œæ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç­‰å¾…...', 'warning');
                return;
            }

            isOperationInProgress = true;
            authBtn.disabled = true;
            authStatus.className = 'auth-status status-pending';
            authStatus.innerHTML = '<div class="loading"></div> æ­£åœ¨è¿›è¡Œç”¨æˆ·è®¤è¯...';

            addLog(`ğŸ” å¼€å§‹ç”¨æˆ·è®¤è¯ - ${account.displayName} (${account.expectedRole})`, 'info');

            try {
                // Step 1: Mock School APIè®¤è¯
                addLog(`ğŸ” ç¬¬ä¸€æ­¥ï¼šMock School APIè®¤è¯ - ${account.employeeId}`, 'info');
                
                const authResponse = await fetchWithRetry('http://localhost:48082/mock-school-api/auth/authenticate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        employeeId: account.employeeId,
                        name: account.name,
                        password: account.password
                    })
                });

                if (!authResponse.ok) {
                    throw new Error(`è®¤è¯å¤±è´¥: ${authResponse.status} ${authResponse.statusText}`);
                }

                const authData = await safeJsonParse(authResponse);
                addLog(`âœ… Mock School APIè®¤è¯æˆåŠŸ`, 'success');

                if (!authData.success || !authData.data) {
                    throw new Error(authData.message || 'Mock School APIè®¤è¯å¤±è´¥');
                }

                // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„tokenå­—æ®µå
                const tokenField = authData.data.accessToken || authData.data.token;
                if (!tokenField) {
                    addLog(`âš ï¸ è®¤è¯å“åº”å®Œæ•´æ•°æ®: ${JSON.stringify(authData, null, 2)}`, 'warning');
                    addLog(`âš ï¸ å¯ç”¨å­—æ®µ: ${Object.keys(authData.data || {}).join(', ')}`, 'warning');
                    throw new Error('è®¤è¯æˆåŠŸä½†æœªè·å–åˆ°è®¿é—®ä»¤ç‰Œ (accessToken æˆ– token)');
                }

                currentToken = `Bearer ${tokenField}`;
                currentUser = authData.data;

                // Step 2: éªŒè¯ç”¨æˆ·ä¿¡æ¯
                addLog(`ğŸ” ç¬¬äºŒæ­¥ï¼šéªŒè¯ç”¨æˆ·ä¿¡æ¯ - Tokené•¿åº¦: ${currentToken.length}`, 'info');

                const userInfoResponse = await fetchWithRetry('http://localhost:48082/mock-school-api/auth/user-info', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': currentToken
                    },
                    body: JSON.stringify({})
                });

                if (!userInfoResponse.ok) {
                    throw new Error(`ç”¨æˆ·ä¿¡æ¯è·å–å¤±è´¥: ${userInfoResponse.status}`);
                }

                const userInfoData = await safeJsonParse(userInfoResponse);
                if (!userInfoData.success) {
                    throw new Error(`ç”¨æˆ·ä¿¡æ¯éªŒè¯å¤±è´¥: ${userInfoData.message}`);
                }

                addLog(`âœ… ç”¨æˆ·ä¿¡æ¯éªŒè¯æˆåŠŸ: ${userInfoData.data.username} (${userInfoData.data.roleCode})`, 'success');

                // æ›´æ–°UIçŠ¶æ€
                authStatus.className = 'auth-status status-success';
                authStatus.innerHTML = `
                    âœ… è®¤è¯æˆåŠŸ<br>
                    ç”¨æˆ·: ${userInfoData.data.username}<br>
                    è§’è‰²: ${userInfoData.data.roleCode} (${userInfoData.data.roleName})<br>
                    Token: ${currentToken.substring(0, 30)}...
                `;

                // å¯ç”¨é€šçŸ¥æŸ¥çœ‹æŒ‰é’®
                document.getElementById('viewNotificationsBtn').disabled = false;
                document.getElementById('refreshNotificationsBtn').disabled = false;
                
                addLog(`ğŸ¯ è®¤è¯æµç¨‹å®Œæˆï¼Œå¯ä»¥å¼€å§‹éªŒè¯é€šçŸ¥æŸ¥çœ‹æƒé™`, 'success');

            } catch (error) {
                addLog(`âŒ è®¤è¯å¤±è´¥: ${error.message}`, 'error');
                authStatus.className = 'auth-status status-error';
                authStatus.innerHTML = `âŒ è®¤è¯å¤±è´¥: ${error.message}`;
                currentToken = null;
                currentUser = null;
            } finally {
                isOperationInProgress = false;
                authBtn.disabled = false;
            }
        }

        // ========================================
        // ğŸ“‹ é€šçŸ¥æŸ¥çœ‹ç›¸å…³å‡½æ•°
        // ========================================

        async function viewNotifications() {
            if (!currentToken) {
                addLog('âŒ è¯·å…ˆå®Œæˆç”¨æˆ·è®¤è¯', 'error');
                return;
            }

            if (isOperationInProgress) {
                addLog('âš ï¸ æ“ä½œæ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç­‰å¾…...', 'warning');
                return;
            }

            isOperationInProgress = true;
            addLog('ğŸ“‹ å¼€å§‹è·å–é€šçŸ¥åˆ—è¡¨...', 'info');

            try {
                const response = await fetchWithRetry('http://localhost:48081/admin-api/test/notification/api/list', {
                    method: 'GET',
                    headers: {
                        'Authorization': currentToken,
                        'Content-Type': 'application/json',
                        'tenant-id': '1'
                    }
                });

                if (!response.ok) {
                    throw new Error(`è·å–é€šçŸ¥åˆ—è¡¨å¤±è´¥: ${response.status} ${response.statusText}`);
                }

                const data = await safeJsonParse(response);
                
                // ğŸ” å¢å¼ºè°ƒè¯•ï¼šæ˜¾ç¤ºå®Œæ•´APIå“åº”
                addLog(`ğŸ” é€šçŸ¥åˆ—è¡¨APIå“åº”çŠ¶æ€: ${JSON.stringify({
                    success: data.success,
                    code: data.code,
                    message: data.message,
                    dataExists: !!data.data,
                    totalNotifications: data.data ? data.data.total : 'N/A'
                })}`, 'info');
                
                // ğŸ”§ ä¿®å¤ï¼šåç«¯ä½¿ç”¨code: 0è¡¨ç¤ºæˆåŠŸï¼Œè€Œä¸æ˜¯success: true
                if (data.code !== 0 && !data.success) {
                    const errorMsg = data.message || data.msg || data.error || 'æœªçŸ¥é”™è¯¯';
                    addLog(`âš ï¸ APIé”™è¯¯å“åº”è¯¦æƒ…: ${JSON.stringify(data, null, 2)}`, 'warning');
                    throw new Error(`APIè¿”å›é”™è¯¯: ${errorMsg}`);
                }

                addLog(`âœ… é€šçŸ¥åˆ—è¡¨è·å–æˆåŠŸ: å…± ${data.data.total} æ¡é€šçŸ¥`, 'success');
                
                // æ˜¾ç¤ºé€šçŸ¥åˆ—è¡¨
                displayNotifications(data.data.notifications, data.data.queryUser);
                
                // åˆ†ææƒé™è¿‡æ»¤æ•ˆæœ
                analyzeViewPermissions(data.data.notifications, data.data.queryUser);

            } catch (error) {
                addLog(`âŒ è·å–é€šçŸ¥åˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('notificationList').innerHTML = `
                    <div style="text-align: center; color: #e74c3c; padding: 50px;">
                        âŒ è·å–é€šçŸ¥åˆ—è¡¨å¤±è´¥: ${error.message}
                    </div>
                `;
            } finally {
                isOperationInProgress = false;
            }
        }

        function displayNotifications(notifications, queryUser) {
            const listContainer = document.getElementById('notificationList');
            
            if (!notifications || notifications.length === 0) {
                listContainer.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 50px;">
                        ğŸ“­ å½“å‰æ²¡æœ‰å¯æŸ¥çœ‹çš„é€šçŸ¥<br>
                        <small>è¿™å¯èƒ½è¡¨æ˜æƒé™è¿‡æ»¤è¿‡äºä¸¥æ ¼</small>
                    </div>
                `;
                return;
            }

            // ğŸ¯ å‰ç«¯æƒé™è¿‡æ»¤ - åŸºäºæ–°çš„æŸ¥çœ‹æƒé™çŸ©é˜µ
            addLog(`ğŸ” å¼€å§‹å‰ç«¯æƒé™è¿‡æ»¤ - åŸå§‹é€šçŸ¥: ${notifications.length} æ¡`, 'info');
            const filteredNotifications = applyNewViewPermissions(notifications, queryUser.roleCode);
            addLog(`ğŸ” å‰ç«¯æƒé™è¿‡æ»¤å®Œæˆ - è¿‡æ»¤åé€šçŸ¥: ${filteredNotifications.length} æ¡`, 'success');

            let html = `
                <div style="background: #e8f4f8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="color: #2980b9; margin-bottom: 10px;">
                        ğŸ“Š æŸ¥çœ‹ç»“æœæ¦‚è§ˆ - ${queryUser.username} (${queryUser.roleCode})
                    </h4>
                    <p>åç«¯è¿”å› <strong>${notifications.length}</strong> æ¡é€šçŸ¥ï¼Œå‰ç«¯æƒé™è¿‡æ»¤åæ˜¾ç¤º <strong>${filteredNotifications.length}</strong> æ¡</p>
                    ${notifications.length !== filteredNotifications.length ? 
                        `<p style="color: #e67e22; margin-top: 8px;">ğŸ¯ å‰ç«¯è¿‡æ»¤ç”Ÿæ•ˆï¼šéšè—äº† ${notifications.length - filteredNotifications.length} æ¡ä¸ç¬¦åˆæ–°æƒé™çŸ©é˜µçš„é€šçŸ¥</p>` : 
                        `<p style="color: #27ae60; margin-top: 8px;">âœ… æ— éœ€è¿‡æ»¤ï¼šæ‰€æœ‰é€šçŸ¥éƒ½ç¬¦åˆæ–°æƒé™çŸ©é˜µ</p>`}
                </div>
            `;

            if (filteredNotifications.length === 0) {
                listContainer.innerHTML = html + `
                    <div style="text-align: center; color: #666; padding: 50px;">
                        ğŸ“­ æ ¹æ®æ–°çš„æŸ¥çœ‹æƒé™çŸ©é˜µï¼Œå½“å‰æ²¡æœ‰å¯æŸ¥çœ‹çš„é€šçŸ¥<br>
                        <small>è¿™è¡¨æ˜å‰ç«¯æƒé™è¿‡æ»¤æ­£åœ¨ç”Ÿæ•ˆ</small>
                    </div>
                `;
                return;
            }

            filteredNotifications.forEach(notification => {
                const levelColor = getLevelColor(notification.level);
                const scopeIcon = getScopeIcon(notification.targetScope);
                
                html += `
                    <div class="notification-item" style="border-left-color: ${levelColor};">
                        <div class="notification-header">
                            <div class="notification-title">${escapeHtml(notification.title)}</div>
                            <div style="display: flex; gap: 10px;">
                                <span class="notification-level" style="background: ${levelColor}; color: white;">
                                    Level ${notification.level}
                                </span>
                                <span class="notification-scope">
                                    ${scopeIcon} ${notification.targetScope || 'N/A'}
                                </span>
                            </div>
                        </div>
                        <div class="notification-content">
                            ${escapeHtml(notification.content || '')}
                        </div>
                        <div class="notification-meta">
                            <div><strong>å‘å¸ƒè€…:</strong> ${escapeHtml(notification.publisherName)} (${notification.publisherRole})</div>
                            <div><strong>çŠ¶æ€:</strong> ${getStatusText(notification.status)}</div>
                            <div><strong>åˆ›å»ºæ—¶é—´:</strong> ${formatDate(notification.createTime)}</div>
                        </div>
                    </div>
                `;
            });

            listContainer.innerHTML = html;
            addLog(`ğŸ“‹ é€šçŸ¥åˆ—è¡¨æ¸²æŸ“å®Œæˆ: ${filteredNotifications.length} æ¡`, 'success');
            
            // åˆ†ææƒé™è¿‡æ»¤æ•ˆæœ - ä½¿ç”¨è¿‡æ»¤åçš„é€šçŸ¥
            analyzeViewPermissions(filteredNotifications, queryUser, notifications.length);
        }

        // ========================================
        // ğŸ¯ æ ¸å¿ƒå‰ç«¯æƒé™è¿‡æ»¤å‡½æ•° - åŸºäºæ–°çš„æŸ¥çœ‹æƒé™çŸ©é˜µ
        // ========================================

        function applyNewViewPermissions(notifications, userRole) {
            addLog(`ğŸ¯ æ‰§è¡Œæ–°æŸ¥çœ‹æƒé™çŸ©é˜µè¿‡æ»¤ - ç”¨æˆ·è§’è‰²: ${userRole}`, 'info');
            
            const filteredNotifications = notifications.filter(notification => {
                return canUserViewNotification(userRole, notification.level, notification.targetScope);
            });
            
            const filteredCount = notifications.length - filteredNotifications.length;
            if (filteredCount > 0) {
                addLog(`ğŸ¯ å‰ç«¯è¿‡æ»¤ç»“æœ: éšè—äº† ${filteredCount} æ¡é€šçŸ¥`, 'warning');
            }
            
            return filteredNotifications;
        }

        function canUserViewNotification(userRole, notificationLevel, notificationScope) {
            // æ ¹æ®æ–°çš„æŸ¥çœ‹æƒé™çŸ©é˜µåˆ¤æ–­ç”¨æˆ·æ˜¯å¦èƒ½çœ‹åˆ°é€šçŸ¥
            const viewMatrix = getNewViewPermissionMatrix();
            const userPermissions = viewMatrix[userRole];
            
            if (!userPermissions) {
                addLog(`âš ï¸ æœªçŸ¥ç”¨æˆ·è§’è‰²: ${userRole}`, 'warning');
                return false;
            }

            // æ£€æŸ¥çº§åˆ«æƒé™
            const levelPermission = userPermissions.levels[notificationLevel];
            if (levelPermission === 'ALL') {
                return true; // å¯ä»¥çœ‹æ‰€æœ‰è¿™ä¸ªçº§åˆ«çš„é€šçŸ¥
            } else if (levelPermission === 'SCOPE') {
                // éœ€è¦æ£€æŸ¥èŒƒå›´æƒé™
                return canUserViewScope(userRole, notificationScope);
            } else if (levelPermission === 'NONE') {
                return false; // ä¸èƒ½çœ‹è¿™ä¸ªçº§åˆ«çš„é€šçŸ¥
            }
            
            return false;
        }

        function canUserViewScope(userRole, notificationScope) {
            // ç®€åŒ–çš„èŒƒå›´æƒé™æ£€æŸ¥ - å®é™…ç”Ÿäº§ç¯å¢ƒéœ€è¦æ›´å¤æ‚çš„é€»è¾‘
            const scopeMatrix = getNewScopePermissionMatrix();
            const userScopePermissions = scopeMatrix[userRole];
            
            if (!userScopePermissions || !notificationScope) {
                return true; // é»˜è®¤å…è®¸
            }
            
            const scopePermission = userScopePermissions[notificationScope];
            if (scopePermission === 'ALL') {
                return true;
            } else if (scopePermission === 'SCOPE') {
                // åœ¨å®é™…ç³»ç»Ÿä¸­ï¼Œè¿™é‡Œéœ€è¦æ£€æŸ¥ç”¨æˆ·çš„å…·ä½“éƒ¨é—¨ã€å¹´çº§ã€ç­çº§ä¿¡æ¯
                // ç°åœ¨æˆ‘ä»¬ç®€åŒ–ä¸ºå…è®¸ï¼Œè¡¨ç¤º"ç›¸å…³èŒƒå›´"
                return true;
            } else if (scopePermission === 'NONE') {
                return false;
            }
            
            return true; // é»˜è®¤å…è®¸
        }

        function getNewViewPermissionMatrix() {
            // ğŸ¯ æ–°çš„æŸ¥çœ‹æƒé™çŸ©é˜µ - åŸºäºä¿®å¤åçš„è®¾è®¡
            return {
                'PRINCIPAL': {
                    levels: { 1: 'ALL', 2: 'ALL', 3: 'ALL', 4: 'ALL' }
                },
                'ACADEMIC_ADMIN': {
                    levels: { 1: 'ALL', 2: 'ALL', 3: 'ALL', 4: 'ALL' }
                },
                'TEACHER': {
                    levels: { 1: 'ALL', 2: 'SCOPE', 3: 'SCOPE', 4: 'ALL' }
                },
                'CLASS_TEACHER': {
                    levels: { 1: 'ALL', 2: 'SCOPE', 3: 'SCOPE', 4: 'ALL' }
                },
                'STUDENT': {
                    // ğŸš¨ å…³é”®ä¿®å¤ï¼šå­¦ç”Ÿå¯ä»¥çœ‹Level 1ç´§æ€¥é€šçŸ¥å’Œç›¸å…³èŒƒå›´çš„Level 2-3é€šçŸ¥
                    levels: { 1: 'ALL', 2: 'SCOPE', 3: 'SCOPE', 4: 'ALL' }
                }
            };
        }

        function getNewScopePermissionMatrix() {
            // ğŸŒ æ–°çš„èŒƒå›´å¯è§æ€§çŸ©é˜µ
            return {
                'PRINCIPAL': {
                    'SCHOOL_WIDE': 'ALL', 'DEPARTMENT': 'ALL', 'GRADE': 'ALL', 'CLASS': 'ALL'
                },
                'ACADEMIC_ADMIN': {
                    'SCHOOL_WIDE': 'ALL', 'DEPARTMENT': 'ALL', 'GRADE': 'ALL', 'CLASS': 'ALL'
                },
                'TEACHER': {
                    'SCHOOL_WIDE': 'ALL', 'DEPARTMENT': 'SCOPE', 'GRADE': 'NONE', 'CLASS': 'SCOPE'
                },
                'CLASS_TEACHER': {
                    'SCHOOL_WIDE': 'ALL', 'DEPARTMENT': 'SCOPE', 'GRADE': 'SCOPE', 'CLASS': 'SCOPE'
                },
                'STUDENT': {
                    // ğŸš¨ å…³é”®ä¿®å¤ï¼šå­¦ç”Ÿå¯ä»¥çœ‹åˆ°ç›¸å…³èŒƒå›´çš„æ‰€æœ‰é€šçŸ¥
                    'SCHOOL_WIDE': 'ALL', 'DEPARTMENT': 'SCOPE', 'GRADE': 'SCOPE', 'CLASS': 'SCOPE'
                }
            };
        }

        // ========================================
        // ğŸ“Š æƒé™åˆ†æå‡½æ•° - æ›´æ–°ç‰ˆæœ¬
        // ========================================

        function analyzeViewPermissions(filteredNotifications, queryUser, originalCount) {
            addLog('ğŸ” å¼€å§‹åˆ†ææŸ¥çœ‹æƒé™è¿‡æ»¤æ•ˆæœ...', 'info');
            
            const levelStats = {};
            const scopeStats = {};
            const publisherStats = {};

            filteredNotifications.forEach(notification => {
                // ç»Ÿè®¡çº§åˆ«åˆ†å¸ƒ
                const level = notification.level;
                levelStats[level] = (levelStats[level] || 0) + 1;
                
                // ç»Ÿè®¡èŒƒå›´åˆ†å¸ƒ
                const scope = notification.targetScope || 'N/A';
                scopeStats[scope] = (scopeStats[scope] || 0) + 1;
                
                // ç»Ÿè®¡å‘å¸ƒè€…è§’è‰²åˆ†å¸ƒ
                const publisher = notification.publisherRole;
                publisherStats[publisher] = (publisherStats[publisher] || 0) + 1;
            });

            addLog(`ğŸ“Š å‰ç«¯è¿‡æ»¤ç»Ÿè®¡ - åŸå§‹: ${originalCount} æ¡ â†’ è¿‡æ»¤å: ${filteredNotifications.length} æ¡`, 'info');
            addLog(`ğŸ“Š æƒé™åˆ†æ - ç”¨æˆ·è§’è‰²: ${queryUser.roleCode}`, 'info');
            addLog(`ğŸ“Š çº§åˆ«åˆ†å¸ƒ: ${JSON.stringify(levelStats)}`, 'info');
            addLog(`ğŸ“Š èŒƒå›´åˆ†å¸ƒ: ${JSON.stringify(scopeStats)}`, 'info');
            addLog(`ğŸ“Š å‘å¸ƒè€…è§’è‰²åˆ†å¸ƒ: ${JSON.stringify(publisherStats)}`, 'info');

            // éªŒè¯æ˜¯å¦ç¬¦åˆæ–°çš„æŸ¥çœ‹æƒé™çŸ©é˜µ
            validateNewViewPermissions(queryUser.roleCode, levelStats, scopeStats, originalCount, filteredNotifications.length);
        }

        function validateNewViewPermissions(userRole, levelStats, scopeStats, originalCount, filteredCount) {
            addLog('ğŸ¯ éªŒè¯æ–°æŸ¥çœ‹æƒé™çŸ©é˜µæ˜¯å¦æ­£ç¡®åº”ç”¨...', 'info');
            
            const expectedPermissions = getNewViewPermissionMatrix()[userRole];
            if (!expectedPermissions) {
                addLog(`âŒ æœªçŸ¥ç”¨æˆ·è§’è‰²: ${userRole}`, 'error');
                return;
            }
            
            // å…³é”®éªŒè¯ï¼šå­¦ç”Ÿæ˜¯å¦èƒ½çœ‹åˆ°Level 1ç´§æ€¥é€šçŸ¥
            if (userRole === 'STUDENT') {
                const level1Count = levelStats[1] || 0;
                if (level1Count > 0) {
                    addLog(`âœ… å­¦ç”Ÿæƒé™ä¿®å¤éªŒè¯æˆåŠŸ: å¯ä»¥çœ‹åˆ° ${level1Count} æ¡Level 1ç´§æ€¥é€šçŸ¥`, 'success');
                } else {
                    addLog(`âš ï¸ å­¦ç”Ÿæƒé™éªŒè¯: å½“å‰æ²¡æœ‰Level 1é€šçŸ¥å¯éªŒè¯`, 'warning');
                }
                
                const level2Count = levelStats[2] || 0;
                if (level2Count > 0) {
                    addLog(`âœ… å­¦ç”Ÿæƒé™ä¿®å¤éªŒè¯æˆåŠŸ: å¯ä»¥çœ‹åˆ° ${level2Count} æ¡Level 2é‡è¦é€šçŸ¥`, 'success');
                } else {
                    addLog(`âš ï¸ å­¦ç”Ÿæƒé™éªŒè¯: å½“å‰æ²¡æœ‰Level 2é€šçŸ¥å¯éªŒè¯`, 'warning');
                }
            }
            
            // æ£€æŸ¥çº§åˆ«æƒé™åº”ç”¨æ˜¯å¦æ­£ç¡®
            for (let level = 1; level <= 4; level++) {
                const actualCount = levelStats[level] || 0;
                const expected = expectedPermissions.levels[level];
                
                if (expected === 'ALL') {
                    addLog(`ğŸ“‹ Level ${level} æƒé™æ£€æŸ¥: ${expected} æƒé™ï¼Œå®é™…æ˜¾ç¤º ${actualCount} æ¡`, 'info');
                } else if (expected === 'SCOPE') {
                    addLog(`ğŸ“‹ Level ${level} æƒé™æ£€æŸ¥: ${expected} æƒé™ (èŒƒå›´ç›¸å…³)ï¼Œå®é™…æ˜¾ç¤º ${actualCount} æ¡`, 'info');
                } else if (expected === 'NONE') {
                    if (actualCount === 0) {
                        addLog(`âœ… Level ${level} æƒé™æ£€æŸ¥: ${expected} æƒé™åº”ç”¨æ­£ç¡®ï¼Œå®é™…æ˜¾ç¤º 0 æ¡`, 'success');
                    } else {
                        addLog(`âŒ Level ${level} æƒé™æ£€æŸ¥: ${expected} æƒé™ä½†æ˜¾ç¤ºäº† ${actualCount} æ¡ï¼Œå¯èƒ½æœ‰é—®é¢˜`, 'error');
                    }
                }
            }
            
            // æ€»ä½“éªŒè¯
            if (originalCount !== filteredCount) {
                addLog(`ğŸ¯ å‰ç«¯æƒé™è¿‡æ»¤ç”Ÿæ•ˆ: éšè—äº† ${originalCount - filteredCount} æ¡é€šçŸ¥`, 'success');
            } else {
                addLog(`â„¹ï¸ å‰ç«¯æƒé™è¿‡æ»¤æ— å˜åŒ–: æ‰€æœ‰é€šçŸ¥éƒ½ç¬¦åˆæ–°æƒé™çŸ©é˜µè¦æ±‚`, 'info');
            }
        }

        // ========================================
        // ğŸ”§ è¾…åŠ©å‡½æ•°
        // ========================================

        function getLevelColor(level) {
            const colors = {
                1: '#c62828', // çº¢è‰² - ç´§æ€¥
                2: '#ef6c00', // æ©™è‰² - é‡è¦
                3: '#f57f17', // é»„è‰² - å¸¸è§„
                4: '#2e7d32'  // ç»¿è‰² - æé†’
            };
            return colors[level] || '#666';
        }

        function getScopeIcon(scope) {
            const icons = {
                'SCHOOL_WIDE': 'ğŸ«',
                'DEPARTMENT': 'ğŸ¢',
                'GRADE': 'ğŸ“š',
                'CLASS': 'ğŸ‘¥'
            };
            return icons[scope] || 'ğŸ“‹';
        }

        function getStatusText(status) {
            const statusMap = {
                0: 'è‰ç¨¿',
                1: 'å¾…å®¡æ‰¹',
                2: 'å·²å®¡æ‰¹',
                3: 'å·²å‘å¸ƒ',
                4: 'å·²å–æ¶ˆ',
                5: 'å·²è¿‡æœŸ',
                6: 'å·²å½’æ¡£'
            };
            return statusMap[status] || `çŠ¶æ€${status}`;
        }

        function formatDate(dateStr) {
            try {
                return new Date(dateStr).toLocaleString('zh-CN');
            } catch {
                return dateStr || 'N/A';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function clearNotifications() {
            document.getElementById('notificationList').innerHTML = `
                <div style="text-align: center; color: #666; padding: 50px;">
                    ğŸ“‹ é€šçŸ¥åˆ—è¡¨å·²æ¸…ç©º<br>
                    <small>ç‚¹å‡»"æŸ¥çœ‹é€šçŸ¥åˆ—è¡¨"é‡æ–°åŠ è½½</small>
                </div>
            `;
            addLog('ğŸ“‹ é€šçŸ¥åˆ—è¡¨å·²æ¸…ç©º', 'info');
        }

        // ========================================
        // ğŸ¯ äº‹ä»¶ç»‘å®šå’Œé¡µé¢åˆå§‹åŒ–
        // ========================================

        document.addEventListener('DOMContentLoaded', function() {
            // ç»‘å®šè®¤è¯æŒ‰é’®
            document.getElementById('authBtn').addEventListener('click', authenticateUser);
            
            // ç»‘å®šé€šçŸ¥æŸ¥çœ‹æŒ‰é’®
            document.getElementById('viewNotificationsBtn').addEventListener('click', viewNotifications);
            
            // ç»‘å®šåˆ·æ–°æŒ‰é’®
            document.getElementById('refreshNotificationsBtn').addEventListener('click', viewNotifications);
            
            // ç»‘å®šæ¸…ç©ºæŒ‰é’®
            document.getElementById('clearNotificationsBtn').addEventListener('click', clearNotifications);
            
            addLog('Phase 8: èŒƒå›´æŸ¥çœ‹é€šçŸ¥éªŒè¯é¡µé¢åˆå§‹åŒ–å®Œæˆ', 'success');
            addLog('ğŸ¯ é¡µé¢åŠŸèƒ½: éªŒè¯æ–°çš„æŸ¥çœ‹æƒé™çŸ©é˜µæ˜¯å¦ç”Ÿæ•ˆ (å‰ç«¯è¿‡æ»¤å®ç°)', 'info');
            addLog('ğŸ“‹ ç‰¹åˆ«å…³æ³¨: å­¦ç”Ÿæ˜¯å¦èƒ½çœ‹åˆ°Level 1ç´§æ€¥é€šçŸ¥å’ŒLevel 2é‡è¦é€šçŸ¥', 'info');
            addLog('ğŸ”§ å®ç°æ–¹å¼: å‰ç«¯JavaScriptæƒé™è¿‡æ»¤ï¼Œæ— éœ€ä¿®æ”¹åç«¯ä»£ç ', 'info');
        });
    </script>
</body>
</html>