<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ›¡ï¸ CSRFé˜²æŠ¤æ¼”ç¤ºé¡µé¢</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .security-badge {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 20px;
        }
        
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            background: #f8f9fa;
        }
        
        .test-section h2 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .test-button {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: all 0.3s;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .attack-button {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }
        
        .attack-button:hover {
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }
        
        .secure-button {
            background: linear-gradient(45deg, #27ae60, #229954);
        }
        
        .secure-button:hover {
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }
        
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .result.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        .status-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .status-protected {
            background: #d4edda;
            color: #155724;
        }
        
        .status-vulnerable {
            background: #f8d7da;
            color: #721c24;
        }
        
        .code-example {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ›¡ï¸ CSRFé˜²æŠ¤æ¼”ç¤ºé¡µé¢</h1>
            <div class="security-badge">CVE-HXCI-2025-010 ä¿®å¤éªŒè¯</div>
            <p>æ¼”ç¤ºè·¨ç«™è¯·æ±‚ä¼ªé€ (CSRF)æ”»å‡»ä¸é˜²æŠ¤æœºåˆ¶</p>
        </div>

        <!-- CSRF TokençŠ¶æ€ -->
        <div class="test-section">
            <h2>ğŸ” CSRF TokençŠ¶æ€</h2>
            <p>é¦–å…ˆè·å–æœ‰æ•ˆçš„CSRF Tokenï¼Œè¿™æ˜¯é˜²æŠ¤çš„åŸºç¡€</p>
            <button class="test-button secure-button" onclick="getCsrfToken()">è·å–CSRF Token</button>
            <button class="test-button" onclick="checkCsrfStatus()">æ£€æŸ¥CSRFçŠ¶æ€</button>
            <div id="csrf-status" class="result info" style="display: none;"></div>
        </div>

        <!-- åˆæ³•è¯·æ±‚æµ‹è¯• -->
        <div class="test-section">
            <h2>âœ… åˆæ³•è¯·æ±‚æµ‹è¯• <span id="legitimate-status" class="status-indicator status-protected">å—ä¿æŠ¤</span></h2>
            <p>å¸¦æœ‰æ­£ç¡®CSRF Tokençš„è¯·æ±‚åº”è¯¥èƒ½å¤ŸæˆåŠŸæ‰§è¡Œ</p>
            <button class="test-button secure-button" onclick="performLegitimateRequest()">æ‰§è¡Œåˆæ³•è¯·æ±‚</button>
            <div class="code-example">
fetch('/admin-api/test/notification/api/publish-database', {
    method: 'POST',
    headers: {
        'Authorization': 'Bearer ' + jwtToken,
        'tenant-id': '1',
        'X-CSRF-TOKEN': csrfToken,  // ğŸ” æ­£ç¡®çš„CSRF Token
        'Content-Type': 'application/json'
    },
    credentials: 'include',
    body: JSON.stringify({
        title: 'âœ… åˆæ³•è¯·æ±‚æµ‹è¯•',
        content: 'è¿™ä¸ªè¯·æ±‚æºå¸¦äº†æ­£ç¡®çš„CSRF Token',
        level: 4,
        targetScope: 'SCHOOL_WIDE'
    })
});
            </div>
            <div id="legitimate-result" class="result" style="display: none;"></div>
        </div>

        <!-- CSRFæ”»å‡»æ¨¡æ‹Ÿ -->
        <div class="test-section">
            <h2>ğŸš¨ CSRFæ”»å‡»æ¨¡æ‹Ÿ <span id="attack-status" class="status-indicator status-protected">å·²é˜²æŠ¤</span></h2>
            <p>æ¶æ„ç½‘ç«™å°è¯•åœ¨ç”¨æˆ·ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹æ‰§è¡Œæ“ä½œï¼ˆæ— CSRF Tokenï¼‰</p>
            <button class="test-button attack-button" onclick="performCsrfAttack()">æ¨¡æ‹ŸCSRFæ”»å‡»</button>
            <div class="code-example">
// ğŸš¨ æ¶æ„ç½‘ç«™çš„JavaScriptä»£ç 
fetch('/admin-api/test/notification/api/publish-database', {
    method: 'POST',
    headers: {
        'Authorization': 'Bearer ' + stolenJwtToken,
        'tenant-id': '1',
        'Content-Type': 'application/json'
        // âŒ ç¼ºå°‘CSRF Token - æ”»å‡»è€…æ— æ³•è·å–
    },
    body: JSON.stringify({
        title: 'ğŸš¨ æ¶æ„é€šçŸ¥',
        content: 'è¿™æ˜¯CSRFæ”»å‡»å°è¯•å‘å¸ƒçš„æ¶æ„å†…å®¹'
    })
});
            </div>
            <div id="attack-result" class="result" style="display: none;"></div>
        </div>

        <!-- ä¼ªé€ Tokenæ”»å‡» -->
        <div class="test-section">
            <h2>ğŸ­ ä¼ªé€ Tokenæ”»å‡» <span id="forge-status" class="status-indicator status-protected">å·²é˜²æŠ¤</span></h2>
            <p>æ”»å‡»è€…å°è¯•ä½¿ç”¨ä¼ªé€ çš„CSRF Tokenç»•è¿‡é˜²æŠ¤</p>
            <button class="test-button attack-button" onclick="performTokenForgeAttack()">å°è¯•ä¼ªé€ Tokenæ”»å‡»</button>
            <div class="code-example">
fetch('/admin-api/test/notification/api/publish-database', {
    method: 'POST',
    headers: {
        'Authorization': 'Bearer ' + jwtToken,
        'tenant-id': '1',
        'X-CSRF-TOKEN': 'fake-token-12345',  // ğŸ­ ä¼ªé€ çš„CSRF Token
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({
        title: 'ğŸ­ ä¼ªé€ Tokenæ”»å‡»',
        content: 'è¿™ä¸ªè¯·æ±‚ä½¿ç”¨äº†ä¼ªé€ çš„CSRF Token'
    })
});
            </div>
            <div id="forge-result" class="result" style="display: none;"></div>
        </div>

        <!-- GETè¯·æ±‚æµ‹è¯• -->
        <div class="test-section">
            <h2>ğŸ“– GETè¯·æ±‚æµ‹è¯• <span id="get-status" class="status-indicator status-protected">æ— éœ€éªŒè¯</span></h2>
            <p>GETè¯·æ±‚ï¼ˆè¯»æ“ä½œï¼‰ä¸éœ€è¦CSRF Tokenï¼Œä¿æŒRESTful APIçš„æ— çŠ¶æ€ç‰¹æ€§</p>
            <button class="test-button" onclick="performGetRequest()">æ‰§è¡ŒGETè¯·æ±‚</button>
            <div class="code-example">
fetch('/admin-api/test/notification/api/list', {
    method: 'GET',
    headers: {
        'Authorization': 'Bearer ' + jwtToken,
        'tenant-id': '1'
        // â„¹ï¸ GETè¯·æ±‚æ— éœ€CSRF Token
    }
});
            </div>
            <div id="get-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        // ğŸ”‘ å…¨å±€å˜é‡
        let jwtToken = '';
        let csrfToken = '';
        
        // ğŸ” è·å–JWT Tokenï¼ˆæ¨¡æ‹Ÿç”¨æˆ·ç™»å½•ï¼‰
        async function getJwtToken() {
            try {
                const response = await fetch('http://localhost:48082/mock-school-api/auth/authenticate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        employeeId: 'PRINCIPAL_001',
                        name: 'Principal-Zhang',
                        password: 'admin123'
                    })
                });
                
                const data = await response.json();
                if (data.token) {
                    jwtToken = data.token;
                    console.log('âœ… JWT Tokenè·å–æˆåŠŸ');
                    return true;
                } else {
                    throw new Error('JWT Tokenè·å–å¤±è´¥');
                }
            } catch (error) {
                console.error('âŒ JWT Tokenè·å–å¤±è´¥:', error);
                return false;
            }
        }
        
        // ğŸ›¡ï¸ è·å–CSRF Token
        async function getCsrfToken() {
            try {
                // ç¡®ä¿æœ‰JWT Token
                if (!jwtToken) {
                    const jwtSuccess = await getJwtToken();
                    if (!jwtSuccess) {
                        throw new Error('æ— æ³•è·å–JWT Token');
                    }
                }
                
                const response = await fetch('/csrf-token', {
                    credentials: 'include'
                });
                
                const data = await response.json();
                if (data.code === 0 && data.data.token) {
                    csrfToken = data.data.token;
                    showResult('csrf-status', `âœ… CSRF Tokenè·å–æˆåŠŸï¼
Tokené•¿åº¦: ${csrfToken.length}
Headeråç§°: ${data.data.headerName}
æœ‰æ•ˆæœŸ: ${data.data.expiresIn}ç§’
Cookieåç§°: ${data.data.cookieName}
è¯´æ˜: ${data.data.message}`, 'success');
                } else {
                    throw new Error('CSRF Tokenè·å–å¤±è´¥');
                }
            } catch (error) {
                showResult('csrf-status', `âŒ CSRF Tokenè·å–å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // ğŸ” æ£€æŸ¥CSRFçŠ¶æ€
        async function checkCsrfStatus() {
            try {
                const response = await fetch('/csrf-status', {
                    credentials: 'include'
                });
                
                const data = await response.json();
                if (data.code === 0) {
                    const status = data.data;
                    showResult('csrf-status', `ğŸ“Š CSRFçŠ¶æ€ä¿¡æ¯ï¼š
Tokenæœ‰æ•ˆ: ${status.isValid ? 'âœ… æ˜¯' : 'âŒ å¦'}
å­˜åœ¨Token: ${status.hasToken ? 'âœ… æ˜¯' : 'âŒ å¦'}  
è¯·æ±‚æºå¸¦Token: ${status.tokenPresent ? 'âœ… æ˜¯' : 'âŒ å¦'}
çŠ¶æ€æ¶ˆæ¯: ${status.message}
å»ºè®®æ“ä½œ: ${status.recommendation}`, 'info');
                } else {
                    throw new Error('CSRFçŠ¶æ€æŸ¥è¯¢å¤±è´¥');
                }
            } catch (error) {
                showResult('csrf-status', `âŒ CSRFçŠ¶æ€æŸ¥è¯¢å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // âœ… æ‰§è¡Œåˆæ³•è¯·æ±‚ï¼ˆå¸¦CSRF Tokenï¼‰
        async function performLegitimateRequest() {
            try {
                if (!csrfToken) {
                    throw new Error('è¯·å…ˆè·å–CSRF Token');
                }
                
                const response = await fetch('/admin-api/test/notification/api/publish-database', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`,
                        'tenant-id': '1',
                        'X-CSRF-TOKEN': csrfToken,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        title: 'âœ… CSRFé˜²æŠ¤æµ‹è¯• - åˆæ³•è¯·æ±‚',
                        content: 'è¿™æ˜¯å¸¦æœ‰æ­£ç¡®CSRF Tokençš„åˆæ³•è¯·æ±‚ï¼Œåº”è¯¥èƒ½å¤ŸæˆåŠŸæ‰§è¡Œ',
                        level: 4,
                        targetScope: 'SCHOOL_WIDE',
                        pushChannels: [1, 5]
                    })
                });
                
                const data = await response.json();
                if (response.ok && data.code === 0) {
                    showResult('legitimate-result', `âœ… åˆæ³•è¯·æ±‚æ‰§è¡ŒæˆåŠŸï¼
HTTPçŠ¶æ€ç : ${response.status}
å“åº”æ•°æ®: ${JSON.stringify(data, null, 2)}
è¯´æ˜: æºå¸¦æ­£ç¡®CSRF Tokençš„è¯·æ±‚è¢«æˆåŠŸå¤„ç†`, 'success');
                    updateStatus('legitimate-status', 'âœ… è¯·æ±‚æˆåŠŸ', 'status-protected');
                } else {
                    throw new Error(`è¯·æ±‚å¤±è´¥: ${response.status} ${data.message || ''}`);
                }
            } catch (error) {
                showResult('legitimate-result', `âŒ åˆæ³•è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                updateStatus('legitimate-status', 'âŒ è¯·æ±‚å¤±è´¥', 'status-vulnerable');
            }
        }
        
        // ğŸš¨ æ¨¡æ‹ŸCSRFæ”»å‡»ï¼ˆæ— CSRF Tokenï¼‰
        async function performCsrfAttack() {
            try {
                if (!jwtToken) {
                    await getJwtToken();
                }
                
                const response = await fetch('/admin-api/test/notification/api/publish-database', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`,
                        'tenant-id': '1',
                        'Content-Type': 'application/json'
                        // âŒ æ•…æ„ä¸åŒ…å«CSRF Token
                    },
                    body: JSON.stringify({
                        title: 'ğŸš¨ æ¶æ„é€šçŸ¥ - CSRFæ”»å‡»',
                        content: 'è¿™æ˜¯æ¨¡æ‹Ÿçš„CSRFæ”»å‡»è¯·æ±‚ï¼Œåº”è¯¥è¢«é˜²æŠ¤æœºåˆ¶é˜»æ­¢',
                        level: 1,
                        targetScope: 'SCHOOL_WIDE'
                    })
                });
                
                const data = await response.json();
                if (response.status === 403 && (data.type === 'CSRF_TOKEN_INVALID' || data.message.includes('CSRF'))) {
                    showResult('attack-result', `ğŸ›¡ï¸ CSRFæ”»å‡»è¢«æˆåŠŸé˜»æ­¢ï¼
HTTPçŠ¶æ€ç : ${response.status} (403 Forbidden)
é”™è¯¯ç±»å‹: ${data.type}
é”™è¯¯æ¶ˆæ¯: ${data.message}
è¯´æ˜: ç¼ºå°‘CSRF Tokençš„æ¶æ„è¯·æ±‚è¢«é˜²æŠ¤æœºåˆ¶æ­£ç¡®æ‹¦æˆª`, 'success');
                    updateStatus('attack-status', 'ğŸ›¡ï¸ æ”»å‡»è¢«é˜»æ­¢', 'status-protected');
                } else {
                    showResult('attack-result', `ğŸš¨ é˜²æŠ¤å¤±è´¥ï¼CSRFæ”»å‡»æˆåŠŸæ‰§è¡Œ
HTTPçŠ¶æ€ç : ${response.status}
å“åº”æ•°æ®: ${JSON.stringify(data, null, 2)}
âš ï¸ è¿™è¡¨æ˜CSRFé˜²æŠ¤æœºåˆ¶å¯èƒ½å­˜åœ¨é—®é¢˜`, 'error');
                    updateStatus('attack-status', 'ğŸš¨ é˜²æŠ¤å¤±è´¥', 'status-vulnerable');
                }
            } catch (error) {
                showResult('attack-result', `ğŸ›¡ï¸ CSRFæ”»å‡»è¢«ç½‘ç»œå±‚é˜»æ­¢: ${error.message}`, 'success');
                updateStatus('attack-status', 'ğŸ›¡ï¸ æ”»å‡»è¢«é˜»æ­¢', 'status-protected');
            }
        }
        
        // ğŸ­ å°è¯•ä¼ªé€ Tokenæ”»å‡»
        async function performTokenForgeAttack() {
            try {
                if (!jwtToken) {
                    await getJwtToken();
                }
                
                const response = await fetch('/admin-api/test/notification/api/publish-database', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`,
                        'tenant-id': '1',
                        'X-CSRF-TOKEN': 'fake-csrf-token-12345',  // ğŸ­ ä¼ªé€ çš„Token
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: 'ğŸ­ ä¼ªé€ Tokenæ”»å‡»æµ‹è¯•',
                        content: 'è¿™ä¸ªè¯·æ±‚ä½¿ç”¨äº†ä¼ªé€ çš„CSRF Tokenï¼Œåº”è¯¥è¢«æ‹’ç»',
                        level: 2,
                        targetScope: 'SCHOOL_WIDE'
                    })
                });
                
                const data = await response.json();
                if (response.status === 403 && (data.type === 'CSRF_TOKEN_INVALID' || data.message.includes('CSRF'))) {
                    showResult('forge-result', `ğŸ›¡ï¸ ä¼ªé€ Tokenæ”»å‡»è¢«æˆåŠŸé˜»æ­¢ï¼
HTTPçŠ¶æ€ç : ${response.status} (403 Forbidden)
é”™è¯¯ç±»å‹: ${data.type}
é”™è¯¯æ¶ˆæ¯: ${data.message}
è¯´æ˜: ä½¿ç”¨ä¼ªé€ CSRF Tokençš„æ”»å‡»è¯·æ±‚è¢«æ­£ç¡®æ‹¦æˆª`, 'success');
                    updateStatus('forge-status', 'ğŸ›¡ï¸ æ”»å‡»è¢«é˜»æ­¢', 'status-protected');
                } else {
                    showResult('forge-result', `ğŸš¨ é˜²æŠ¤å¤±è´¥ï¼ä¼ªé€ Tokenæ”»å‡»æˆåŠŸ
HTTPçŠ¶æ€ç : ${response.status}
å“åº”æ•°æ®: ${JSON.stringify(data, null, 2)}
âš ï¸ è¿™è¡¨æ˜CSRF TokenéªŒè¯å¯èƒ½å­˜åœ¨é—®é¢˜`, 'error');
                    updateStatus('forge-status', 'ğŸš¨ é˜²æŠ¤å¤±è´¥', 'status-vulnerable');
                }
            } catch (error) {
                showResult('forge-result', `ğŸ›¡ï¸ ä¼ªé€ Tokenæ”»å‡»è¢«é˜»æ­¢: ${error.message}`, 'success');
                updateStatus('forge-status', 'ğŸ›¡ï¸ æ”»å‡»è¢«é˜»æ­¢', 'status-protected');
            }
        }
        
        // ğŸ“– æ‰§è¡ŒGETè¯·æ±‚ï¼ˆæ— éœ€CSRF Tokenï¼‰
        async function performGetRequest() {
            try {
                if (!jwtToken) {
                    await getJwtToken();
                }
                
                const response = await fetch('/admin-api/test/notification/api/list', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`,
                        'tenant-id': '1'
                        // â„¹ï¸ GETè¯·æ±‚æ— éœ€CSRF Token
                    }
                });
                
                const data = await response.json();
                if (response.ok && data.code === 0) {
                    showResult('get-result', `âœ… GETè¯·æ±‚æ‰§è¡ŒæˆåŠŸï¼
HTTPçŠ¶æ€ç : ${response.status}
æ•°æ®æ¡æ•°: ${data.data.list.length}
è¯´æ˜: GETè¯·æ±‚ï¼ˆè¯»æ“ä½œï¼‰æ— éœ€CSRF TokenéªŒè¯ï¼Œç¬¦åˆRESTfulè®¾è®¡åŸåˆ™`, 'success');
                    updateStatus('get-status', 'âœ… è¯·æ±‚æˆåŠŸ', 'status-protected');
                } else {
                    throw new Error(`GETè¯·æ±‚å¤±è´¥: ${response.status}`);
                }
            } catch (error) {
                showResult('get-result', `âŒ GETè¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                updateStatus('get-status', 'âŒ è¯·æ±‚å¤±è´¥', 'status-vulnerable');
            }
        }
        
        // ğŸ“ æ˜¾ç¤ºç»“æœ
        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }
        
        // ğŸ”„ æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
        function updateStatus(elementId, text, className) {
            const element = document.getElementById(elementId);
            element.textContent = text;
            element.className = `status-indicator ${className}`;
        }
        
        // ğŸš€ é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è·å–JWT Token
        window.addEventListener('load', function() {
            console.log('ğŸ›¡ï¸ CSRFé˜²æŠ¤æ¼”ç¤ºé¡µé¢åŠ è½½å®Œæˆ');
        });
    </script>
</body>
</html>