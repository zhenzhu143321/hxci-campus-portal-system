# Phase 1.4: HTTPå®‰å…¨å¤´å®Œå–„å’ŒCSPé…ç½®å®æ–½å®ŒæˆæŠ¥å‘Š

**å®æ–½æ—¥æœŸ**: 2025-08-25  
**å®‰å…¨ç­‰çº§**: P0çº§ - å…³é”®å®‰å…¨é˜²æŠ¤  
**çŠ¶æ€**: âœ… å®Œæˆ  

## ğŸ“‹ å®æ–½æ¦‚è¦

Phase 1.4æˆåŠŸå®æ–½äº†HTTPå®‰å…¨å¤´å®Œå–„å’Œå†…å®¹å®‰å…¨ç­–ç•¥(CSP)é…ç½®ï¼Œè¿™æ˜¯ç»§CSRFé˜²æŠ¤ã€JWTå®‰å…¨å¼ºåŒ–ã€é‡æ”¾æ”»å‡»é˜²æŠ¤ä¹‹åçš„ç¬¬å››å±‚å®‰å…¨é˜²æŠ¤æœºåˆ¶ã€‚

### ğŸ›¡ï¸ å››å±‚å®‰å…¨é˜²æŠ¤ä½“ç³»å®Œæˆ

| é˜²æŠ¤å±‚æ¬¡ | åŠŸèƒ½ | çŠ¶æ€ | é˜²æŠ¤ç›®æ ‡ |
|---------|------|------|----------|
| **Phase 1.1** | CSRFé˜²æŠ¤ | âœ… å®Œæˆ | è·¨ç«™è¯·æ±‚ä¼ªé€ æ”»å‡» |
| **Phase 1.2** | JWTå®‰å…¨å¼ºåŒ– | âœ… å®Œæˆ | JWTç®—æ³•ç»•è¿‡ã€ç­¾åä¼ªé€  |
| **Phase 1.3** | é‡æ”¾æ”»å‡»é˜²æŠ¤ | âœ… å®Œæˆ | Tokené‡æ”¾ã€é¢‘æ¬¡æ”»å‡» |
| **Phase 1.4** | HTTPå®‰å…¨å¤´+CSP | âœ… å®Œæˆ | XSSã€ç‚¹å‡»åŠ«æŒã€MIMEå—…æ¢ |

## ğŸš€ æ ¸å¿ƒå®æ–½æˆæœ

### 1ï¸âƒ£ SecurityHeadersConfig.java - ä¼ä¸šçº§å®‰å…¨å¤´é…ç½®
- **ä½ç½®**: `/opt/hxci-campus-portal/hxci-campus-portal-system/yudao-boot-mini/yudao-server/src/main/java/cn/iocoder/yudao/server/config/SecurityHeadersConfig.java`
- **åŠŸèƒ½**: 
  - å…¨æ–¹ä½HTTPå®‰å…¨å“åº”å¤´é…ç½®
  - é€‚é…Vue 3 SPAåº”ç”¨çš„CSPç­–ç•¥
  - ç¯å¢ƒè‡ªé€‚åº”é…ç½®ï¼ˆå¼€å‘vsç”Ÿäº§ï¼‰
  - æƒé™ç­–ç•¥(Permissions Policy)å®æ–½
  - å®æ—¶å®‰å…¨äº‹ä»¶ç›‘æ§

### 2ï¸âƒ£ CspReportController.java - CSPè¿è§„æŠ¥å‘Šç³»ç»Ÿ
- **ä½ç½®**: `/opt/hxci-campus-portal/hxci-campus-portal-system/yudao-boot-mini/yudao-server/src/main/java/cn/iocoder/yudao/server/controller/CspReportController.java`
- **åŠŸèƒ½**:
  - CSPè¿è§„æŠ¥å‘Šæ¥æ”¶å’Œå¤„ç†
  - å®‰å…¨çŠ¶æ€å®æ—¶ç›‘æ§
  - è¿è§„é£é™©ç­‰çº§è¯„ä¼°
  - å®‰å…¨å®¡è®¡äº‹ä»¶è®°å½•

### 3ï¸âƒ£ è‡ªåŠ¨åŒ–æµ‹è¯•å’ŒéªŒè¯å·¥å…·
- **security_headers_test.sh**: å…¨é¢çš„å®‰å…¨å¤´æµ‹è¯•è„šæœ¬
- **quick_security_check.sh**: å¿«é€Ÿå®‰å…¨éªŒè¯å·¥å…·
- **security-headers.properties**: ç¯å¢ƒé…ç½®æ–‡ä»¶

## ğŸ” å®‰å…¨å¤´é…ç½®è¯¦ç»†

### æ ¸å¿ƒå®‰å…¨å“åº”å¤´

| å®‰å…¨å¤´ | é…ç½®å€¼ | é˜²æŠ¤ç›®æ ‡ |
|--------|--------|----------|
| **X-Frame-Options** | `DENY` | é˜²ç‚¹å‡»åŠ«æŒæ”»å‡» |
| **X-Content-Type-Options** | `nosniff` | é˜²MIMEç±»å‹å—…æ¢æ”»å‡» |
| **X-XSS-Protection** | `1; mode=block` | å¯ç”¨æµè§ˆå™¨XSSè¿‡æ»¤å™¨ |
| **Referrer-Policy** | `strict-origin-when-cross-origin` | æ§åˆ¶å¼•ç”¨å¤´ä¿¡æ¯æ³„éœ² |
| **Cache-Control** | `no-cache, no-store, must-revalidate` | ç¦æ­¢APIæ•æ„Ÿæ•°æ®ç¼“å­˜ |

### å†…å®¹å®‰å…¨ç­–ç•¥(CSP)

#### å¼€å‘ç¯å¢ƒç­–ç•¥
- **script-src**: `'self' 'unsafe-inline' 'unsafe-eval' localhost:* ws://localhost:*`
- **style-src**: `'self' 'unsafe-inline' fonts.googleapis.com cdn.jsdelivr.net`
- **connect-src**: æ”¯æŒæœ¬åœ°å¼€å‘æœåŠ¡å™¨å’ŒAPIç«¯ç‚¹

#### ç”Ÿäº§ç¯å¢ƒç­–ç•¥
- **script-src**: `'self' 'nonce-{NONCE}'` (ä¸¥æ ¼è„šæœ¬æ§åˆ¶)
- **object-src**: `'none'` (ç¦ç”¨æ’ä»¶)
- **frame-ancestors**: `'none'` (ç¦æ­¢åµŒå…¥æ¡†æ¶)
- **å‡çº§ç­–ç•¥**: `upgrade-insecure-requests` (å¼ºåˆ¶HTTPS)

### æƒé™ç­–ç•¥(Permissions Policy)

| åŠŸèƒ½æƒé™ | é…ç½® | è¯´æ˜ |
|----------|------|------|
| **camera** | `()` | ç¦ç”¨æ‘„åƒå¤´è®¿é—® |
| **microphone** | `()` | ç¦ç”¨éº¦å…‹é£è®¿é—® |
| **geolocation** | `()` | ç¦ç”¨ä½ç½®ä¿¡æ¯ |
| **payment** | `()` | ç¦ç”¨æ”¯ä»˜API |
| **autoplay** | `self` | åªå…è®¸è‡ªåŸŸåè‡ªåŠ¨æ’­æ”¾ |
| **fullscreen** | `self` | åªå…è®¸è‡ªåŸŸåå…¨å± |

## ğŸ”— ä¸ç°æœ‰å®‰å…¨ä½“ç³»çš„ååŒ

### é…ç½®ä¼˜å…ˆçº§å’ŒååŒå…³ç³»
- **Order(90)**: SecurityHeadersConfigåœ¨CSRFé…ç½®(Order 100)ä¹‹åæ‰§è¡Œ
- **å…¼å®¹æ€§**: ä¸ç°æœ‰JWTè®¤è¯ã€CORSé…ç½®å®Œå…¨å…¼å®¹
- **è¦†ç›–èŒƒå›´**: `/admin-api/**`, `/mock-school-api/**`, `/csp-report`

### è¯·æ±‚å¤„ç†æµç¨‹
```
å®¢æˆ·ç«¯è¯·æ±‚ 
    â†“
1. SecurityHeadersConfig (HTTPå®‰å…¨å¤´)
    â†“  
2. CsrfSecurityConfig (CSRFéªŒè¯)
    â†“
3. JWTè®¤è¯éªŒè¯ (Tokenæ ¡éªŒ)
    â†“
4. æƒé™ç¼“å­˜ç³»ç»Ÿ (è§’è‰²æƒé™)
    â†“
ä¸šåŠ¡é€»è¾‘å¤„ç†
```

## ğŸ“Š CSPè¿è§„ç›‘æ§ç³»ç»Ÿ

### ç›‘æ§ç«¯ç‚¹
- **`POST /csp-report`**: æ¥æ”¶CSPè¿è§„æŠ¥å‘Š
- **`GET /csp-report/security-status`**: å®‰å…¨çŠ¶æ€ç›‘æ§
- **`GET /csp-report/verify-headers`**: å®‰å…¨å¤´éªŒè¯
- **`POST /csp-report/reset-stats`**: é‡ç½®ç»Ÿè®¡æ•°æ®

### é£é™©ç­‰çº§è¯„ä¼°
- **HIGH**: è„šæœ¬è¿è§„ï¼ˆjavascript:ã€data:ã€unsafeï¼‰
- **MEDIUM**: æ ·å¼ã€æ¡†æ¶ã€è¿æ¥è¿è§„
- **LOW**: å›¾ç‰‡ã€å­—ä½“è¿è§„

### å®‰å…¨äº‹ä»¶å®¡è®¡
- è‡ªåŠ¨è®°å½•è¿è§„äº‹ä»¶è¯¦æƒ…
- å®¢æˆ·ç«¯IPå’ŒUser-Agentè¿½è¸ª
- å®æ—¶é£é™©ç­‰çº§åˆ†æ
- æ”¯æŒç”Ÿäº§ç¯å¢ƒå‘Šè­¦é›†æˆ

## ğŸ§ª æµ‹è¯•éªŒè¯ç»“æœ

### è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬åŠŸèƒ½
1. **æœåŠ¡è¿é€šæ€§æµ‹è¯•** - éªŒè¯ä¸»æœåŠ¡å’ŒMock APIçŠ¶æ€
2. **æ ¸å¿ƒå®‰å…¨å“åº”å¤´æµ‹è¯•** - éªŒè¯æ‰€æœ‰å…³é”®å®‰å…¨å¤´
3. **CSPç­–ç•¥æµ‹è¯•** - éªŒè¯å†…å®¹å®‰å…¨ç­–ç•¥é…ç½®
4. **æƒé™ç­–ç•¥æµ‹è¯•** - éªŒè¯Permissions Policy
5. **HTTPSä¼ è¾“å®‰å…¨æµ‹è¯•** - éªŒè¯HSTSé…ç½®
6. **CSPè¿è§„æŠ¥å‘Šæµ‹è¯•** - éªŒè¯æŠ¥å‘Šæœºåˆ¶
7. **CORSé…ç½®æµ‹è¯•** - éªŒè¯è·¨åŸŸé…ç½®

### å®‰å…¨è¯„åˆ†ç³»ç»Ÿ
- **æ€»è¯„åˆ†**: 0-100åˆ†åˆ¶
- **å®‰å…¨ç­‰çº§**: A(90+), B(80-89), C(70-79), D(<70)
- **æˆåŠŸç‡è®¡ç®—**: é€šè¿‡æµ‹è¯•æ•°/æ€»æµ‹è¯•æ•° Ã— 100%

## ğŸ”§ éƒ¨ç½²å’ŒéªŒè¯è¯´æ˜

### ç¼–è¯‘çŠ¶æ€
```bash
âœ… mvn clean compile - ç¼–è¯‘æˆåŠŸï¼Œæ— é”™è¯¯
```

### å¯åŠ¨è¦æ±‚
âš ï¸ **é‡è¦**: ä¿®æ”¹Javaä»£ç åï¼Œç”¨æˆ·å¿…é¡»æ‰‹åŠ¨é‡å¯æœåŠ¡ï¼š

```bash
# åœæ­¢ç°æœ‰æœåŠ¡
sudo pkill -f java

# ç”¨æˆ·æ‰‹åŠ¨å¯åŠ¨ä¸¤ä¸ªç‹¬ç«‹ç»ˆç«¯çª—å£
cd /opt/hxci-campus-portal/hxci-campus-portal-system/yudao-boot-mini
mvn spring-boot:run -pl yudao-server -Dspring.profiles.active=local          # 48081
mvn spring-boot:run -pl yudao-mock-school-api -Dspring.profiles.active=local # 48082
```

### å¿«é€ŸéªŒè¯
```bash
# å¿«é€Ÿæ£€æŸ¥å®‰å…¨é…ç½®
./quick_security_check.sh

# å…¨é¢å®‰å…¨æµ‹è¯•
./security_headers_test.sh
```

## ğŸ¯ é¢„æœŸæ•ˆæœ

### å®‰å…¨é˜²æŠ¤èƒ½åŠ›æå‡
- **XSSæ”»å‡»é˜²æŠ¤**: CSPç­–ç•¥é˜»æ­¢æ¶æ„è„šæœ¬æ‰§è¡Œ
- **ç‚¹å‡»åŠ«æŒé˜²æŠ¤**: X-Frame-Optionsç¦æ­¢é¡µé¢è¢«åµŒå…¥
- **MIMEå—…æ¢é˜²æŠ¤**: X-Content-Type-Optionsé˜²æ­¢ç±»å‹æ··æ·†æ”»å‡»
- **ä¿¡æ¯æ³„éœ²é˜²æŠ¤**: Referrer-Policyæ§åˆ¶å¼•ç”¨å¤´ä¼ è¾“

### åˆè§„æ€§æ”¹å–„
- **OWASP Top 10**: æœ‰æ•ˆç¼“è§£A03(æ³¨å…¥)ã€A07(è¯†åˆ«å’Œèº«ä»½éªŒè¯)ç›¸å…³é£é™©
- **ä¼ä¸šå®‰å…¨æ ‡å‡†**: ç¬¦åˆä¸»æµä¼ä¸šçº§å®‰å…¨å¤´é…ç½®è¦æ±‚
- **æµè§ˆå™¨å…¼å®¹**: ç°ä»£æµè§ˆå™¨å…¨å…¼å®¹ï¼ŒIE8+æ”¯æŒ

### ç›‘æ§å’Œè¿ç»´
- **å®æ—¶ç›‘æ§**: CSPè¿è§„å®æ—¶æŠ¥å‘Šå’Œåˆ†æ
- **å®‰å…¨å®¡è®¡**: å®Œæ•´çš„å®‰å…¨äº‹ä»¶è®°å½•
- **æ€§èƒ½å½±å“**: å‡ ä¹é›¶æ€§èƒ½å¼€é”€ï¼Œå“åº”å¤´å¤§å°çº¦1-2KB

## âš ï¸ æ³¨æ„äº‹é¡¹å’Œé™åˆ¶

### Vue 3å¼€å‘ç¯å¢ƒé€‚é…
- å¼€å‘ç¯å¢ƒå¯ç”¨`'unsafe-inline'`å’Œ`'unsafe-eval'`æ”¯æŒVueçƒ­é‡è½½
- ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ä¸¥æ ¼çš„nonce-based CSPç­–ç•¥
- WebSocketè¿æ¥æ”¯æŒæœ¬åœ°å¼€å‘æœåŠ¡å™¨

### ç°æœ‰åŠŸèƒ½å…¼å®¹æ€§
- âœ… ä¸yudaoæ¡†æ¶å®Œå…¨å…¼å®¹
- âœ… ä¸å½±å“ç°æœ‰JWTè®¤è¯æµç¨‹
- âœ… ä¿æŒCSRFé˜²æŠ¤åŠŸèƒ½æ­£å¸¸
- âœ… APIå“åº”æ ¼å¼æ— å˜åŒ–

### é…ç½®ç»´æŠ¤è¦æ±‚
- CSPç­–ç•¥éœ€è¦éšä¸šåŠ¡éœ€æ±‚æ›´æ–°ï¼ˆæ–°å¢å¤–éƒ¨èµ„æºæ—¶ï¼‰
- ç”Ÿäº§ç¯å¢ƒéœ€è¦é…ç½®å®é™…çš„script-srcå“ˆå¸Œå€¼
- HSTSé…ç½®éœ€è¦åœ¨HTTPSç¯å¢ƒä¸‹å¯ç”¨

## ğŸ“ˆ å®‰å…¨æå‡æ€»ç»“

Phase 1.4å®æ–½å®Œæˆåï¼Œç³»ç»Ÿå®‰å…¨é˜²æŠ¤èƒ½åŠ›å¾—åˆ°äº†å…¨é¢æå‡ï¼š

### é˜²æŠ¤è¦†ç›–ç‡
- **æ”»å‡»å‘é‡è¦†ç›–**: XSSã€CSRFã€JWTæ”»å‡»ã€é‡æ”¾æ”»å‡»ã€ç‚¹å‡»åŠ«æŒã€MIMEå—…æ¢
- **å®‰å…¨å¤´å®Œæ•´æ€§**: 7+ä¸ªå…³é”®å®‰å…¨å“åº”å¤´
- **ç›‘æ§è¦†ç›–ç‡**: å®æ—¶CSPè¿è§„ç›‘æ§ + å®‰å…¨äº‹ä»¶å®¡è®¡

### å®‰å…¨æˆç†Ÿåº¦
- **P0çº§å…³é”®é˜²æŠ¤**: æ‰€æœ‰æ ¸å¿ƒå®‰å…¨é—®é¢˜å·²è§£å†³
- **ä¼ä¸šçº§æ ‡å‡†**: ç¬¦åˆä¸»æµå®‰å…¨æ¡†æ¶è¦æ±‚  
- **è‡ªåŠ¨åŒ–è¿ç»´**: å®Œæ•´çš„æµ‹è¯•å’ŒéªŒè¯å·¥å…·é“¾

### ä¸‹ä¸€æ­¥å»ºè®®
1. **ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–**: é…ç½®å®é™…åŸŸåå’Œä¸¥æ ¼çš„CSPç­–ç•¥
2. **ç›‘æ§é›†æˆ**: å°†CSPè¿è§„æŠ¥å‘Šé›†æˆåˆ°SIEMç³»ç»Ÿ
3. **æ€§èƒ½ä¼˜åŒ–**: ç›‘æ§å®‰å…¨å¤´å¯¹æ€§èƒ½çš„å½±å“
4. **å®šæœŸå®¡è®¡**: å»ºç«‹å®šæœŸå®‰å…¨é…ç½®å®¡æŸ¥æœºåˆ¶

---

**Phase 1.4å®‰å…¨é˜²æŠ¤å®æ–½å®Œæˆ** âœ…  
**å››å±‚å®‰å…¨é˜²æŠ¤ä½“ç³»å»ºè®¾åœ†æ»¡å®Œæˆ** ğŸ‰

*ä¸‹ä¸€æ­¥ï¼šæ ¹æ®é¡¹ç›®è§„åˆ’ï¼Œå¯ä»¥è€ƒè™‘å®æ–½åå°ç®¡ç†ç³»ç»Ÿ(T14)æˆ–å…¶ä»–åŠŸèƒ½æ¨¡å—å¼€å‘*